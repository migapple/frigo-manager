<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Frigo Manager - Scanner</title>
    <script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2@1.8.4/dist/quagga.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            position: relative;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .settings-btn {
            position: absolute;
            top: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid white;
            color: white;
            font-size: 24px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .settings-btn:active {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(0.95);
        }
        
        .settings-menu {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        
        .settings-menu.active {
            display: flex;
        }
        
        .settings-content {
            background: white;
            padding: 30px;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .settings-section {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
        }
        
        .settings-section h4 {
            margin-top: 0;
            color: #333;
            font-size: 1.1em;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .stat-card .number {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }
        
        .stat-card .orange { color: #f59e0b; }
        .stat-card .red { color: #ef4444; }
        
        .stat-card .label {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }
        
        .actions {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            display: grid;
            gap: 15px;
        }
        
        .btn {
            width: 100%;
            padding: 20px;
            font-size: 1.2em;
            font-weight: bold;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            color: white;
            transition: transform 0.2s;
        }
        
        .btn:active {
            transform: scale(0.98);
        }
        
        .btn-scan {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }
        
        .btn-manual {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .scanner {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: black;
            z-index: 1000;
            display: none;
            flex-direction: column;
        }
        
        .scanner.active {
            display: flex;
        }
        
        #scanner-container {
            flex: 1;
            position: relative;
            overflow: hidden;
        }
        
        #scanner-container video,
        #scanner-container canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .scanner-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            max-width: 400px;
            height: 200px;
            border: 3px solid #38ef7d;
            border-radius: 10px;
            box-shadow: 0 0 0 9999px rgba(0,0,0,0.5);
            transition: all 0.3s ease;
        }
        
        .scanner-instructions {
            position: absolute;
            top: 20%;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            text-align: center;
            font-size: 1.2em;
            font-weight: bold;
            text-shadow: 0 2px 10px rgba(0,0,0,0.8);
            pointer-events: none;
        }
        
        .scanner-line {
            width: 100%;
            height: 3px;
            background: #38ef7d;
            box-shadow: 0 0 20px #38ef7d;
            animation: scan 2s linear infinite;
        }
        
        @keyframes scan {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(197px); }
        }
        
        .scanner-controls {
            background: rgba(0,0,0,0.8);
            padding: 20px;
            display: flex;
            gap: 10px;
        }
        
        .scanner-controls button {
            flex: 1;
            padding: 15px;
            font-size: 1.1em;
            font-weight: bold;
            border: none;
            border-radius: 10px;
            cursor: pointer;
        }
        
        .btn-close-scanner {
            background: #ef4444;
            color: white;
        }
        
        .btn-manual-entry {
            background: white;
            color: #333;
        }
        
        .loading {
            background: white;
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 20px;
            display: none;
        }
        
        .loading.active {
            display: block;
        }
        
        .spinner {
            font-size: 3em;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            100% { transform: rotate(360deg); }
        }
        
        .filters {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 20px;
            padding: 0;
        }
        
        .filter-btn {
            padding: 10px 4px;
            border: none;
            border-radius: 10px;
            background: white;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            font-size: 0.8em;
            text-align: center;
        }
        
        .filter-btn.active {
            background: #667eea;
            color: white;
        }
        
        .filters-emplacement {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 20px;
            padding: 0;
        }
        
        .filter-empl-btn {
            padding: 10px 8px;
            border: none;
            border-radius: 10px;
            background: white;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            font-size: 0.85em;
            text-align: center;
        }
        
        .filter-empl-btn.active {
            background: #f59e0b;
            color: white;
        }
        
        .items {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            display: none;
        }
        
        .items.active {
            display: grid;
        }
        
        .item-card {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border: 3px solid transparent;
        }
        
        .item-card.expired {
            border-color: #ef4444;
            background: #fee;
        }
        
        .item-card.soon {
            border-color: #f59e0b;
            background: #fffbeb;
        }
        
        .item-card.fresh {
            border-color: #10b981;
            background: #f0fdf4;
        }
        
        .item-image {
            width: 100%;
            height: 180px;
            object-fit: cover;
            background: #f0f0f0;
        }
        
        .item-content {
            padding: 15px;
        }
        
        .item-name {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .item-info {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
        }
        
        .empty {
            background: white;
            padding: 60px 20px;
            border-radius: 15px;
            text-align: center;
        }
        
        .empty .icon {
            font-size: 4em;
            margin-bottom: 15px;
        }
        
        .form {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            display: none;
        }
        
        .form.active {
            display: block;
        }
        
        .form h3 {
            color: #667eea;
            margin-bottom: 15px;
        }
        
        .form-group {
            margin: 15px 0;
        }
        
        .form-group label {
            display: block;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            font-size: 0.95em;
        }
        
        .form input,
        .form select {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            background: white;
            box-sizing: border-box;
            -webkit-appearance: none;
            appearance: none;
        }
        
        .form input:focus,
        .form select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .date-suggestion {
            font-size: 0.85em;
            color: #666;
            margin-top: 5px;
        }
        
        .preview-img {
            width: 100%;
            max-height: 200px;
            object-fit: contain;
            border-radius: 10px;
            margin: 10px 0;
            background: #f0f0f0;
        }
        
        .preview-placeholder {
            width: 100%;
            height: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f0f0f0;
            border: 2px dashed #ccc;
            border-radius: 10px;
            margin: 10px 0;
            font-size: 1.2em;
            color: #999;
        }
        
        .barcode-badge {
            display: inline-block;
            background: #e8f5e9;
            color: #2e7d32;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            margin: 10px 0;
        }
        
        .emplacement-badge {
            display: inline-block;
            background: #e3f2fd;
            color: #1565c0;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            margin: 5px 5px 5px 0;
        }
        
        .alert-banner {
            background: linear-gradient(135deg, #f59e0b 0%, #ef4444 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: none;
            animation: slideDown 0.3s ease;
        }
        
        .alert-banner.show {
            display: block;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .alert-banner-title {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        .alert-banner-text {
            font-size: 0.95em;
            margin-bottom: 12px;
        }
        
        .alert-banner-btn {
            background: white;
            color: #f59e0b;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.95em;
        }
        
        .notification-prompt {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            text-align: center;
            display: none;
            animation: slideDown 0.3s ease;
        }
        
        .notification-prompt.show {
            display: block;
        }
        
        .notification-prompt-title {
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }
        
        .notification-prompt-text {
            font-size: 0.95em;
            color: #666;
            margin-bottom: 15px;
        }
        
        .notification-prompt-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            font-size: 1em;
            margin: 5px;
        }
        
        .notification-prompt-btn-cancel {
            background: #e0e0e0;
            color: #666;
            padding: 12px 30px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            font-size: 1em;
            margin: 5px;
        }
        
        .btn-quantity {
            width: 40px;
            height: 40px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 8px;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn-quantity:active {
            background: #667eea;
            color: white;
        }
        
        .quantity-badge {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
            margin: 5px 5px 5px 0;
        }
        
        .renouveler-badge {
            display: inline-block;
            background: #f59e0b;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
            margin: 5px 5px 5px 0;
        }
        
        .quantity-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 15px 0;
            justify-content: center;
        }
        
        .quantity-controls button {
            width: 35px;
            height: 35px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .quantity-controls button:active {
            background: #667eea;
            color: white;
        }
        
        .quantity-controls .quantity-value {
            font-size: 1.3em;
            font-weight: bold;
            color: #667eea;
            min-width: 40px;
            text-align: center;
        }
        
        .stock-alert {
            background: #fee;
            border: 2px solid #ef4444;
            color: #ef4444;
            padding: 8px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9em;
            margin: 10px 0;
        }
    </style>
    <!-- Biblioth√®que SheetJS pour Excel -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üßä Frigo Manager</h1>
            <p>Scanner de code-barres intelligent</p>
            <button class="settings-btn" onclick="toggleSettings()">‚öôÔ∏è</button>
        </div>

        <div id="settingsMenu" class="settings-menu">
            <div class="settings-content">
                <h3 style="margin-top: 0; color: #667eea;">‚öôÔ∏è Param√®tres</h3>
                
                <div class="settings-section">
                    <h4>üíæ Sauvegarde</h4>
                    <button class="btn" onclick="exportData()" style="background: #10b981; margin-bottom: 10px;">üì§ Exporter JSON</button>
                    <button class="btn" onclick="exportExcel()" style="background: #059669; margin-bottom: 10px;">üìä Exporter Excel</button>
                    <button class="btn" onclick="document.getElementById('importFile').click()" style="background: #3b82f6; margin-bottom: 10px;">üì• Importer JSON</button>
                    <button class="btn" onclick="document.getElementById('importExcel').click()" style="background: #2563eb; margin-bottom: 10px;">üìä Importer Excel</button>
                    <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
                    <input type="file" id="importExcel" accept=".xlsx,.xls" style="display: none;" onchange="importExcel(event)">
                    <p style="font-size: 0.85em; color: #666; margin: 10px 0;">Sauvegardez vos donn√©es ou transf√©rez-les vers un autre appareil</p>
                </div>
                
                <div class="settings-section">
                    <h4>üóëÔ∏è Donn√©es</h4>
                    <button class="btn" onclick="confirmDeleteAll()" style="background: #ef4444;">Supprimer toutes les donn√©es</button>
                    <p style="font-size: 0.85em; color: #666; margin: 10px 0;">Attention : cette action est irr√©versible</p>
                </div>
                
                <button class="btn" onclick="toggleSettings()" style="background: #ccc; color: #333; margin-top: 20px;">‚úï Fermer</button>
            </div>
        </div>

        <div id="alertBanner" class="alert-banner"></div>
        
        <div id="notificationPrompt" class="notification-prompt" style="display: none;">
            <div class="notification-prompt-content">
                <div style="font-size: 2em; margin-bottom: 10px;">üîî</div>
                <div class="notification-prompt-title">Activer les notifications</div>
                <div class="notification-prompt-text">Recevez des alertes quand vos produits arrivent √† expiration</div>
                <button class="notification-prompt-btn" id="btnEnableNotifications">‚úì Activer</button>
                <button class="notification-prompt-btn-cancel" id="btnCancelNotifications">Plus tard</button>
            </div>
        </div>

        <div id="stats" class="stats">
            <div class="stat-card">
                <div class="number">0</div>
                <div class="label">Produits</div>
            </div>
            <div class="stat-card">
                <div class="number orange">0</div>
                <div class="label">Urgents</div>
            </div>
            <div class="stat-card">
                <div class="number red">0</div>
                <div class="label">P√©rim√©s</div>
            </div>
        </div>
        
        <div id="actions" class="actions">
            <button class="btn btn-scan" id="btnScan">üì∑ Scanner un code-barres</button>
            <button class="btn btn-manual" id="btnManual">‚úçÔ∏è Saisie manuelle</button>
        </div>

        <div id="scanner" class="scanner">
            <div class="scanner-instructions">
                üì∑ Centrez le code-barres
            </div>
            <div id="scanner-container"></div>
            <div class="scanner-overlay">
                <div class="scanner-line"></div>
            </div>
            <div class="scanner-controls">
                <button class="btn-close-scanner" id="btnCloseScanner">‚úï Fermer</button>
                <button class="btn-manual-entry" id="btnManualFromScanner">‚úçÔ∏è Saisie manuelle</button>
            </div>
        </div>

        <div id="loading" class="loading">
            <div class="spinner">üîç</div>
            <h2>Recherche du produit...</h2>
            <p id="loadingBarcode"></p>
        </div>

        <div id="form" class="form"></div>

        <div id="filters" class="filters">
            <button class="filter-btn active" data-f="all">üîµ Tous</button>
            <button class="filter-btn" data-f="fresh">‚úÖ Frais</button>
            <button class="filter-btn" data-f="soon">‚ö†Ô∏è Urgent</button>
            <button class="filter-btn" data-f="expired">‚ùå P√©rim√©s</button>
            <button class="filter-btn" data-f="out_of_stock">üì¶ √âpuis√©s</button>
            <button class="filter-btn" data-f="to_renew">üìù √Ä renouveler</button>
        </div>

        <div id="filtersEmplacement" class="filters-emplacement">
            <button class="filter-empl-btn active" data-empl="all">üìç Tous</button>
            <button class="filter-empl-btn" data-empl="frigo">üßä Frigo</button>
            <button class="filter-empl-btn" data-empl="congelateur">‚ùÑÔ∏è Cong√©lo</button>
            <button class="filter-empl-btn" data-empl="placard">üö™ Placard</button>
        </div>

        <div id="items" class="items"></div>

        <div id="empty" class="empty">
            <div class="icon">ü•ó</div>
            <h2>Aucun produit</h2>
            <p>Scannez un code-barres ou ajoutez manuellement</p>
        </div>
    </div>

    <script>
        var items = [];
        var currentFilter = 'all';
        var currentEmplacement = 'all';
        var currentBarcode = null;
        var currentProductData = null;
        var lastScannedCode = null;
        var scanConfidenceCount = {};
        var scanningActive = false;

        // Charger les donn√©es
        try {
            var stored = localStorage.getItem('frigo-items');
            if (stored) items = JSON.parse(stored);
        } catch (e) {}

        function saveItems() {
            try {
                localStorage.setItem('frigo-items', JSON.stringify(items));
            } catch (e) {}
        }

        function getDays(date) {
            if (!date) return null;
            var today = new Date();
            today.setHours(0, 0, 0, 0);
            var exp = new Date(date);
            exp.setHours(0, 0, 0, 0);
            return Math.ceil((exp - today) / (1000 * 60 * 60 * 24));
        }

        function getStatus(days) {
            if (days === null) return { cls: '', text: '‚ö†Ô∏è Date inconnue' };
            if (days < 0) return { cls: 'expired', text: '‚ùå P√©rim√© depuis ' + Math.abs(days) + 'j' };
            if (days === 0) return { cls: 'soon', text: '‚ö†Ô∏è Expire aujourd\'hui' };
            if (days === 1) return { cls: 'soon', text: '‚ö†Ô∏è Expire demain' };
            if (days <= 3) return { cls: 'soon', text: '‚ö†Ô∏è ' + days + ' jours restants' };
            return { cls: 'fresh', text: '‚úì ' + days + ' jours restants' };
        }

        function getEmplacementInfo(emplacement) {
            var emplacements = {
                'frigo': { emoji: 'üßä', text: 'Frigo' },
                'congelateur': { emoji: '‚ùÑÔ∏è', text: 'Cong√©lateur' },
                'placard': { emoji: 'üö™', text: 'Placard' },
                'cave': { emoji: 'üç∑', text: 'Cave' },
                'corbeille': { emoji: 'üß∫', text: 'Corbeille' },
                'autre_emplacement': { emoji: 'üìç', text: 'Autre' }
            };
            return emplacements[emplacement] || emplacements['frigo'];
        }
        
        // Helper pour g√©rer les quantit√©s (0 est valide, undefined/null devient 1)
        function getQuantity(qty) {
            return (qty !== undefined && qty !== null) ? qty : 1;
        }

        // === SYST√àME DE NOTIFICATIONS ===
        
        function requestNotificationPermission() {
            if (!("Notification" in window)) {
                console.log("Ce navigateur ne supporte pas les notifications");
                return Promise.resolve("denied");
            }
            
            if (Notification.permission === "granted") {
                return Promise.resolve("granted");
            }
            
            if (Notification.permission !== "denied") {
                return Notification.requestPermission();
            }
            
            return Promise.resolve(Notification.permission);
        }
        
        function sendNotification(title, body, urgentCount) {
            if (Notification.permission === "granted") {
                var notification = new Notification(title, {
                    body: body,
                    icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="75" font-size="75">üßä</text></svg>',
                    badge: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="75" font-size="75">‚ö†Ô∏è</text></svg>',
                    tag: 'frigo-alert',
                    requireInteraction: false,
                    vibrate: [200, 100, 200]
                });
                
                notification.onclick = function() {
                    window.focus();
                    // Activer le filtre "Urgent"
                    currentFilter = 'soon';
                    var filterBtns = document.querySelectorAll('.filter-btn');
                    for (var i = 0; i < filterBtns.length; i++) {
                        filterBtns[i].classList.remove('active');
                        if (filterBtns[i].getAttribute('data-f') === 'soon') {
                            filterBtns[i].classList.add('active');
                        }
                    }
                    renderItems();
                    notification.close();
                };
            }
        }
        
        function updateBadge(count) {
            if ('setAppBadge' in navigator) {
                if (count > 0) {
                    navigator.setAppBadge(count).catch(function(err) {
                        console.log('Erreur badge:', err);
                    });
                } else {
                    navigator.clearAppBadge().catch(function(err) {
                        console.log('Erreur badge:', err);
                    });
                }
            }
        }
        
        function checkUrgentProducts() {
            var today = 0;
            var tomorrow = 0;
            var twoDays = 0;
            var expired = 0;
            var outOfStock = 0;
            var lowStock = 0;
            var toRenew = 0;
            
            for (var i = 0; i < items.length; i++) {
                var days = getDays(items[i].datePeremption);
                var qty = getQuantity(items[i].quantite);
                
                // V√©rifier le stock
                if (qty === 0) {
                    outOfStock++;
                } else if (qty === 1) {
                    lowStock++;
                }
                
                // V√©rifier "√† renouveler"
                if (items[i].aRenouveler) {
                    toRenew++;
                }
                
                // V√©rifier les dates
                if (days !== null) {
                    if (days < 0) expired++;
                    else if (days === 0) today++;
                    else if (days === 1) tomorrow++;
                    else if (days === 2) twoDays++;
                }
            }
            
            var total = today + tomorrow + twoDays;
            
            // Mettre √† jour le badge (inclure les ruptures de stock ET √† renouveler)
            updateBadge(total + expired + outOfStock + toRenew);
            
            // Afficher la banni√®re si des produits urgents OU en rupture de stock OU √† renouveler
            if (total > 0 || expired > 0 || outOfStock > 0 || lowStock > 0 || toRenew > 0) {
                showAlertBanner(today, tomorrow, twoDays, expired, outOfStock, lowStock, toRenew);
                
                // Afficher le prompt de notification si pas encore r√©pondu
                var notificationAsked = localStorage.getItem('notification-asked');
                if (!notificationAsked && Notification.permission === 'default') {
                    setTimeout(function() {
                        document.getElementById('notificationPrompt').classList.add('show');
                    }, 1000);
                }
                
                // Envoyer une notification si d√©j√† autoris√©
                if (Notification.permission === 'granted') {
                    var notifTitle = '‚ö†Ô∏è Frigo Manager';
                    var notifBody = '';
                    
                    if (outOfStock > 0) {
                        notifBody += 'üì¶ ' + outOfStock + ' produit' + (outOfStock > 1 ? 's' : '') + ' √©puis√©' + (outOfStock > 1 ? 's' : '');
                    }
                    if (toRenew > 0) {
                        if (notifBody) notifBody += ' ¬∑ ';
                        notifBody += 'üìù ' + toRenew + ' √† renouveler';
                    }
                    if (lowStock > 0) {
                        if (notifBody) notifBody += ' ¬∑ ';
                        notifBody += '‚ö†Ô∏è ' + lowStock + ' produit' + (lowStock > 1 ? 's' : '') + ' bient√¥t √©puis√©' + (lowStock > 1 ? 's' : '');
                    }
                    if (expired > 0) {
                        if (notifBody) notifBody += ' ¬∑ ';
                        notifBody += expired + ' p√©rim√©' + (expired > 1 ? 's' : '');
                    }
                    if (today > 0) {
                        if (notifBody) notifBody += ' ¬∑ ';
                        notifBody += today + ' expire' + (today > 1 ? 'nt' : '') + ' aujourd\'hui';
                    }
                    if (tomorrow > 0) {
                        if (notifBody) notifBody += ' ¬∑ ';
                        notifBody += tomorrow + ' expire' + (tomorrow > 1 ? 'nt' : '') + ' demain';
                    }
                    
                    if (notifBody) {
                        sendNotification(notifTitle, notifBody, total);
                    }
                }
            } else {
                // Cacher la banni√®re s'il n'y a rien d'urgent
                document.getElementById('alertBanner').classList.remove('show');
            }
        }
        
        function showAlertBanner(today, tomorrow, twoDays, expired, outOfStock, lowStock, toRenew) {
            var banner = document.getElementById('alertBanner');
            var messages = [];
            
            // Alertes de stock en premier (le plus important)
            if (outOfStock > 0) {
                messages.push('üì¶ ' + outOfStock + ' produit' + (outOfStock > 1 ? 's' : '') + ' √âPUIS√â' + (outOfStock > 1 ? 'S' : ''));
            }
            if (toRenew > 0) {
                messages.push('üìù ' + toRenew + ' √† renouveler');
            }
            if (lowStock > 0) {
                messages.push('‚ö†Ô∏è ' + lowStock + ' produit' + (lowStock > 1 ? 's' : '') + ' bient√¥t √©puis√©' + (lowStock > 1 ? 's' : '') + ' (1 restant)');
            }
            
            // Alertes de date
            if (expired > 0) {
                messages.push('‚ùå ' + expired + ' produit' + (expired > 1 ? 's p√©rim√©' + (expired > 1 ? 's' : '') : ' p√©rim√©'));
            }
            if (today > 0) {
                messages.push('üî¥ ' + today + ' expire' + (today > 1 ? 'nt' : '') + ' AUJOURD\'HUI');
            }
            if (tomorrow > 0) {
                messages.push('üü† ' + tomorrow + ' expire' + (tomorrow > 1 ? 'nt' : '') + ' demain');
            }
            if (twoDays > 0) {
                messages.push('üü° ' + twoDays + ' dans 2 jours');
            }
            
            var html = '<div class="alert-banner-title">‚ö†Ô∏è ATTENTION : Action requise !</div>' +
                       '<div class="alert-banner-text">' + messages.join(' ‚Ä¢ ') + '</div>' +
                       '<button class="alert-banner-btn" onclick="viewUrgentProducts()">üëâ Voir les produits</button>';
            
            banner.innerHTML = html;
            banner.classList.add('show');
        }
        
        function viewUrgentProducts() {
            // Compter les diff√©rents types d'alertes
            var outOfStock = 0;
            var lowStock = 0;
            var toRenew = 0;
            var expiredOrSoon = 0;
            
            for (var i = 0; i < items.length; i++) {
                var qty = getQuantity(items[i].quantite);
                var days = getDays(items[i].datePeremption);
                
                if (qty === 0) outOfStock++;
                if (qty === 1) lowStock++;
                if (items[i].aRenouveler) toRenew++;
                if (days !== null && (days < 0 || (days >= 0 && days <= 3))) expiredOrSoon++;
            }
            
            // Choisir le filtre le plus pertinent
            if (outOfStock > 0) {
                // Priorit√© aux produits √©puis√©s
                currentFilter = 'out_of_stock';
            } else if (toRenew > 0) {
                // Ensuite, les produits √† renouveler
                currentFilter = 'to_renew';
            } else if (expiredOrSoon > 0) {
                // Sinon, montrer les produits qui expirent bient√¥t ou p√©rim√©s
                currentFilter = 'soon';
            } else {
                // Par d√©faut, tout montrer
                currentFilter = 'all';
            }
            
            // Mettre √† jour l'UI des boutons
            var filterBtns = document.querySelectorAll('.filter-btn');
            for (var i = 0; i < filterBtns.length; i++) {
                filterBtns[i].classList.remove('active');
                if (filterBtns[i].getAttribute('data-f') === currentFilter) {
                    filterBtns[i].classList.add('active');
                }
            }
            
            renderItems();
            
            // Scroller vers les produits
            document.getElementById('items').scrollIntoView({ behavior: 'smooth' });
        }
        
        // Rendre la fonction globale pour l'onclick
        window.viewUrgentProducts = viewUrgentProducts;

        function renderStats() {
            var total = items.length;
            var exp = 0, soon = 0, outOfStock = 0;
            
            for (var i = 0; i < items.length; i++) {
                var d = getDays(items[i].datePeremption);
                var qty = getQuantity(items[i].quantite);
                
                if (qty === 0) outOfStock++;
                if (d !== null && d < 0) exp++;
                if (d !== null && d >= 0 && d <= 3) soon++;
            }
            
            var nums = document.querySelectorAll('.stat-card .number');
            nums[0].textContent = total;
            nums[1].textContent = soon;
            nums[2].textContent = exp;
        }

        function renderItems() {
            var filtered = items.filter(function(item) {
                var d = getDays(item.datePeremption);
                var qty = getQuantity(item.quantite);
                
                var statusMatch = false;
                if (currentFilter === 'all') statusMatch = true;
                if (currentFilter === 'expired') statusMatch = d !== null && d < 0;
                if (currentFilter === 'soon') statusMatch = d !== null && d >= 0 && d <= 3;
                if (currentFilter === 'fresh') statusMatch = d === null || d > 3;
                if (currentFilter === 'out_of_stock') statusMatch = qty === 0;
                if (currentFilter === 'to_renew') statusMatch = item.aRenouveler === true;
                
                var emplacementMatch = currentEmplacement === 'all' || (item.emplacement || 'frigo') === currentEmplacement;
                
                return statusMatch && emplacementMatch;
            });
            
            var itemsEl = document.getElementById('items');
            var emptyEl = document.getElementById('empty');
            
            if (filtered.length === 0) {
                itemsEl.classList.remove('active');
                emptyEl.style.display = 'block';
            } else {
                itemsEl.classList.add('active');
                emptyEl.style.display = 'none';
                
                var html = '';
                for (var i = 0; i < filtered.length; i++) {
                    var item = filtered[i];
                    var d = getDays(item.datePeremption);
                    var s = getStatus(d);
                    
                    html += '<div class="item-card ' + s.cls + '">';
                    if (item.image) {
                        html += '<img src="' + item.image + '" class="item-image">';
                    }
                    html += '<div class="item-content">' +
                            '<div class="item-name">' + item.nom + '</div>';
                    if (item.barcode) {
                        html += '<div class="barcode-badge">üìä ' + item.barcode + '</div>';
                    }
                    if (item.emplacement) {
                        var empl = getEmplacementInfo(item.emplacement);
                        html += '<div class="emplacement-badge">' + empl.emoji + ' ' + empl.text + '</div>';
                    }
                    
                    // Afficher la quantit√©
                    var qty = getQuantity(item.quantite);
                    if (qty === 0) {
                        html += '<div class="stock-alert">‚ö†Ô∏è Stock √©puis√©</div>';
                    } else {
                        html += '<div class="quantity-badge">üì¶ Quantit√©: ' + qty + '</div>';
                    }
                    
                    // Afficher le badge "√Ä renouveler"
                    if (item.aRenouveler) {
                        html += '<div class="renouveler-badge">üìù √Ä renouveler</div>';
                    }
                    
                    html += '<div class="item-info">üìÖ Ajout√©: ' + new Date(item.dateAjout).toLocaleDateString('fr-FR') + '</div>' +
                            '<div class="item-info">‚è∞ Expire: ' + (item.datePeremption ? new Date(item.datePeremption).toLocaleDateString('fr-FR') : 'Non indiqu√©') + '</div>' +
                            '<div class="item-info" style="font-weight:bold;margin-top:10px;font-size:1.1em">' + s.text + '</div>' +
                            '<div class="quantity-controls">' +
                            '<button class="btn-qty-minus" data-id="' + item.id + '">‚àí</button>' +
                            '<span class="quantity-value">' + getQuantity(item.quantite) + '</span>' +
                            '<button class="btn-qty-plus" data-id="' + item.id + '">+</button>' +
                            '</div>' +
                            '<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px;">' +
                            '<button class="btn btn-edit" data-id="' + item.id + '" style="background:#f59e0b;padding:12px">‚úèÔ∏è Modifier</button>' +
                            '<button class="btn btn-delete" data-id="' + item.id + '" style="background:#ef4444;padding:12px">üóëÔ∏è Supprimer</button>' +
                            '</div>' +
                            '</div></div>';
                }
                itemsEl.innerHTML = html;
                
                // Boutons de suppression
                var deleteBtns = itemsEl.querySelectorAll('.btn-delete');
                for (var i = 0; i < deleteBtns.length; i++) {
                    deleteBtns[i].onclick = function() {
                        var id = parseInt(this.getAttribute('data-id'));
                        if (confirm('Supprimer ce produit ?')) {
                            items = items.filter(function(it) { return it.id !== id; });
                            saveItems();
                            renderAll();
                        }
                    };
                }
                
                // Boutons de modification
                var editBtns = itemsEl.querySelectorAll('.btn-edit');
                for (var i = 0; i < editBtns.length; i++) {
                    editBtns[i].onclick = function() {
                        var id = parseInt(this.getAttribute('data-id'));
                        editItem(id);
                    };
                }
                
                // Boutons de quantit√© (-)
                var minusBtns = itemsEl.querySelectorAll('.btn-qty-minus');
                for (var i = 0; i < minusBtns.length; i++) {
                    minusBtns[i].onclick = function() {
                        var id = parseInt(this.getAttribute('data-id'));
                        changeQuantity(id, -1);
                    };
                }
                
                // Boutons de quantit√© (+)
                var plusBtns = itemsEl.querySelectorAll('.btn-qty-plus');
                for (var i = 0; i < plusBtns.length; i++) {
                    plusBtns[i].onclick = function() {
                        var id = parseInt(this.getAttribute('data-id'));
                        changeQuantity(id, 1);
                    };
                }
            }
        }

        function renderAll() {
            renderStats();
            renderItems();
            checkUrgentProducts();
        }
        
        function changeQuantity(itemId, delta) {
            var item = items.find(function(it) { return it.id === itemId; });
            if (!item) return;
            
            // Important : utiliser !== undefined au lieu de || pour g√©rer le cas o√π quantite = 0
            var currentQty = (item.quantite !== undefined && item.quantite !== null) ? item.quantite : 1;
            var newQty = currentQty + delta;
            
            // Emp√™cher de descendre en dessous de 0
            if (newQty < 0) {
                newQty = 0;
            }
            
            // Limiter √† 99 maximum
            if (newQty > 99) {
                newQty = 99;
            }
            
            // Mettre √† jour la quantit√©
            item.quantite = newQty;
            saveItems();
            renderAll();
        }

        function startScanner() {
            var scannerEl = document.getElementById('scanner');
            scannerEl.classList.add('active');
            document.getElementById('actions').style.display = 'none';
            
            // R√©initialiser les variables de scan
            lastScannedCode = null;
            scanConfidenceCount = {};
            scanningActive = true;
            
            Quagga.init({
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: document.querySelector('#scanner-container'),
                    constraints: {
                        facingMode: "environment",
                        width: { min: 640, ideal: 1280, max: 1920 },
                        height: { min: 480, ideal: 720, max: 1080 }
                    }
                },
                locator: {
                    patchSize: "medium",
                    halfSample: true
                },
                numOfWorkers: 2,
                frequency: 10,
                decoder: {
                    readers: ["ean_reader", "ean_8_reader", "upc_reader", "upc_e_reader"]
                },
                locate: true
            }, function(err) {
                if (err) {
                    console.error(err);
                    alert("Impossible d'acc√©der √† la cam√©ra");
                    stopScanner();
                    return;
                }
                Quagga.start();
            });

            Quagga.onDetected(function(result) {
                if (!scanningActive) return;
                
                var code = result.codeResult.code;
                
                // Valider le format du code-barres
                if (!code || code.length < 8 || code.length > 13) return;
                if (!/^\d+$/.test(code)) return; // Seulement des chiffres
                
                // Syst√®me de confiance : d√©tecter 2 fois le m√™me code
                if (!scanConfidenceCount[code]) {
                    scanConfidenceCount[code] = 0;
                }
                scanConfidenceCount[code]++;
                
                console.log("Code d√©tect√©:", code, "Confiance:", scanConfidenceCount[code]);
                
                // Si d√©tect√© 2 fois (r√©duit de 3 √† 2)
                if (scanConfidenceCount[code] >= 2) {
                    scanningActive = false;
                    
                    // Feedback visuel
                    var overlay = document.querySelector('.scanner-overlay');
                    overlay.style.borderColor = '#38ef7d';
                    overlay.style.boxShadow = '0 0 0 9999px rgba(0,0,0,0.8), 0 0 30px #38ef7d';
                    
                    // Vibration si disponible
                    if (navigator.vibrate) {
                        navigator.vibrate(200);
                    }
                    
                    setTimeout(function() {
                        stopScanner();
                        confirmBarcode(code);
                    }, 500);
                }
            });
        }
        
        function confirmBarcode(code) {
            var message = "Code-barres d√©tect√© :\n\n" + code + "\n\nRechercher ce produit ?";
            if (confirm(message)) {
                searchProduct(code);
            } else {
                // Rescanner
                document.getElementById('actions').style.display = 'grid';
            }
        }

        function stopScanner() {
            try {
                Quagga.stop();
            } catch (e) {
                console.log("Quagga d√©j√† arr√™t√©");
            }
            document.getElementById('scanner').classList.remove('active');
            document.getElementById('actions').style.display = 'grid';
            
            // R√©initialiser le style de l'overlay
            var overlay = document.querySelector('.scanner-overlay');
            if (overlay) {
                overlay.style.borderColor = '#38ef7d';
                overlay.style.boxShadow = '0 0 0 9999px rgba(0,0,0,0.5)';
            }
            
            scanningActive = false;
            lastScannedCode = null;
            scanConfidenceCount = {};
        }

        function searchProduct(barcode) {
            currentBarcode = barcode;
            document.getElementById('loading').classList.add('active');
            document.getElementById('loadingBarcode').textContent = 'Code: ' + barcode;
            
            fetch('https://world.openfoodfacts.org/api/v2/product/' + barcode + '.json')
                .then(function(response) { return response.json(); })
                .then(function(data) {
                    document.getElementById('loading').classList.remove('active');
                    
                    if (data.status === 1 && data.product) {
                        var product = data.product;
                        currentProductData = {
                            nom: product.product_name || product.generic_name || 'Produit inconnu',
                            image: product.image_url || product.image_front_url || null,
                            categorie: detectCategory(product),
                            barcode: barcode
                        };
                        showForm(currentProductData);
                    } else {
                        alert('Produit non trouv√© dans la base de donn√©es.\nVous pouvez l\'ajouter manuellement.');
                        showForm({ barcode: barcode });
                    }
                })
                .catch(function(error) {
                    console.error('Erreur:', error);
                    document.getElementById('loading').classList.remove('active');
                    alert('Erreur de connexion.\nVous pouvez ajouter le produit manuellement.');
                    showForm({ barcode: barcode });
                });
        }

        function detectCategory(product) {
            var categories = product.categories || '';
            categories = categories.toLowerCase();
            
            if (categories.indexOf('fruit') !== -1) return 'fruit';
            if (categories.indexOf('vegetable') !== -1 || categories.indexOf('l√©gume') !== -1) return 'legume';
            if (categories.indexOf('meat') !== -1 || categories.indexOf('viande') !== -1) return 'viande';
            if (categories.indexOf('fish') !== -1 || categories.indexOf('poisson') !== -1) return 'poisson';
            if (categories.indexOf('dairy') !== -1 || categories.indexOf('lait') !== -1 || categories.indexOf('fromage') !== -1) return 'produit_laitier';
            if (categories.indexOf('beverage') !== -1 || categories.indexOf('boisson') !== -1 || categories.indexOf('drink') !== -1) return 'boisson';
            
            return 'autre';
        }

        // Fonctions pour toggle le checkbox personnalis√© "√Ä renouveler"
        function toggleRenouvelerAdd() {
            var checkbox = document.getElementById('formRenouveler');
            var box = document.getElementById('checkboxBoxAdd');
            if (checkbox && box) {
                checkbox.checked = !checkbox.checked;
                box.textContent = checkbox.checked ? '‚òëÔ∏è' : '‚òê';
                box.style.color = checkbox.checked ? '#667eea' : '#999';
            }
        }
        
        function toggleRenouvelerEdit() {
            var checkbox = document.getElementById('formRenouveler');
            var box = document.getElementById('checkboxBoxEdit');
            if (checkbox && box) {
                checkbox.checked = !checkbox.checked;
                box.textContent = checkbox.checked ? '‚òëÔ∏è' : '‚òê';
                box.style.color = checkbox.checked ? '#667eea' : '#999';
            }
        }

        function showForm(productData) {
            productData = productData || {};
            var form = document.getElementById('form');
            
            // Date sugg√©r√©e : dans 7 jours
            var suggestedDate = new Date();
            suggestedDate.setDate(suggestedDate.getDate() + 7);
            var suggestedDateStr = suggestedDate.toISOString().split('T')[0];
            
            var html = '<h3>‚ûï Ajouter au frigo</h3>';
            
            if (productData.barcode) {
                html += '<div class="barcode-badge">üìä Code-barres: ' + productData.barcode + '</div>';
            }
            
            html += '<div class="form-group">';
            if (productData.image) {
                html += '<img src="' + productData.image + '" class="preview-img" id="previewImage">';
            } else {
                html += '<div id="previewImage" class="preview-placeholder">üì∑ Aucune photo</div>';
            }
            html += '<input type="file" id="customPhoto" accept="image/*" capture="environment" style="display: none;">';
            html += '<label for="customPhoto" class="btn" style="background:#f59e0b;padding:12px;font-size:16px;margin:10px 0;">üì∏ ' + (productData.image ? 'Changer' : 'Prendre') + ' la photo</label>';
            html += '</div>';
            
            html += '<div class="form-group">' +
                    '<label for="formNom">Nom du produit *</label>' +
                    '<input type="text" id="formNom" placeholder="Ex: Lait, Yaourt, Pommes..." value="' + (productData.nom || '') + '">' +
                    '</div>' +
                    '<div class="form-group">' +
                    '<label for="formDate">Date de p√©remption</label>' +
                    '<input type="date" id="formDate" value="' + suggestedDateStr + '">' +
                    '<div class="date-suggestion">üí° Date sugg√©r√©e : +7 jours (modifiable)</div>' +
                    '</div>' +
                    '<div class="form-group">' +
                    '<label for="formCategorie">Cat√©gorie</label>' +
                    '<select id="formCategorie">' +
                    '<option value="fruit"' + (productData.categorie === 'fruit' ? ' selected' : '') + '>üçé Fruit</option>' +
                    '<option value="legume"' + (productData.categorie === 'legume' ? ' selected' : '') + '>ü•ï L√©gume</option>' +
                    '<option value="viande"' + (productData.categorie === 'viande' ? ' selected' : '') + '>ü•© Viande</option>' +
                    '<option value="poisson"' + (productData.categorie === 'poisson' ? ' selected' : '') + '>üêü Poisson</option>' +
                    '<option value="produit_laitier"' + (productData.categorie === 'produit_laitier' ? ' selected' : '') + '>ü•õ Produit laitier</option>' +
                    '<option value="boisson"' + (productData.categorie === 'boisson' ? ' selected' : '') + '>ü•§ Boisson</option>' +
                    '<option value="autre"' + (productData.categorie === 'autre' || !productData.categorie ? ' selected' : '') + '>üì¶ Autre</option>' +
                    '</select>' +
                    '</div>' +
                    '<div class="form-group">' +
                    '<label for="formEmplacement">Emplacement</label>' +
                    '<select id="formEmplacement">' +
                    '<option value="frigo"' + (productData.emplacement === 'frigo' || !productData.emplacement ? ' selected' : '') + '>üßä Frigo</option>' +
                    '<option value="congelateur"' + (productData.emplacement === 'congelateur' ? ' selected' : '') + '>‚ùÑÔ∏è Cong√©lateur</option>' +
                    '<option value="placard"' + (productData.emplacement === 'placard' ? ' selected' : '') + '>üö™ Placard</option>' +
                    '<option value="cave"' + (productData.emplacement === 'cave' ? ' selected' : '') + '>üç∑ Cave</option>' +
                    '<option value="corbeille"' + (productData.emplacement === 'corbeille' ? ' selected' : '') + '>üß∫ Corbeille</option>' +
                    '<option value="autre_emplacement"' + (productData.emplacement === 'autre_emplacement' ? ' selected' : '') + '>üìç Autre</option>' +
                    '</select>' +
                    '</div>' +
                    '<div class="form-group">' +
                    '<label for="formQuantite">Quantit√©</label>' +
                    '<div style="display: flex; align-items: center; gap: 10px;">' +
                    '<button type="button" class="btn-quantity" id="btnMinus">‚àí</button>' +
                    '<input type="number" id="formQuantite" value="' + getQuantity(productData.quantite) + '" min="0" max="99" style="width: 80px; text-align: center; font-size: 18px; font-weight: bold;">' +
                    '<button type="button" class="btn-quantity" id="btnPlus">+</button>' +
                    '</div>' +
                    '<div class="date-suggestion">üí° Nombre d\'unit√©s</div>' +
                    '</div>' +
                    '<div class="form-group" style="margin-top: 15px;">' +
                    '<label id="labelRenouvelerAdd" style="cursor: pointer; margin: 0; font-weight: 600; display: flex; align-items: center; gap: 15px; padding: 15px; background: #f5f5f5; border-radius: 10px; user-select: none; -webkit-tap-highlight-color: transparent;">' +
                    '<input type="checkbox" id="formRenouveler" ' + (productData.aRenouveler ? 'checked' : '') + ' style="display: none;">' +
                    '<span id="checkboxBoxAdd" style="font-size: 32px; line-height: 1; color: ' + (productData.aRenouveler ? '#667eea' : '#999') + ';">' + (productData.aRenouveler ? '‚òëÔ∏è' : '‚òê') + '</span>' +
                    '<span style="flex: 1;">üìù √Ä renouveler (ajouter √† la liste de courses)</span>' +
                    '</label>' +
                    '</div>' +
                    '<button class="btn" id="btnAdd" style="background:#667eea;font-size:18px;padding:15px;margin-top:10px">‚úì Ajouter au frigo</button>' +
                    '<button class="btn" id="btnCancel" style="background:#ccc;color:#333;font-size:18px;padding:15px">‚úï Annuler</button>';
            
            form.innerHTML = html;
            form.classList.add('active');
            document.getElementById('actions').style.display = 'none';
            
            // Gestion de la photo personnalis√©e
            var customImageData = productData.image || null;
            
            // Gestion de la quantit√© avec boutons +/-
            var quantityInput = document.getElementById('formQuantite');
            document.getElementById('btnPlus').onclick = function() {
                var val = parseInt(quantityInput.value);
                if (isNaN(val)) val = 0;
                if (val < 99) quantityInput.value = val + 1;
            };
            document.getElementById('btnMinus').onclick = function() {
                var val = parseInt(quantityInput.value);
                if (isNaN(val)) val = 1;
                if (val > 0) quantityInput.value = val - 1;
            };
            
            // Event listener pour iOS - Checkbox "√Ä renouveler"
            var labelRenouveler = document.getElementById('labelRenouvelerAdd');
            if (labelRenouveler) {
                labelRenouveler.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    toggleRenouvelerAdd();
                });
                labelRenouveler.addEventListener('touchend', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    toggleRenouvelerAdd();
                });
            }
            
            document.getElementById('customPhoto').addEventListener('change', function(e) {
                var file = e.target.files[0];
                if (!file) return;
                
                var reader = new FileReader();
                reader.onload = function(event) {
                    customImageData = event.target.result;
                    var preview = document.getElementById('previewImage');
                    if (preview.tagName === 'IMG') {
                        preview.src = customImageData;
                    } else {
                        preview.outerHTML = '<img src="' + customImageData + '" class="preview-img" id="previewImage">';
                    }
                    // Changer le texte du bouton
                    document.querySelector('label[for="customPhoto"]').innerHTML = 'üì∏ Changer la photo';
                };
                reader.readAsDataURL(file);
            });
            
            document.getElementById('btnAdd').onclick = function() {
                var nom = document.getElementById('formNom').value.trim();
                if (!nom) {
                    alert('Veuillez entrer un nom de produit');
                    return;
                }
                
                var dateValue = document.getElementById('formDate').value;
                
                var newItem = {
                    id: Date.now(),
                    nom: nom,
                    datePeremption: dateValue || null,
                    categorie: document.getElementById('formCategorie').value,
                    emplacement: document.getElementById('formEmplacement').value,
                    quantite: parseInt(document.getElementById('formQuantite').value) || 1,
                    aRenouveler: document.getElementById('formRenouveler').checked,
                    dateAjout: new Date().toISOString().split('T')[0],
                    image: customImageData,
                    barcode: productData.barcode || null
                };
                
                items.unshift(newItem);
                saveItems();
                closeForm();
                renderAll();
            };
            
            document.getElementById('btnCancel').onclick = closeForm;
            
            setTimeout(function() {
                document.getElementById('formNom').focus();
            }, 100);
        }

        // === FONCTIONS IMPORT/EXPORT ===
        
        function toggleSettings() {
            var menu = document.getElementById('settingsMenu');
            menu.classList.toggle('active');
        }
        
        function exportData() {
            try {
                // R√©cup√©rer toutes les donn√©es
                var data = {
                    version: "1.0",
                    exportDate: new Date().toISOString(),
                    items: items,
                    notificationAsked: localStorage.getItem('notification-asked') === 'true'
                };
                
                // Cr√©er un fichier JSON
                var dataStr = JSON.stringify(data, null, 2);
                var dataBlob = new Blob([dataStr], { type: 'application/json' });
                
                // Cr√©er un lien de t√©l√©chargement
                var url = URL.createObjectURL(dataBlob);
                var link = document.createElement('a');
                link.href = url;
                link.download = 'frigo-manager-backup-' + new Date().toISOString().split('T')[0] + '.json';
                
                // D√©clencher le t√©l√©chargement
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                alert('‚úÖ Donn√©es export√©es avec succ√®s !\n\n' + items.length + ' produits sauvegard√©s.');
                toggleSettings();
            } catch (err) {
                alert('‚ùå Erreur lors de l\'export : ' + err.message);
            }
        }
        
        function importData(event) {
            var file = event.target.files[0];
            if (!file) return;
            
            var reader = new FileReader();
            reader.onload = function(e) {
                try {
                    var data = JSON.parse(e.target.result);
                    
                    // V√©rifier la structure
                    if (!data.items || !Array.isArray(data.items)) {
                        throw new Error('Format de fichier invalide');
                    }
                    
                    // Demander confirmation
                    if (items.length > 0) {
                        var confirm = window.confirm(
                            '‚ö†Ô∏è ATTENTION\n\n' +
                            'Vous avez actuellement ' + items.length + ' produits.\n' +
                            'Le fichier contient ' + data.items.length + ' produits.\n\n' +
                            'Voulez-vous REMPLACER vos donn√©es actuelles ?\n\n' +
                            '(Cliquez "Annuler" pour ajouter les produits sans supprimer les actuels)'
                        );
                        
                        if (confirm) {
                            // Remplacer
                            items = data.items;
                        } else {
                            // Ajouter
                            data.items.forEach(function(item) {
                                // Changer les IDs pour √©viter les conflits
                                item.id = Date.now() + Math.random();
                                items.push(item);
                            });
                        }
                    } else {
                        // Pas de donn√©es actuelles, importer directement
                        items = data.items;
                    }
                    
                    // Sauvegarder
                    saveItems();
                    renderAll();
                    toggleSettings();
                    
                    alert('‚úÖ Import r√©ussi !\n\n' + data.items.length + ' produits import√©s.');
                } catch (err) {
                    alert('‚ùå Erreur lors de l\'import : ' + err.message);
                }
            };
            reader.readAsText(file);
            
            // Reset l'input pour permettre de r√©importer le m√™me fichier
            event.target.value = '';
        }
        
        // === FONCTIONS EXCEL ===
        
        function exportExcel() {
            try {
                if (items.length === 0) {
                    alert('‚ùå Aucun produit √† exporter');
                    return;
                }
                
                // Pr√©parer les donn√©es pour Excel
                var excelData = items.map(function(item) {
                    return {
                        'Nom': item.nom || '',
                        'Code-barres': item.barcode || '',
                        'Date d\'ajout': item.dateAjout ? new Date(item.dateAjout).toLocaleDateString('fr-FR') : '',
                        'Date d\'expiration': item.datePeremption ? new Date(item.datePeremption).toLocaleDateString('fr-FR') : '',
                        'Cat√©gorie': item.categorie || '',
                        'Emplacement': item.emplacement || '',
                        'Quantit√©': item.quantite || 0,
                        '√Ä renouveler': item.aRenouveler ? 'Oui' : 'Non'
                    };
                });
                
                // Cr√©er un nouveau workbook
                var wb = XLSX.utils.book_new();
                
                // Convertir les donn√©es en worksheet
                var ws = XLSX.utils.json_to_sheet(excelData);
                
                // Ajuster la largeur des colonnes
                var wscols = [
                    {wch: 25},  // Nom
                    {wch: 15},  // Code-barres
                    {wch: 12},  // Date d'ajout
                    {wch: 15},  // Date d'expiration
                    {wch: 15},  // Cat√©gorie
                    {wch: 15},  // Emplacement
                    {wch: 10},  // Quantit√©
                    {wch: 12}   // √Ä renouveler
                ];
                ws['!cols'] = wscols;
                
                // Ajouter le worksheet au workbook
                XLSX.utils.book_append_sheet(wb, ws, 'Produits');
                
                // G√©n√©rer le fichier Excel
                var filename = 'frigo-manager-' + new Date().toISOString().split('T')[0] + '.xlsx';
                XLSX.writeFile(wb, filename);
                
                alert('‚úÖ Export Excel r√©ussi !\n\n' + items.length + ' produits export√©s dans ' + filename);
                toggleSettings();
            } catch (err) {
                alert('‚ùå Erreur lors de l\'export Excel : ' + err.message);
                console.error(err);
            }
        }
        
        function importExcel(event) {
            var file = event.target.files[0];
            if (!file) return;
            
            var reader = new FileReader();
            reader.onload = function(e) {
                try {
                    // Lire le fichier Excel
                    var data = new Uint8Array(e.target.result);
                    var workbook = XLSX.read(data, {type: 'array'});
                    
                    // Prendre la premi√®re feuille
                    var firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    
                    // Convertir en JSON
                    var excelData = XLSX.utils.sheet_to_json(firstSheet);
                    
                    if (excelData.length === 0) {
                        throw new Error('Le fichier Excel est vide');
                    }
                    
                    // Convertir les donn√©es Excel en format interne
                    var importedItems = excelData.map(function(row) {
                        // Parser les dates
                        var dateAjout = null;
                        if (row['Date d\'ajout']) {
                            var parts = row['Date d\'ajout'].split('/');
                            if (parts.length === 3) {
                                dateAjout = parts[2] + '-' + parts[1].padStart(2, '0') + '-' + parts[0].padStart(2, '0');
                            }
                        }
                        
                        var datePeremption = null;
                        if (row['Date d\'expiration']) {
                            var parts2 = row['Date d\'expiration'].split('/');
                            if (parts2.length === 3) {
                                datePeremption = parts2[2] + '-' + parts2[1].padStart(2, '0') + '-' + parts2[0].padStart(2, '0');
                            }
                        }
                        
                        return {
                            id: Date.now() + Math.random(),
                            nom: row['Nom'] || 'Produit',
                            barcode: row['Code-barres'] || null,
                            dateAjout: dateAjout || new Date().toISOString().split('T')[0],
                            datePeremption: datePeremption,
                            categorie: row['Cat√©gorie'] || 'autre',
                            emplacement: row['Emplacement'] || 'frigo',
                            quantite: parseInt(row['Quantit√©']) || 1,
                            aRenouveler: row['√Ä renouveler'] === 'Oui',
                            image: null
                        };
                    });
                    
                    // Demander confirmation
                    if (items.length > 0) {
                        var confirm = window.confirm(
                            '‚ö†Ô∏è ATTENTION\n\n' +
                            'Vous avez actuellement ' + items.length + ' produits.\n' +
                            'Le fichier Excel contient ' + importedItems.length + ' produits.\n\n' +
                            'Voulez-vous REMPLACER vos donn√©es actuelles ?\n\n' +
                            '(Cliquez "Annuler" pour ajouter les produits sans supprimer les actuels)'
                        );
                        
                        if (confirm) {
                            // Remplacer
                            items = importedItems;
                        } else {
                            // Ajouter
                            items = items.concat(importedItems);
                        }
                    } else {
                        // Pas de donn√©es actuelles, importer directement
                        items = importedItems;
                    }
                    
                    // Sauvegarder
                    saveItems();
                    renderAll();
                    toggleSettings();
                    
                    alert('‚úÖ Import Excel r√©ussi !\n\n' + importedItems.length + ' produits import√©s.');
                } catch (err) {
                    alert('‚ùå Erreur lors de l\'import Excel : ' + err.message);
                    console.error(err);
                }
            };
            reader.readAsArrayBuffer(file);
            
            // Reset l'input
            event.target.value = '';
        }
        
        function confirmDeleteAll() {
            var confirm1 = window.confirm(
                '‚ö†Ô∏è SUPPRIMER TOUTES LES DONN√âES ?\n\n' +
                'Cette action supprimera d√©finitivement tous vos ' + items.length + ' produits.\n\n' +
                'Cette action est IRR√âVERSIBLE.\n\n' +
                '√ätes-vous s√ªr ?'
            );
            
            if (!confirm1) return;
            
            var confirm2 = window.confirm(
                '‚ö†Ô∏è DERNI√àRE CONFIRMATION\n\n' +
                'Voulez-vous vraiment supprimer TOUTES les donn√©es ?\n\n' +
                'Pensez √† exporter vos donn√©es avant si vous voulez les sauvegarder.'
            );
            
            if (confirm2) {
                items = [];
                saveItems();
                renderAll();
                toggleSettings();
                alert('‚úÖ Toutes les donn√©es ont √©t√© supprim√©es.');
            }
        }

        function closeForm() {
            document.getElementById('form').classList.remove('active');
            document.getElementById('form').innerHTML = '';
            document.getElementById('actions').style.display = 'grid';
            currentBarcode = null;
            currentProductData = null;
        }
        
        function editItem(itemId) {
            var item = items.find(function(it) { return it.id === itemId; });
            if (!item) return;
            
            var form = document.getElementById('form');
            
            var html = '<h3>‚úèÔ∏è Modifier le produit</h3>';
            
            if (item.barcode) {
                html += '<div class="barcode-badge">üìä ' + item.barcode + '</div>';
            }
            
            html += '<div class="form-group">';
            if (item.image) {
                html += '<img src="' + item.image + '" class="preview-img" id="previewImage">';
            } else {
                html += '<div id="previewImage" class="preview-placeholder">üì∑ Aucune photo</div>';
            }
            html += '<input type="file" id="customPhoto" accept="image/*" capture="environment" style="display: none;">';
            html += '<label for="customPhoto" class="btn" style="background:#f59e0b;padding:12px;font-size:16px;margin:10px 0;">üì∏ ' + (item.image ? 'Changer' : 'Prendre') + ' la photo</label>';
            html += '</div>';
            
            html += '<div class="form-group">' +
                    '<label for="formNom">Nom du produit *</label>' +
                    '<input type="text" id="formNom" placeholder="Ex: Lait, Yaourt, Pommes..." value="' + (item.nom || '') + '">' +
                    '</div>' +
                    '<div class="form-group">' +
                    '<label for="formDate">Date de p√©remption</label>' +
                    '<input type="date" id="formDate" value="' + (item.datePeremption || '') + '">' +
                    '<div class="date-suggestion">üí° Modifiable</div>' +
                    '</div>' +
                    '<div class="form-group">' +
                    '<label for="formCategorie">Cat√©gorie</label>' +
                    '<select id="formCategorie">' +
                    '<option value="fruit"' + (item.categorie === 'fruit' ? ' selected' : '') + '>üçé Fruit</option>' +
                    '<option value="legume"' + (item.categorie === 'legume' ? ' selected' : '') + '>ü•ï L√©gume</option>' +
                    '<option value="viande"' + (item.categorie === 'viande' ? ' selected' : '') + '>ü•© Viande</option>' +
                    '<option value="poisson"' + (item.categorie === 'poisson' ? ' selected' : '') + '>üêü Poisson</option>' +
                    '<option value="produit_laitier"' + (item.categorie === 'produit_laitier' ? ' selected' : '') + '>ü•õ Produit laitier</option>' +
                    '<option value="boisson"' + (item.categorie === 'boisson' ? ' selected' : '') + '>ü•§ Boisson</option>' +
                    '<option value="autre"' + (item.categorie === 'autre' || !item.categorie ? ' selected' : '') + '>üì¶ Autre</option>' +
                    '</select>' +
                    '</div>' +
                    '<div class="form-group">' +
                    '<label for="formEmplacement">Emplacement</label>' +
                    '<select id="formEmplacement">' +
                    '<option value="frigo"' + (item.emplacement === 'frigo' || !item.emplacement ? ' selected' : '') + '>üßä Frigo</option>' +
                    '<option value="congelateur"' + (item.emplacement === 'congelateur' ? ' selected' : '') + '>‚ùÑÔ∏è Cong√©lateur</option>' +
                    '<option value="placard"' + (item.emplacement === 'placard' ? ' selected' : '') + '>üö™ Placard</option>' +
                    '<option value="cave"' + (item.emplacement === 'cave' ? ' selected' : '') + '>üç∑ Cave</option>' +
                    '<option value="corbeille"' + (item.emplacement === 'corbeille' ? ' selected' : '') + '>üß∫ Corbeille</option>' +
                    '<option value="autre_emplacement"' + (item.emplacement === 'autre_emplacement' ? ' selected' : '') + '>üìç Autre</option>' +
                    '</select>' +
                    '</div>' +
                    '<div class="form-group">' +
                    '<label for="formQuantite">Quantit√©</label>' +
                    '<div style="display: flex; align-items: center; gap: 10px;">' +
                    '<button type="button" class="btn-quantity" id="btnMinus">‚àí</button>' +
                    '<input type="number" id="formQuantite" value="' + getQuantity(item.quantite) + '" min="0" max="99" style="width: 80px; text-align: center; font-size: 18px; font-weight: bold;">' +
                    '<button type="button" class="btn-quantity" id="btnPlus">+</button>' +
                    '</div>' +
                    '<div class="date-suggestion">üí° Nombre d\'unit√©s</div>' +
                    '</div>' +
                    '<div class="form-group" style="margin-top: 15px;">' +
                    '<label id="labelRenouvelerEdit" style="cursor: pointer; margin: 0; font-weight: 600; display: flex; align-items: center; gap: 15px; padding: 15px; background: #f5f5f5; border-radius: 10px; user-select: none; -webkit-tap-highlight-color: transparent;">' +
                    '<input type="checkbox" id="formRenouveler" ' + (item.aRenouveler ? 'checked' : '') + ' style="display: none;">' +
                    '<span id="checkboxBoxEdit" style="font-size: 32px; line-height: 1; color: ' + (item.aRenouveler ? '#667eea' : '#999') + ';">' + (item.aRenouveler ? '‚òëÔ∏è' : '‚òê') + '</span>' +
                    '<span style="flex: 1;">üìù √Ä renouveler (ajouter √† la liste de courses)</span>' +
                    '</label>' +
                    '</div>' +
                    '<button class="btn" id="btnUpdate" style="background:#667eea;font-size:18px;padding:15px;margin-top:10px">‚úì Enregistrer</button>' +
                    '<button class="btn" id="btnCancel" style="background:#ccc;color:#333;font-size:18px;padding:15px">‚úï Annuler</button>';
            
            form.innerHTML = html;
            form.classList.add('active');
            document.getElementById('actions').style.display = 'none';
            
            // Gestion de la photo personnalis√©e
            var customImageData = item.image || null;
            
            // Gestion de la quantit√© avec boutons +/-
            var quantityInput = document.getElementById('formQuantite');
            document.getElementById('btnPlus').onclick = function() {
                var val = parseInt(quantityInput.value);
                if (isNaN(val)) val = 0;
                if (val < 99) quantityInput.value = val + 1;
            };
            document.getElementById('btnMinus').onclick = function() {
                var val = parseInt(quantityInput.value);
                if (isNaN(val)) val = 1;
                if (val > 0) quantityInput.value = val - 1;
            };
            
            // Event listener pour iOS - Checkbox "√Ä renouveler"
            var labelRenouveler = document.getElementById('labelRenouvelerEdit');
            if (labelRenouveler) {
                labelRenouveler.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    toggleRenouvelerEdit();
                });
                labelRenouveler.addEventListener('touchend', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    toggleRenouvelerEdit();
                });
            }
            
            document.getElementById('customPhoto').addEventListener('change', function(e) {
                var file = e.target.files[0];
                if (!file) return;
                
                var reader = new FileReader();
                reader.onload = function(event) {
                    customImageData = event.target.result;
                    var preview = document.getElementById('previewImage');
                    if (preview.tagName === 'IMG') {
                        preview.src = customImageData;
                    } else {
                        preview.outerHTML = '<img src="' + customImageData + '" class="preview-img" id="previewImage">';
                    }
                    document.querySelector('label[for="customPhoto"]').innerHTML = 'üì∏ Changer la photo';
                };
                reader.readAsDataURL(file);
            });
            
            document.getElementById('btnUpdate').onclick = function() {
                var nom = document.getElementById('formNom').value.trim();
                if (!nom) {
                    alert('Veuillez entrer un nom de produit');
                    return;
                }
                
                // Mettre √† jour l'item existant
                var index = items.findIndex(function(it) { return it.id === itemId; });
                if (index !== -1) {
                    items[index].nom = nom;
                    items[index].datePeremption = document.getElementById('formDate').value || null;
                    items[index].categorie = document.getElementById('formCategorie').value;
                    items[index].emplacement = document.getElementById('formEmplacement').value;
                    items[index].quantite = parseInt(document.getElementById('formQuantite').value) || 0;
                    items[index].aRenouveler = document.getElementById('formRenouveler').checked;
                    items[index].image = customImageData;
                }
                
                saveItems();
                closeForm();
                renderAll();
            };
            
            document.getElementById('btnCancel').onclick = closeForm;
            
            setTimeout(function() {
                document.getElementById('formNom').focus();
            }, 100);
        }

        // Filtres
        var filterBtns = document.querySelectorAll('.filter-btn');
        for (var i = 0; i < filterBtns.length; i++) {
            filterBtns[i].onclick = function() {
                currentFilter = this.getAttribute('data-f');
                for (var j = 0; j < filterBtns.length; j++) {
                    filterBtns[j].classList.remove('active');
                }
                this.classList.add('active');
                renderItems();
            };
        }
        
        // Filtres d'emplacement
        var filterEmplBtns = document.querySelectorAll('.filter-empl-btn');
        for (var i = 0; i < filterEmplBtns.length; i++) {
            filterEmplBtns[i].onclick = function() {
                currentEmplacement = this.getAttribute('data-empl');
                for (var j = 0; j < filterEmplBtns.length; j++) {
                    filterEmplBtns[j].classList.remove('active');
                }
                this.classList.add('active');
                renderItems();
            };
        }

        // Boutons
        document.getElementById('btnScan').onclick = startScanner;
        document.getElementById('btnManual').onclick = function() { showForm(); };
        document.getElementById('btnCloseScanner').onclick = stopScanner;
        document.getElementById('btnManualFromScanner').onclick = function() {
            stopScanner();
            showForm();
        };
        
        // Boutons de notification
        document.getElementById('btnEnableNotifications').onclick = function() {
            requestNotificationPermission().then(function(permission) {
                localStorage.setItem('notification-asked', 'true');
                document.getElementById('notificationPrompt').classList.remove('show');
                if (permission === 'granted') {
                    alert('‚úÖ Notifications activ√©es ! Vous recevrez des alertes pour vos produits.');
                    // V√©rifier imm√©diatement et notifier
                    checkUrgentProducts();
                } else if (permission === 'denied') {
                    alert('‚ÑπÔ∏è Pour activer les notifications plus tard :\n\n1. Ouvrez R√©glages iPhone\n2. Safari ‚Üí Notifications\n3. Autorisez pour ce site');
                }
            });
        };
        
        document.getElementById('btnCancelNotifications').onclick = function() {
            localStorage.setItem('notification-asked', 'true');
            document.getElementById('notificationPrompt').classList.remove('show');
        };

        // Initialisation
        renderAll();
    </script>
</body>
</html>
