<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Frigo Manager">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <link rel="icon" type="image/png" href="apple-touch-icon.png">
    <title>Frigo Manager - Scanner</title>
    <script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2@1.8.4/dist/quagga.min.js"></script>
    <script>
        // Import Capacitor plugins pour iOS
        const { Share, Filesystem } = window.Capacitor ? window.Capacitor.Plugins : { Share: null, Filesystem: null };
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        html {
            min-height: 100%; /* Changé de height à min-height pour permettre le scroll */
            overflow-y: auto; /* Permettre scroll vertical */
            overflow-x: clip; /* Empêcher débordement horizontal */
            -webkit-overflow-scrolling: touch; /* Scroll fluide iOS */
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px; /* Réduit pour grands iPhones */
            color: #333;
            overflow-y: auto; /* Force le scroll vertical */
            overflow-x: clip; /* Permet le scroll vertical, bloque seulement horizontal */
            -webkit-overflow-scrolling: touch; /* Scroll fluide sur iOS */
            position: relative; /* Important pour le contexte de positionnement */
        }
        
        /* Padding normal sur écrans plus grands */
        @media (min-width: 600px) {
            body {
                padding: 20px;
            }
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 0 15px;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 15px; /* Réduit pour mobile */
            position: relative;
            padding: 0 60px; /* Espace pour le bouton settings */
        }
        
        /* Margin normal sur écrans plus grands */
        @media (min-width: 600px) {
            .header {
                margin-bottom: 30px;
            }
        }
        
        .header h1 {
            font-size: 1.3em;
            margin-bottom: 5px;
            margin-top: 30px; /* Descendre sous l'encoche */
            line-height: 1.2;
        }
        
        .header p {
            font-size: 0.9em;
            margin: 0;
        }
        
        @media (min-width: 600px) {
            .header h1 {
                font-size: 2.5em;
            }
            .header p {
                font-size: 1em;
            }
        }
        
        /* Mobile - iPhone et Android */
        @media (max-width: 599px) {
            body {
                padding: max(10px, env(safe-area-inset-top)) 10px 10px 10px; /* Réduit pour grands iPhones */
            }
            .container {
                padding: 0 5px;
            }
            .header {
                padding: 0 70px; /* Plus d'espace pour les boutons */
            }
            
            .language-selector {
                top: 55px; /* Aligné avec le sous-titre "Scanner de code-barres" */
                left: 8px;
                font-size: 12px;
                padding: 6px 10px;
            }
            
            .settings-btn {
                top: 55px; /* Même hauteur que le bouton de langue */
                right: 8px;
                font-size: 20px;
                padding: 6px 10px;
            }
            .filters {
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
            }
            .filters-emplacement {
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
            }
            .filter-btn, .filter-empl-btn {
                padding: 8px 4px;
                font-size: 0.72em;
                white-space: normal;
                line-height: 1.25;
                min-height: 48px;
                word-wrap: break-word;
            }
            /* Cacher les emojis sur mobile */
            .btn-emoji {
                display: none;
            }
            /* Bouton GO plus compact sur mobile */
            .search-btn {
                padding: 15px 20px;
                font-size: 16px;
            }
        }
        
        /* Très petit écran - iPhone SE, petits Android */
        @media (max-width: 380px) {
            body {
                padding: 8px;
            }
            .container {
                padding: 0 2px;
            }
            .filters {
                grid-template-columns: repeat(3, 1fr);
                gap: 6px;
            }
            .filters-emplacement {
                grid-template-columns: repeat(3, 1fr);
                gap: 6px;
            }
            .filter-btn, .filter-empl-btn {
                padding: 7px 3px;
                font-size: 0.68em;
                white-space: normal;
                line-height: 1.25;
                min-height: 48px;
                word-wrap: break-word;
            }
            /* Cacher les emojis sur mobile */
            .btn-emoji {
                display: none;
            }
        }
        
        .language-selector {
            position: absolute;
            top: 0px; /* Aligné avec le sous-titre "Scanner de code-barres" */
            left: 5px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid white;
            color: white;
            font-size: 14px;
            font-weight: bold;
            padding: 8px 12px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .language-selector:active {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(0.95);
        }
        
        .settings-btn {
            position: absolute;
            top: 0px; /* Même hauteur que le bouton de langue */
            right: 5px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid white;
            color: white;
            font-size: 22px;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .settings-btn:active {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(0.95);
        }
        
        .settings-menu {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        
        .settings-menu.active {
            display: flex;
        }
        
        .settings-content {
            background: white;
            padding: 30px;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .settings-section {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
        }
        
        .settings-section h4 {
            margin-top: 0;
            color: #333;
            font-size: 1.1em;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px; /* Réduit pour mobile */
            margin-bottom: 10px; /* Réduit pour mobile */
        }
        
        /* Spacing normal sur écrans plus grands */
        @media (min-width: 600px) {
            .stats {
                gap: 15px;
                margin-bottom: 20px;
            }
        }
        
        .stat-card {
            background: white;
            padding: 12px; /* Réduit pour mobile */
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        /* Padding normal sur écrans plus grands */
        @media (min-width: 600px) {
            .stat-card {
                padding: 20px;
            }
        }
        
        .stat-card .number {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }
        
        .stat-card .orange { color: #f59e0b; }
        .stat-card .red { color: #ef4444; }
        
        .stat-card .label {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }
        
        .actions {
            background: white;
            padding: 12px; /* Réduit pour mobile */
            border-radius: 15px;
            margin-bottom: 10px; /* Réduit pour mobile */
            display: grid;
            gap: 10px; /* Réduit pour mobile */
        }
        
        /* Spacing normal sur écrans plus grands */
        @media (min-width: 600px) {
            .actions {
                padding: 20px;
                margin-bottom: 20px;
                gap: 15px;
            }
        }
        
        .btn {
            width: 100%;
            padding: 15px; /* Réduit pour mobile */
            font-size: 1.1em; /* Réduit pour mobile */
            font-weight: bold;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            color: white;
            transition: transform 0.2s;
        }
        
        /* Padding et font normal sur écrans plus grands */
        @media (min-width: 600px) {
            .btn {
                padding: 20px;
                font-size: 1.2em;
            }
        }
        
        .btn:active {
            transform: scale(0.98);
        }
        
        .btn-scan {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }
        
        .btn-manual {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .scanner {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: black;
            z-index: 1000;
            display: none;
            flex-direction: column;
        }
        
        .scanner.active {
            display: flex;
        }
        
        #scanner-container {
            flex: 1;
            position: relative;
            overflow: hidden;
        }
        
        #scanner-container video,
        #scanner-container canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .scanner-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            max-width: 400px;
            height: 200px;
            border: 3px solid #38ef7d;
            border-radius: 10px;
            box-shadow: 0 0 0 9999px rgba(0,0,0,0.5);
            transition: all 0.3s ease;
        }
        
        .scanner-instructions {
            position: absolute;
            top: 20%;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            text-align: center;
            font-size: 1.2em;
            font-weight: bold;
            text-shadow: 0 2px 10px rgba(0,0,0,0.8);
            pointer-events: none;
        }
        
        .scanner-line {
            width: 100%;
            height: 3px;
            background: #38ef7d;
            box-shadow: 0 0 20px #38ef7d;
            animation: scan 2s linear infinite;
        }
        
        @keyframes scan {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(197px); }
        }
        
        .scanner-controls {
            background: rgba(0,0,0,0.8);
            padding: 20px;
            display: flex;
            gap: 10px;
        }
        
        .scanner-controls button {
            flex: 1;
            padding: 15px;
            font-size: 1.1em;
            font-weight: bold;
            border: none;
            border-radius: 10px;
            cursor: pointer;
        }
        
        .btn-close-scanner {
            background: #ef4444;
            color: white;
        }
        
        .btn-manual-entry {
            background: #667eea;
            color: white;
            font-weight: 600;
            font-size: 16px;
            padding: 15px 25px;
            border: 2px solid white;
        }
        
        .btn-manual-entry:hover {
            background: #5568d3;
            transform: scale(1.05);
        }
        
        .loading {
            background: white;
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 20px;
            display: none;
        }
        
        .loading.active {
            display: block;
        }
        
        .spinner {
            font-size: 3em;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            100% { transform: rotate(360deg); }
        }
        
        .filters {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
            margin-bottom: 20px;
            padding: 0;
        }
        
        .filter-btn {
            padding: 8px 4px;
            border: none;
            border-radius: 10px;
            background: white;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            font-size: 0.75em;
            text-align: center;
            white-space: normal;
            line-height: 1.2;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        
        .filter-btn.active {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(255, 107, 107, 0.4);
            transform: translateY(-2px);
        }
        
        .filters-emplacement {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
            margin-bottom: 20px;
            padding: 0;
        }
        
        .filter-empl-btn {
            padding: 8px 4px;
            border: none;
            border-radius: 10px;
            background: white;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            font-size: 0.85em;
            text-align: center;
            white-space: normal;
            line-height: 1.2;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        
        .filter-empl-btn.active {
            background: #f59e0b;
            color: white;
        }
        
        .search-container {
            margin-bottom: 20px;
            padding: 0;
        }
        
        .search-wrapper {
            display: flex;
            gap: 10px;
            width: 100%;
            align-items: center;
            position: relative; /* AJOUTER cette ligne */
        }
        
        .search-input {
            flex: 1;
            padding: 15px 20px;
            font-size: 16px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: all 0.2s;
            box-sizing: border-box;
        }
        
        .search-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        }
        
        .search-input::placeholder {
            color: #9ca3af;
        }
        
        .search-btn {
            background: #10b981;
            color: white;
            border: none;
            border-radius: 12px;
            padding: 15px 25px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
            box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3);
        }
        
        .search-btn:active {
            transform: scale(0.95);
            background: #059669;
        }
        
        .clear-search-btn {
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            font-weight: bold;
            
            /* Positionner DANS le champ de recherche */
            position: absolute;
            right: 100px;
            top: 50%;
            transform: translateY(-50%);
            z-index: 10;
        }
        
        .clear-search-btn:hover {
            background: #dc2626;
            transform: translateY(-50%) scale(1.1);
        }
        
        .clear-search-btn:active {
            transform: translateY(-50%) scale(0.95);
        }
        
        .search-results-info {
            margin-top: 10px;
            padding: 8px 12px;
            background: #667eea;
            color: white;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            text-align: center;
        }
        
        .search-history {
            margin-top: 10px;
            padding: 10px;
            background: #f9fafb;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }
        
        .search-history-title {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 8px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .search-history-items {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        
        .search-history-item {
            padding: 6px 12px;
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .search-history-item:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .search-history-item-text {
            flex: 1;
        }
        
        .search-history-item-remove {
            font-size: 11px;
            opacity: 0.6;
            font-weight: bold;
        }
        
        .search-history-item:hover .search-history-item-remove {
            opacity: 1;
        }
        
        .search-highlight {
            background: #fef08a;
            font-weight: 600;
            padding: 2px 4px;
            border-radius: 3px;
        }
        
        .items {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            display: none;
        }
        
        .items.active {
            display: grid;
        }
        
        .item-card {
            background: white;
            border-radius: 15px;
            overflow: visible;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border: 3px solid transparent;
        }
        
        .item-card.expired {
            border-color: #ef4444;
            background: #fee;
        }
        
        .item-card.soon {
            border-color: #f59e0b;
            background: #fffbeb;
        }
        
        .item-card.fresh {
            border-color: #10b981;
            background: #f0fdf4;
        }
        
        .item-image {
            width: 100%;
            height: 180px;
            object-fit: cover;
            background: #f0f0f0;
            border-radius: 15px 15px 0 0;
        }
        
        .item-content {
            padding: 15px;
        }
        
        .item-name {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .item-info {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
        }
        
        .empty {
            background: white;
            padding: 60px 20px;
            border-radius: 15px;
            text-align: center;
        }
        
        .empty .icon {
            font-size: 4em;
            margin-bottom: 15px;
        }
        
        .form {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            display: none;
        }
        
        .form.active {
            display: block;
        }
        
        /* Masquer les autres éléments quand le formulaire est ouvert */
        .form.active ~ .search-container,
        .form.active ~ #filters,
        .form.active ~ #filtersEmplacement,
        .form.active ~ #items,
        .form.active ~ .alert-banner {
            display: none !important;
        }
        
        .form h3 {
            color: #667eea;
            margin-bottom: 15px;
        }
        
        .form-group {
            margin: 15px 0;
        }
        
        .form-group label {
            display: block;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            font-size: 0.95em;
        }
        
        .form input,
        .form select {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            background: white;
            box-sizing: border-box;
            -webkit-appearance: none;
            appearance: none;
        }
        
        .form input:focus,
        .form select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .date-suggestion {
            font-size: 0.85em;
            color: #666;
            margin-top: 5px;
        }
        
        .preview-img {
            width: 100%;
            max-height: 200px;
            object-fit: contain;
            border-radius: 10px;
            margin: 10px 0;
            background: #f0f0f0;
        }
        
        .preview-placeholder {
            width: 100%;
            height: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f0f0f0;
            border: 2px dashed #ccc;
            border-radius: 10px;
            margin: 10px 0;
            font-size: 1.2em;
            color: #999;
        }
        
        .barcode-badge {
            display: inline-block;
            background: #e8f5e9;
            color: #2e7d32;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            margin: 10px 0;
        }
        
        .barcode-badge.clickable {
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .barcode-badge.clickable:hover {
            background: #c8e6c9;
            transform: scale(1.05);
        }
        
        .barcode-badge.clickable:active {
            transform: scale(0.95);
        }
        
        .emplacement-badge {
            display: inline-block;
            background: #e3f2fd;
            color: #1565c0;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            margin: 5px 5px 5px 0;
        }
        
        /* Badges de santé */
        .health-badges {
            display: flex !important;
            flex-wrap: nowrap; /* Une seule ligne ! */
            gap: 3px;
            margin: 10px 0;
            width: 100%;
            overflow-x: auto; /* Scroll horizontal si vraiment trop large */
            -webkit-overflow-scrolling: touch;
        }
        
        .health-badge {
            display: inline-block !important;
            padding: 4px 8px; /* Réduit de 10px à 8px */
            border-radius: 12px;
            font-size: 0.7em; /* Réduit de 0.8em à 0.7em */
            font-weight: 700;
            color: white;
            text-transform: uppercase;
            visibility: visible !important;
            opacity: 1 !important;
            white-space: nowrap; /* Empêche le texte de passer à la ligne */
            flex-shrink: 0; /* Empêche les badges de rétrécir */
        }
        
        /* Nutri-Score */
        .nutri-a { background: #038141; }
        .nutri-b { background: #85bb2f; }
        .nutri-c { background: #fecb02; color: #333; }
        .nutri-d { background: #ee8100; }
        .nutri-e { background: #e63e11; }
        
        /* Eco-Score */
        .eco-a { background: #038141; }
        .eco-b { background: #85bb2f; }
        .eco-c { background: #fecb02; color: #333; }
        .eco-d { background: #ee8100; }
        .eco-e { background: #e63e11; }
        .eco-f { background: #b91c1c; } /* Rouge très foncé - pire que E */
        
        /* NOVA Group */
        .nova-1 { background: #038141; }
        .nova-2 { background: #85bb2f; }
        .nova-3 { background: #ee8100; }
        .nova-4 { background: #e63e11; }
        
        /* Additives */
        .additives-badge {
            background: #6b7280;
        }
        .additives-high {
            background: #ef4444;
        }
        
        /* Badge inconnu */
        .health-badge-unknown {
            background: #d1d5db !important;
            color: #6b7280 !important;
            display: inline-block !important;
            visibility: visible !important;
        }
        
        .alert-banner {
            background: linear-gradient(135deg, #f59e0b 0%, #ef4444 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: none;
            animation: slideDown 0.3s ease;
        }
        
        .alert-banner.show {
            display: block;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.6;
            }
        }
        
        .alert-banner-title {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        .alert-banner-text {
            font-size: 0.95em;
            color: white;
            line-height: 1.6;
            display: block;  /* Au lieu de inline */
            white-space: normal;  /* Permettre le retour à la ligne */
            word-wrap: break-word;
        }
        
        .alert-banner-btn {
            background: white;
            color: #f59e0b;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.95em;
        }
        
        .notification-prompt {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            text-align: center;
            display: none;
            animation: slideDown 0.3s ease;
        }
        
        .notification-prompt.show {
            display: block;
        }
        
        .notification-prompt-title {
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }
        
        .notification-prompt-text {
            font-size: 0.95em;
            color: #666;
            margin-bottom: 15px;
        }
        
        .notification-prompt-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            font-size: 1em;
            margin: 5px;
        }
        
        .notification-prompt-btn-cancel {
            background: #e0e0e0;
            color: #666;
            padding: 12px 30px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            font-size: 1em;
            margin: 5px;
        }
        
        .btn-quantity {
            width: 40px;
            height: 40px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 8px;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn-quantity:active {
            background: #667eea;
            color: white;
        }
        
        .quantity-badge {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
            margin: 5px 5px 5px 0;
        }
        
        .renouveler-badge {
            display: inline-block;
            background: #e5e7eb;
            color: #6b7280;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
            margin: 5px 5px 5px 0;
            transition: all 0.2s;
            cursor: pointer;
            user-select: none;
        }
        
        .renouveler-badge.active {
            background: #f59e0b;
            color: white;
        }
        
        .renouveler-badge:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .renouveler-badge:active {
            transform: scale(0.95);
        }
        
        .quantity-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 15px 0;
            justify-content: center;
        }
        
        .quantity-controls button {
            width: 35px;
            height: 35px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .quantity-controls button:active {
            background: #667eea;
            color: white;
        }
        
        .quantity-controls .quantity-value {
            font-size: 1.3em;
            font-weight: bold;
            color: #667eea;
            min-width: 40px;
            text-align: center;
        }
        
        .stock-alert {
            background: #fee;
            border: 2px solid #ef4444;
            color: #ef4444;
            padding: 8px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9em;
            margin: 10px 0;
        }
        
        /* Liste de courses */
        .shopping-list-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            padding: 10px;  /* ✨ RÉDUIT de 20px à 10px */
            padding-top: max(env(safe-area-inset-top), 15px);  /* ✨ AJUSTÉ */
            padding-bottom: max(env(safe-area-inset-bottom), 10px);  /* ✨ AJOUTÉ pour le bas */
        }

        .shopping-list-content {
            background: white;
            border-radius: 20px;
            width: 100%;
            max-width: 600px;
            height: 96vh;  /* ✨ CHANGÉ : height au lieu de max-height */
            display: flex;
            flex-direction: column;
        }
        
        .shopping-list-modal.active {
            display: flex;
        }
        
        .shopping-list-content {
            background: white;
            border-radius: 20px;
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }
        
        .shopping-list-header {
            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
            color: white;
            padding: 20px;
            border-radius: 20px 20px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .shopping-list-header h2 {
            margin: 0;
            font-size: 1.5em;
        }
        
        .btn-close-shopping {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid white;
            color: white;
            font-size: 24px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .shopping-list-stats {
            padding: 20px;
            text-align: center;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .shopping-stat {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .shopping-stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #f97316;
        }
        
        .shopping-stat-label {
            font-size: 1em;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .shopping-list-items {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            min-height: 0;  /* ✨ IMPORTANT pour le flex scroll */
        }
        
        .shopping-item {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
        }
        
        .shopping-item:active {
            background: #e9ecef;
            transform: scale(0.98);
        }
        
        .shopping-item.checked {
            background: #d1fae5;
            opacity: 0.6;
        }
        
        .shopping-checkbox {
            font-size: 28px;
            flex-shrink: 0;
        }
        
        .shopping-item-content {
            flex: 1;
        }
        
        .shopping-item-name {
            font-weight: 600;
            font-size: 1.1em;
            margin-bottom: 5px;
        }
        
        .shopping-item.checked .shopping-item-name {
            text-decoration: line-through;
        }
        
        .shopping-item-reason {
            font-size: 0.85em;
            color: #666;
        }
        
        .shopping-list-actions {
            padding: 20px;
            border-top: 2px solid #f0f0f0;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .shopping-list-actions .btn {
            flex: 1;
            min-width: 120px;
        }
        
        /* Suggestions de recettes */
        .recipes-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            padding: 20px;
            padding-top: max(env(safe-area-inset-top), 25px);  /* ✨ AJOUTÉ */
        }
        
        .recipes-modal.active {
            display: flex;
        }
        
        .recipes-content {
            background: white;
            border-radius: 20px;
            width: 100%;
            max-width: 800px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }
        
        .recipes-header {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
            padding: 20px;
            border-radius: 20px 20px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .recipes-header h2 {
            margin: 0;
            font-size: 1.5em;
        }
        
        .btn-close-recipes {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid white;
            color: white;
            font-size: 24px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .recipes-stats {
            padding: 15px 20px;
            text-align: center;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .recipes-stat-label {
            font-size: 0.95em;
            color: #666;
            font-weight: 600;
        }
        
        .recipes-list-items {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        
        .recipe-card {
            background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid #e9d5ff;
        }
        
        .recipe-card:active {
            transform: scale(0.98);
            background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%);
        }
        
        .recipe-card-header {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .recipe-icon {
            font-size: 3em;
            flex-shrink: 0;
        }
        
        .recipe-card-title {
            flex: 1;
        }
        
        .recipe-name {
            font-size: 1.3em;
            font-weight: bold;
            color: #7c3aed;
            margin-bottom: 5px;
        }
        
        .recipe-time {
            font-size: 0.9em;
            color: #666;
        }
        
        .recipe-ingredients-preview {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 10px;
        }
        
        .recipe-match {
            display: inline-block;
            background: #10b981;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }
        
        .recipes-actions {
            padding: 20px;
            border-top: 2px solid #f0f0f0;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .recipes-actions .btn {
            width: 100%;
        }
        
        .recipes-actions .btn:last-child {
            grid-column: 1 / -1;
        }
        
        /* Détail de recette */
        .recipe-detail-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            z-index: 4000;
        }
        
        .recipe-detail-modal.active {
            display: block;
        }
        
        .recipe-detail-content {
            background: white;
            height: 100%;
            overflow-y: auto;
        }
        
        .recipe-detail-header {
            position: sticky;
            top: 0;
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
        }
        
        .btn-back {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid white;
            color: white;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }
        
        .btn-close-recipe-detail {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid white;
            color: white;
            font-size: 24px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .recipe-detail-body {
            padding: 30px 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .recipe-detail-title {
            font-size: 2em;
            color: #7c3aed;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .recipe-detail-icon {
            font-size: 4em;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .recipe-detail-meta {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
        }
        
        .recipe-meta-item {
            text-align: center;
        }
        
        .recipe-meta-label {
            font-size: 0.85em;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .recipe-meta-value {
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
        }
        
        .recipe-section {
            margin-bottom: 30px;
        }
        
        .recipe-section-title {
            font-size: 1.5em;
            color: #7c3aed;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 3px solid #e9d5ff;
        }
        
        .recipe-ingredients-list {
            list-style: none;
            padding: 0;
        }
        
        .recipe-ingredient-item {
            padding: 12px;
            margin-bottom: 8px;
            background: #faf5ff;
            border-radius: 8px;
            border-left: 4px solid #8b5cf6;
        }
        
        .recipe-ingredient-available {
            background: #d1fae5;
            border-left-color: #10b981;
        }
        
        .recipe-steps-list {
            list-style: none;
            padding: 0;
            counter-reset: step-counter;
        }
        
        .recipe-step-item {
            padding: 20px;
            margin-bottom: 15px;
            background: #f8f9fa;
            border-radius: 12px;
            position: relative;
            padding-left: 70px;
            counter-increment: step-counter;
        }
        
        .recipe-step-item::before {
            content: counter(step-counter);
            position: absolute;
            left: 20px;
            top: 20px;
            width: 35px;
            height: 35px;
            background: #8b5cf6;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.1em;
        }
        
        /* Création de recette */
        .create-recipe-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: flex-start;  /* ✅ En haut */
            justify-content: center;
            z-index: 5000;
            padding: 10px;
            padding-top: max(40px, env(safe-area-inset-top) + 20px);  /* ✅ Plus d'espace en haut */
            padding-bottom: max(20px, env(safe-area-inset-bottom));
        }
        
        .create-recipe-modal.active {
            display: block;
        }
        
        .create-recipe-content {
            background: white;
            border-radius: 20px;
            width: calc(100vw - 20px);
            max-width: 95vw;
            max-height: calc(100vh - env(safe-area-inset-top) - env(safe-area-inset-bottom) - 40px);            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .create-recipe-header {
            position: sticky;
            top: 0;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
        }
        
        .create-recipe-header h2 {
            margin: 0;
            font-size: 1.3em;
        }
        
        .btn-close-create-recipe {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid white;
            color: white;
            font-size: 24px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .create-recipe-body {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;  /* ✅ Ajouter */
            padding: 15px;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }
        
        .emoji-picker {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 8px;
            margin: 10px 0;
        }
        
        .emoji-btn {
            font-size: 2em;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .emoji-btn:active {
            transform: scale(0.9);
            background: #f0f0f0;
        }
        
        .emoji-btn.selected {
            border-color: #10b981;
            background: #d1fae5;
        }
        
        .ingredient-field, .step-field {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }
        
        .ingredient-field input, .step-field textarea {
            flex: 1;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            font-family: inherit;
        }
        
        .step-field textarea {
            min-height: 60px;
            resize: vertical;
        }
        
        .btn-remove-field {
            background: #ef4444;
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            flex-shrink: 0;
        }
        
        .create-recipe-actions {
            display: flex;
            gap: 10px;
            margin-top: 30px;
        }
        
        .create-recipe-actions .btn {
            flex: 1;
        }
        
        .user-recipe-badge {
            display: inline-block;
            background: #10b981;
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .recipe-actions-bar {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #f0f0f0;
        }
    </style>
    <!-- Bibliothèque SheetJS pour Excel -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <button class="language-selector" onclick="toggleLanguage()" id="langBtn">
                <span id="langFlag">🇫🇷</span>
                <span id="langCode">FR</span>
            </button>
            <h1 data-i18n="app.title">🧊 Frigo Manager</h1>
            <p data-i18n="app.subtitle">Scanner de code-barres intelligent</p>
            <button class="settings-btn" onclick="toggleSettings()">⚙️</button>
        </div>

        <div id="settingsMenu" class="settings-menu">
            <div class="settings-content">
                <h3 style="margin-top: 0; color: #667eea;">⚙️ Paramètres</h3>
                
                <div class="settings-section">
                    <h4>💾 Sauvegarde</h4>
                    <button class="btn" onclick="exportExcel()" style="background: #059669; margin-bottom: 10px;">📊 Exporter Excel</button>
                    <button class="btn" onclick="document.getElementById('importExcel').click()" style="background: #2563eb; margin-bottom: 10px;">📊 Importer Excel</button>
                    <input type="file" id="importExcel" accept=".xlsx,.xls" style="display: none;" onchange="importExcel(event)">
                    <p style="font-size: 0.85em; color: #666; margin: 10px 0;">Sauvegardez vos données ou transférez-les vers un autre appareil</p>
                </div>
                
                <div class="settings-section">
                    <h4>📊 Informations santé</h4>
                    <button class="btn" onclick="showHealthGuide()" style="background: #059669; margin-bottom: 10px;">📚 Comprendre les scores</button>
                    <button class="btn" onclick="showDurationTable()" style="background: #0ea5e9; margin-bottom: 10px;">📋 Table des durées</button>
                    <p style="font-size: 0.85em; color: #666; margin: 10px 0;">Nutri-Score, NOVA, Additifs, Eco-Score expliqués</p>
                </div>
                
                <div class="settings-section">
                    <h4>🗑️ Données</h4>
                    <button class="btn" onclick="confirmDeleteAll()" style="background: #ef4444;">Supprimer toutes les données</button>
                    <p style="font-size: 0.85em; color: #666; margin: 10px 0;">Attention : cette action est irréversible</p>
                </div>
                
                <div class="settings-section" style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border: 2px solid #0ea5e9;">
                    <h4 style="color: #0369a1;">ℹ️ À propos</h4>
                    <div style="text-align: center; margin: 15px 0;">
                        <div style="font-size: 3em; margin-bottom: 10px;">🧊</div>
                        <div style="font-size: 1.2em; font-weight: bold; color: #0369a1; margin-bottom: 5px;">Frigo Manager</div>
                        <div style="font-size: 0.9em; color: #64748b; margin-bottom: 10px;" id="versionDisplay">Version 2.1.0</div>
                        <button class="btn" onclick="showChangelog()" style="background: #0ea5e9; padding: 8px 16px; font-size: 0.85em; margin-bottom: 10px;">🎉 Quoi de neuf ?</button>
                    </div>
                    <div style="background: white; padding: 15px; border-radius: 10px; margin: 10px 0;">
                        <div style="font-size: 0.95em; color: #334155; margin-bottom: 8px;">
                            <strong>👨‍💻 Développé par :</strong><br>
                            <span style="color: #0369a1; font-weight: 600;">Michel Garlandat</span>
                        </div>
                        <div style="font-size: 0.85em; color: #64748b; margin-top: 12px; padding-top: 12px; border-top: 1px solid #e2e8f0;">
                            🤖 Réalisé à l'aide d'<strong>Anthropic Claude</strong>
                        </div>
                    </div>
                    <div style="font-size: 0.75em; color: #64748b; text-align: center; margin-top: 15px;">
                        © 2026 Michel Garlandat<br>
                        Tous droits réservés
                    </div>
                </div>
                
                <button class="btn" onclick="toggleSettings()" style="background: #ccc; color: #333; margin-top: 20px;">✕ Fermer</button>
            </div>
        </div>

        <div id="alertBanner" class="alert-banner"></div>
        
        <!-- Modal Guide Santé -->
        <div id="healthGuide" class="settings-menu">
            <div class="settings-content" style="max-width: 600px; max-height: 90vh; overflow-y: auto;">
                <h3 style="margin-top: 0; color: #667eea;">📚 Comprendre les Scores de Santé</h3>
                
                <!-- Nutri-Score -->
                <div class="settings-section">
                    <h4 style="color: #038141;">🥗 Nutri-Score</h4>
                    <p style="font-size: 0.9em; margin-bottom: 15px;">Évalue la qualité nutritionnelle globale</p>
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="health-badge nutri-a" style="width: 50px; text-align: center;">A</div>
                            <span style="font-size: 0.9em;">Excellente qualité nutritionnelle</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="health-badge nutri-b" style="width: 50px; text-align: center;">B</div>
                            <span style="font-size: 0.9em;">Bonne qualité nutritionnelle</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="health-badge nutri-c" style="width: 50px; text-align: center;">C</div>
                            <span style="font-size: 0.9em;">Qualité nutritionnelle moyenne</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="health-badge nutri-d" style="width: 50px; text-align: center;">D</div>
                            <span style="font-size: 0.9em;">Mauvaise qualité nutritionnelle</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="health-badge nutri-e" style="width: 50px; text-align: center;">E</div>
                            <span style="font-size: 0.9em;">Très mauvaise qualité nutritionnelle</span>
                        </div>
                    </div>
                    <p style="font-size: 0.85em; color: #666; margin-top: 10px; background: #f3f4f6; padding: 10px; border-radius: 8px;">
                        <strong>💡 Astuce :</strong> Privilégiez les produits A et B. Le Nutri-Score prend en compte les nutriments positifs (fibres, protéines, fruits/légumes) et négatifs (sucres, graisses saturées, sel, calories).
                    </p>
                </div>
                
                <!-- NOVA -->
                <div class="settings-section">
                    <h4 style="color: #038141;">🔬 NOVA Group</h4>
                    <p style="font-size: 0.9em; margin-bottom: 15px;">Niveau de transformation du produit</p>
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="health-badge nova-1" style="width: 50px; text-align: center;">1</div>
                            <span style="font-size: 0.9em;">Aliments bruts (fruits, légumes, viande)</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="health-badge nova-2" style="width: 50px; text-align: center;">2</div>
                            <span style="font-size: 0.9em;">Ingrédients culinaires (huile, beurre)</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="health-badge nova-3" style="width: 50px; text-align: center;">3</div>
                            <span style="font-size: 0.9em;">Aliments transformés (conserves, pain)</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="health-badge nova-4" style="width: 50px; text-align: center;">4</div>
                            <span style="font-size: 0.9em;">Ultra-transformés (sodas, plats préparés)</span>
                        </div>
                    </div>
                    <p style="font-size: 0.85em; color: #666; margin-top: 10px; background: #f3f4f6; padding: 10px; border-radius: 8px;">
                        <strong>💡 Astuce :</strong> Limitez les produits NOVA 4. Les aliments ultra-transformés contiennent souvent beaucoup d'additifs et peu de nutriments essentiels.
                    </p>
                </div>
                
                <!-- Additifs -->
                <div class="settings-section">
                    <h4 style="color: #6b7280;">⚗️ Additifs</h4>
                    <p style="font-size: 0.9em; margin-bottom: 15px;">Nombre d'additifs dans le produit</p>
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="health-badge" style="background: #038141; width: 80px; text-align: center;">0</div>
                            <span style="font-size: 0.9em;">Sans additif - Idéal</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="health-badge additives-badge" style="width: 80px; text-align: center;">1-5</div>
                            <span style="font-size: 0.9em;">Quelques additifs - Acceptable</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="health-badge additives-high" style="width: 80px; text-align: center;">6+</div>
                            <span style="font-size: 0.9em;">Beaucoup d'additifs - À limiter</span>
                        </div>
                    </div>
                    <p style="font-size: 0.85em; color: #666; margin-top: 10px; background: #f3f4f6; padding: 10px; border-radius: 8px;">
                        <strong>💡 Astuce :</strong> Les additifs (E100, E200, etc.) sont des colorants, conservateurs, émulsifiants... Tous ne sont pas dangereux, mais moins il y en a, mieux c'est !
                    </p>
                </div>
                
                <!-- Eco-Score -->
                <div class="settings-section">
                    <h4 style="color: #059669;">🌍 Eco-Score</h4>
                    <p style="font-size: 0.9em; margin-bottom: 15px;">Impact environnemental du produit</p>
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="health-badge eco-a" style="width: 50px; text-align: center;">A</div>
                            <span style="font-size: 0.9em;">Très faible impact environnemental</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="health-badge eco-b" style="width: 50px; text-align: center;">B</div>
                            <span style="font-size: 0.9em;">Faible impact environnemental</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="health-badge eco-c" style="width: 50px; text-align: center;">C</div>
                            <span style="font-size: 0.9em;">Impact environnemental moyen</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="health-badge eco-d" style="width: 50px; text-align: center;">D</div>
                            <span style="font-size: 0.9em;">Impact environnemental élevé</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="health-badge eco-e" style="width: 50px; text-align: center;">E</div>
                            <span style="font-size: 0.9em;">Très fort impact environnemental</span>
                        </div>
                    </div>
                    <p style="font-size: 0.85em; color: #666; margin-top: 10px; background: #f3f4f6; padding: 10px; border-radius: 8px;">
                        <strong>💡 Astuce :</strong> L'Eco-Score prend en compte les émissions CO2, le transport, l'emballage et l'origine des ingrédients. Favorisez les produits locaux et de saison !
                    </p>
                </div>
                
                <!-- Exemples -->
                <div class="settings-section" style="background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border: 2px solid #22c55e;">
                    <h4 style="color: #15803d;">✅ Exemples de Bons Produits</h4>
                    <div style="font-size: 0.9em; color: #166534;">
                        <div style="margin: 8px 0;">🍎 <strong>Pommes :</strong> Nutri A, NOVA 1, 0 additif</div>
                        <div style="margin: 8px 0;">🥕 <strong>Carottes :</strong> Nutri A, NOVA 1, 0 additif</div>
                        <div style="margin: 8px 0;">🥛 <strong>Yaourt nature :</strong> Nutri A, NOVA 1, 0 additif</div>
                        <div style="margin: 8px 0;">🍋 <strong>Lentilles :</strong> Nutri A, NOVA 1, 0 additif</div>
                    </div>
                </div>
                
                <div class="settings-section" style="background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%); border: 2px solid #ef4444;">
                    <h4 style="color: #b91c1c;">❌ Exemples à Limiter</h4>
                    <div style="font-size: 0.9em; color: #991b1b;">
                        <div style="margin: 8px 0;">🥤 <strong>Sodas :</strong> Nutri E, NOVA 4, 5+ additifs</div>
                        <div style="margin: 8px 0;">🍟 <strong>Chips :</strong> Nutri E, NOVA 4, 8+ additifs</div>
                        <div style="margin: 8px 0;">🍫 <strong>Barres chocolatées :</strong> Nutri E, NOVA 4, 10+ additifs</div>
                        <div style="margin: 8px 0;">🌭 <strong>Nuggets :</strong> Nutri E, NOVA 4, 12+ additifs</div>
                    </div>
                </div>
                
                <div style="background: #eff6ff; padding: 15px; border-radius: 10px; margin: 15px 0; border-left: 4px solid #3b82f6;">
                    <p style="font-size: 0.9em; color: #1e40af; margin: 0;">
                        <strong>ℹ️ Source des données :</strong> Open Food Facts - Base de données collaborative de 1,8 million de produits utilisée par Yuka et d'autres applications.
                    </p>
                </div>
                
                <button class="btn" onclick="closeHealthGuide()" style="background: #667eea; color: white; margin-top: 20px; width: 100%;">✓ J'ai compris</button>
            </div>
        </div>
        
        
        <!-- Modal Table des Durées -->
        <div id="durationTableModal" class="settings-menu">
            <div class="settings-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
                <h3 style="margin-top: 0; color: #667eea;">📋 Table des Durées de Conservation</h3>
                
                <p style="font-size: 0.95em; color: #64748b; margin-bottom: 20px; background: #eff6ff; padding: 15px; border-radius: 10px; border-left: 4px solid #3b82f6;">
                    <strong>ℹ️ Comment ça fonctionne :</strong><br>
                    Lorsque vous ajoutez un produit, l'application calcule automatiquement la date de péremption selon sa <strong>catégorie</strong> et son <strong>emplacement</strong>. Vous pouvez toujours modifier cette date manuellement.
                </p>
                
                <!-- Fruits -->
                <div class="settings-section">
                    <h4 style="color: #059669;">🍎 Fruits</h4>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.9em;">
                            <thead>
                                <tr style="background: #f3f4f6;">
                                    <th style="padding: 10px; text-align: left; border: 1px solid #e5e7eb;">Emplacement</th>
                                    <th style="padding: 10px; text-align: center; border: 1px solid #e5e7eb;">Durée</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td style="padding: 8px; border: 1px solid #e5e7eb;">🧊 Frigo</td><td style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">7 jours</td></tr>
                                <tr style="background: #f9fafb;"><td style="padding: 8px; border: 1px solid #e5e7eb;">❄️ Congélateur</td><td style="padding: 8px; text-align: center; border: 1px solid #e5e7eb; font-weight: bold; color: #0284c7;">1 an (365 jours)</td></tr>
                                <tr><td style="padding: 8px; border: 1px solid #e5e7eb;">🚪 Placard</td><td style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">3 jours</td></tr>
                                <tr style="background: #f9fafb;"><td style="padding: 8px; border: 1px solid #e5e7eb;">🍷 Cave</td><td style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">14 jours</td></tr>
                                <tr><td style="padding: 8px; border: 1px solid #e5e7eb;">🧺 Corbeille</td><td style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">5 jours</td></tr>
                                <tr style="background: #f9fafb;"><td style="padding: 8px; border: 1px solid #e5e7eb;">📍 Autre</td><td style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">7 jours</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Légumes -->
                <div class="settings-section">
                    <h4 style="color: #059669;">🥕 Légumes</h4>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.9em;">
                            <thead>
                                <tr style="background: #f3f4f6;">
                                    <th style="padding: 10px; text-align: left; border: 1px solid #e5e7eb;">Emplacement</th>
                                    <th style="padding: 10px; text-align: center; border: 1px solid #e5e7eb;">Durée</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td style="padding: 8px; border: 1px solid #e5e7eb;">🧊 Frigo</td><td style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">7 jours</td></tr>
                                <tr style="background: #f9fafb;"><td style="padding: 8px; border: 1px solid #e5e7eb;">❄️ Congélateur</td><td style="padding: 8px; text-align: center; border: 1px solid #e5e7eb; font-weight: bold; color: #0284c7;">1 an (365 jours)</td></tr>
                                <tr><td style="padding: 8px; border: 1px solid #e5e7eb;">🚪 Placard</td><td style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">5 jours</td></tr>
                                <tr style="background: #f9fafb;"><td style="padding: 8px; border: 1px solid #e5e7eb;">🍷 Cave</td><td style="padding: 8px; text-align: center; border: 1px solid #e5e7eb; font-weight: bold; color: #059669;">1 mois (30 jours)</td></tr>
                                <tr><td style="padding: 8px; border: 1px solid #e5e7eb;">🧺 Corbeille</td><td style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">5 jours</td></tr>
                                <tr style="background: #f9fafb;"><td style="padding: 8px; border: 1px solid #e5e7eb;">📍 Autre</td><td style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">7 jours</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Viande -->
                <div class="settings-section">
                    <h4 style="color: #dc2626;">🥩 Viande</h4>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.9em;">
                            <thead>
                                <tr style="background: #f3f4f6;">
                                    <th style="padding: 10px; text-align: left; border: 1px solid #e5e7eb;">Emplacement</th>
                                    <th style="padding: 10px; text-align: center; border: 1px solid #e5e7eb;">Durée</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td style="padding: 8px; border: 1px solid #e5e7eb;">🧊 Frigo</td><td style="padding: 8px; text-align: center; border: 1px solid #e5e7eb; color: #dc2626; font-weight: bold;">3 jours ⚠️</td></tr>
                                <tr style="background: #f9fafb;"><td style="padding: 8px; border: 1px solid #e5e7eb;">❄️ Congélateur</td><td style="padding: 8px; text-align: center; border: 1px solid #e5e7eb; font-weight: bold; color: #0284c7;">6 mois (180 jours)</td></tr>
                                <tr><td style="padding: 8px; border: 1px solid #e5e7eb;">🚪 Placard</td><td style="padding: 8px; text-align: center; border: 1px solid #e5e7eb; color: #dc2626; font-weight: bold;">1 jour ⚠️</td></tr>
                                <tr style="background: #f9fafb;"><td style="padding: 8px; border: 1px solid #e5e7eb;">🍷 Cave</td><td style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">2 jours</td></tr>
                                <tr><td style="padding: 8px; border: 1px solid #e5e7eb;">🧺 Corbeille</td><td style="padding: 8px; text-align: center; border: 1px solid #e5e7eb; color: #dc2626; font-weight: bold;">1 jour ⚠️</td></tr>
                                <tr style="background: #f9fafb;"><td style="padding: 8px; border: 1px solid #e5e7eb;">📍 Autre</td><td style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">2 jours</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Poisson -->
                <div class="settings-section">
                    <h4 style="color: #0284c7;">🐟 Poisson</h4>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.9em;">
                            <thead>
                                <tr style="background: #f3f4f6;">
                                    <th style="padding: 10px; text-align: left; border: 1px solid #e5e7eb;">Emplacement</th>
                                    <th style="padding: 10px; text-align: center; border: 1px solid #e5e7eb;">Durée</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td style="padding: 8px; border: 1px solid #e5e7eb;">🧊 Frigo</td><td style="padding: 8px; text-align: center; border: 1px solid #e5e7eb; color: #dc2626; font-weight: bold;">2 jours ⚠️</td></tr>
                                <tr style="background: #f9fafb;"><td style="padding: 8px; border: 1px solid #e5e7eb;">❄️ Congélateur</td><td style="padding: 8px; text-align: center; border: 1px solid #e5e7eb; font-weight: bold; color: #0284c7;">3 mois (90 jours)</td></tr>
                                <tr><td style="padding: 8px; border: 1px solid #e5e7eb;">🚪 Placard</td><td style="padding: 8px; text-align: center; border: 1px solid #e5e7eb; color: #dc2626; font-weight: bold;">1 jour ⚠️</td></tr>
                                <tr style="background: #f9fafb;"><td style="padding: 8px; border: 1px solid #e5e7eb;">🍷 Cave</td><td style="padding: 8px; text-align: center; border: 1px solid #e5e7eb; color: #dc2626; font-weight: bold;">1 jour ⚠️</td></tr>
                                <tr><td style="padding: 8px; border: 1px solid #e5e7eb;">🧺 Corbeille</td><td style="padding: 8px; text-align: center; border: 1px solid #e5e7eb; color: #dc2626; font-weight: bold;">1 jour ⚠️</td></tr>
                                <tr style="background: #f9fafb;"><td style="padding: 8px; border: 1px solid #e5e7eb;">📍 Autre</td><td style="padding: 8px; text-align: center; border: 1px solid #e5e7eb; color: #dc2626; font-weight: bold;">1 jour ⚠️</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Produits laitiers -->
                <div class="settings-section">
                    <h4 style="color: #0ea5e9;">🥛 Produits laitiers</h4>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.9em;">
                            <thead>
                                <tr style="background: #f3f4f6;">
                                    <th style="padding: 10px; text-align: left; border: 1px solid #e5e7eb;">Emplacement</th>
                                    <th style="padding: 10px; text-align: center; border: 1px solid #e5e7eb;">Durée</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td style="padding: 8px; border: 1px solid #e5e7eb;">🧊 Frigo</td><td style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">7 jours</td></tr>
                                <tr style="background: #f9fafb;"><td style="padding: 8px; border: 1px solid #e5e7eb;">❄️ Congélateur</td><td style="padding: 8px; text-align: center; border: 1px solid #e5e7eb; font-weight: bold; color: #0284c7;">3 mois (90 jours)</td></tr>
                                <tr><td style="padding: 8px; border: 1px solid #e5e7eb;">🚪 Placard</td><td style="padding: 8px; text-align: center; border: 1px solid #e5e7eb; color: #dc2626; font-weight: bold;">1 jour ⚠️</td></tr>
                                <tr style="background: #f9fafb;"><td style="padding: 8px; border: 1px solid #e5e7eb;">🍷 Cave</td><td style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">3 jours</td></tr>
                                <tr><td style="padding: 8px; border: 1px solid #e5e7eb;">🧺 Corbeille</td><td style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">3 jours</td></tr>
                                <tr style="background: #f9fafb;"><td style="padding: 8px; border: 1px solid #e5e7eb;">📍 Autre</td><td style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">5 jours</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Viennoiseries -->
                <div class="settings-section">
                    <h4 style="color: #f59e0b;">🥐 Viennoiseries</h4>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.9em;">
                            <thead>
                                <tr style="background: #f3f4f6;">
                                    <th style="padding: 10px; text-align: left; border: 1px solid #e5e7eb;">Emplacement</th>
                                    <th style="padding: 10px; text-align: center; border: 1px solid #e5e7eb;">Durée</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td style="padding: 8px; border: 1px solid #e5e7eb;">🧊 Frigo</td><td style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">5 jours</td></tr>
                                <tr style="background: #f9fafb;"><td style="padding: 8px; border: 1px solid #e5e7eb;">❄️ Congélateur</td><td style="padding: 8px; text-align: center; border: 1px solid #e5e7eb; font-weight: bold; color: #0284c7;">3 mois (90 jours)</td></tr>
                                <tr><td style="padding: 8px; border: 1px solid #e5e7eb;">🚪 Placard</td><td style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">3 jours</td></tr>
                                <tr style="background: #f9fafb;"><td style="padding: 8px; border: 1px solid #e5e7eb;">🍷 Cave</td><td style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">3 jours</td></tr>
                                <tr><td style="padding: 8px; border: 1px solid #e5e7eb;">🧺 Corbeille</td><td style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">3 jours</td></tr>
                                <tr style="background: #f9fafb;"><td style="padding: 8px; border: 1px solid #e5e7eb;">📍 Autre</td><td style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">3 jours</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Conserves -->
                <div class="settings-section">
                    <h4 style="color: #6b7280;">🥫 Conserves</h4>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.9em;">
                            <thead>
                                <tr style="background: #f3f4f6;">
                                    <th style="padding: 10px; text-align: left; border: 1px solid #e5e7eb;">Emplacement</th>
                                    <th style="padding: 10px; text-align: center; border: 1px solid #e5e7eb;">Durée</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td style="padding: 8px; border: 1px solid #e5e7eb;">🧊 Frigo</td><td style="padding: 8px; text-align: center; border: 1px solid #e5e7eb; font-weight: bold; color: #059669;">6 mois (180 jours)</td></tr>
                                <tr style="background: #f9fafb;"><td style="padding: 8px; border: 1px solid #e5e7eb;">❄️ Congélateur</td><td style="padding: 8px; text-align: center; border: 1px solid #e5e7eb; font-weight: bold; color: #0284c7;">2 ans (730 jours)</td></tr>
                                <tr><td style="padding: 8px; border: 1px solid #e5e7eb;">🚪 Placard</td><td style="padding: 8px; text-align: center; border: 1px solid #e5e7eb; font-weight: bold; color: #059669;">2 ans (730 jours)</td></tr>
                                <tr style="background: #f9fafb;"><td style="padding: 8px; border: 1px solid #e5e7eb;">🍷 Cave</td><td style="padding: 8px; text-align: center; border: 1px solid #e5e7eb; font-weight: bold; color: #059669;">3 ans (1095 jours)</td></tr>
                                <tr><td style="padding: 8px; border: 1px solid #e5e7eb;">🧺 Corbeille</td><td style="padding: 8px; text-align: center; border: 1px solid #e5e7eb; font-weight: bold; color: #059669;">1 an (365 jours)</td></tr>
                                <tr style="background: #f9fafb;"><td style="padding: 8px; border: 1px solid #e5e7eb;">📍 Autre</td><td style="padding: 8px; text-align: center; border: 1px solid #e5e7eb; font-weight: bold; color: #059669;">1 an (365 jours)</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Boissons -->
                <div class="settings-section">
                    <h4 style="color: #8b5cf6;">🥤 Boissons</h4>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.9em;">
                            <thead>
                                <tr style="background: #f3f4f6;">
                                    <th style="padding: 10px; text-align: left; border: 1px solid #e5e7eb;">Emplacement</th>
                                    <th style="padding: 10px; text-align: center; border: 1px solid #e5e7eb;">Durée</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td style="padding: 8px; border: 1px solid #e5e7eb;">🧊 Frigo</td><td style="padding: 8px; text-align: center; border: 1px solid #e5e7eb; font-weight: bold; color: #059669;">3 mois (90 jours)</td></tr>
                                <tr style="background: #f9fafb;"><td style="padding: 8px; border: 1px solid #e5e7eb;">❄️ Congélateur</td><td style="padding: 8px; text-align: center; border: 1px solid #e5e7eb; font-weight: bold; color: #0284c7;">6 mois (180 jours)</td></tr>
                                <tr><td style="padding: 8px; border: 1px solid #e5e7eb;">🚪 Placard</td><td style="padding: 8px; text-align: center; border: 1px solid #e5e7eb; font-weight: bold; color: #059669;">1 an (365 jours)</td></tr>
                                <tr style="background: #f9fafb;"><td style="padding: 8px; border: 1px solid #e5e7eb;">🍷 Cave</td><td style="padding: 8px; text-align: center; border: 1px solid #e5e7eb; font-weight: bold; color: #059669;">2 ans (730 jours)</td></tr>
                                <tr><td style="padding: 8px; border: 1px solid #e5e7eb;">🧺 Corbeille</td><td style="padding: 8px; text-align: center; border: 1px solid #e5e7eb; font-weight: bold; color: #059669;">6 mois (180 jours)</td></tr>
                                <tr style="background: #f9fafb;"><td style="padding: 8px; border: 1px solid #e5e7eb;">📍 Autre</td><td style="padding: 8px; text-align: center; border: 1px solid #e5e7eb; font-weight: bold; color: #059669;">1 an (365 jours)</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Autre -->
                <div class="settings-section">
                    <h4 style="color: #6b7280;">📦 Autre</h4>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.9em;">
                            <thead>
                                <tr style="background: #f3f4f6;">
                                    <th style="padding: 10px; text-align: left; border: 1px solid #e5e7eb;">Emplacement</th>
                                    <th style="padding: 10px; text-align: center; border: 1px solid #e5e7eb;">Durée</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td style="padding: 8px; border: 1px solid #e5e7eb;">🧊 Frigo</td><td style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">14 jours</td></tr>
                                <tr style="background: #f9fafb;"><td style="padding: 8px; border: 1px solid #e5e7eb;">❄️ Congélateur</td><td style="padding: 8px; text-align: center; border: 1px solid #e5e7eb; font-weight: bold; color: #0284c7;">6 mois (180 jours)</td></tr>
                                <tr><td style="padding: 8px; border: 1px solid #e5e7eb;">🚪 Placard</td><td style="padding: 8px; text-align: center; border: 1px solid #e5e7eb; font-weight: bold; color: #059669;">3 mois (90 jours)</td></tr>
                                <tr style="background: #f9fafb;"><td style="padding: 8px; border: 1px solid #e5e7eb;">🍷 Cave</td><td style="padding: 8px; text-align: center; border: 1px solid #e5e7eb; font-weight: bold; color: #059669;">6 mois (180 jours)</td></tr>
                                <tr><td style="padding: 8px; border: 1px solid #e5e7eb;">🧺 Corbeille</td><td style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">14 jours</td></tr>
                                <tr style="background: #f9fafb;"><td style="padding: 8px; border: 1px solid #e5e7eb;">📍 Autre</td><td style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">30 jours</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div style="background: #fef3c7; padding: 15px; border-radius: 10px; margin: 15px 0; border-left: 4px solid #f59e0b;">
                    <p style="font-size: 0.9em; color: #78350f; margin: 0;">
                        <strong>⚠️ Important :</strong> Ces durées sont des recommandations moyennes. Vérifiez toujours l'aspect, l'odeur et la texture du produit avant consommation. En cas de doute, jetez le produit.
                    </p>
                </div>
                
                <div style="background: #dcfce7; padding: 15px; border-radius: 10px; margin: 15px 0; border-left: 4px solid #059669;">
                    <p style="font-size: 0.9em; color: #166534; margin: 0;">
                        <strong>💡 Astuce :</strong> Le congélateur ❄️ permet de conserver presque tous les aliments beaucoup plus longtemps. N'hésitez pas à congeler ce que vous ne consommerez pas rapidement !
                    </p>
                </div>
                
                <button class="btn" onclick="closeDurationTable()" style="background: #667eea; color: white; margin-top: 20px; width: 100%;">✓ J'ai compris</button>
            </div>
        </div>
        
        <!-- Modal Changelog "Quoi de neuf" -->
        <div id="changelogModal" class="settings-menu">
            <div class="settings-content" style="max-width: 600px; max-height: 90vh; overflow-y: auto; padding-top: max(30px, env(safe-area-inset-top) + 20px);" id="changelogContent">
                <!-- Le contenu sera généré dynamiquement par JavaScript -->
            </div>
        </div>
        
        <div id="notificationPrompt" class="notification-prompt" style="display: none;">
            <div class="notification-prompt-content">
                <div style="font-size: 2em; margin-bottom: 10px;">🔔</div>
                <div class="notification-prompt-title">Activer les notifications</div>
                <div class="notification-prompt-text">Recevez des alertes quand vos produits arrivent à expiration</div>
                <button class="notification-prompt-btn" id="btnEnableNotifications">✓ Activer</button>
                <button class="notification-prompt-btn-cancel" id="btnCancelNotifications">Plus tard</button>
            </div>
        </div>

        <div id="stats" class="stats">
            <div class="stat-card">
                <div class="number">0</div>
                <div class="label">Produits</div>
            </div>
            <div class="stat-card">
                <div class="number orange">0</div>
                <div class="label">Urgents</div>
            </div>
            <div class="stat-card">
                <div class="number red">0</div>
                <div class="label">Périmés</div>
            </div>
        </div>
        
        <div id="actions" class="actions">
            <button class="btn btn-scan" id="btnScan">📷 Scanner un code-barres</button>
            <button class="btn btn-manual" id="btnManual">✍️ Saisie manuelle</button>
            <button class="btn" id="btnShoppingList" onclick="openShoppingList()" style="background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);">🛒 Liste de courses</button>
            <button class="btn" id="btnRecipes" onclick="openRecipes()" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">👨‍🍳 Suggestions de recettes</button>
        </div>

        <div id="recipesModal" class="recipes-modal">
            <div class="recipes-content">
                <div class="recipes-header">
                    <h2>👨‍🍳 Suggestions de recettes</h2>
                    <button class="btn-close-recipes" onclick="closeRecipes()">✕</button>
                </div>
                
                <div class="recipes-stats">
                    <div class="recipes-stat">
                        <span class="recipes-stat-label">Avec vos ingrédients disponibles</span>
                    </div>
                    <button class="btn" onclick="openCreateRecipe()" style="background: #10b981; margin-top: 10px;">➕ Créer une recette</button>
                </div>
                
                <div id="recipesListItems" class="recipes-list-items">
                    <!-- Les recettes seront ajoutées ici -->
                </div>
                
                <div class="recipes-actions">
                    <button class="btn" onclick="exportRecipesCSV()" style="background: #10b981;">📤 Exporter recettes CSV</button>
                    <button class="btn" onclick="document.getElementById('importRecipesCSV').click()" style="background: #3b82f6;">📥 Importer recettes CSV</button>
                    <input type="file" id="importRecipesCSV" accept=".csv" style="display: none;" onchange="importRecipesCSV(event)">
                    <!-- button class="btn" onclick="cleanRecipes()" style="background: #ef4444;">🗑️ Nettoyer doublons</button> -->
                    <button class="btn" onclick="closeRecipes()" style="background: #6b7280;">✕ Fermer</button>
                </div>
            </div>
        </div>

        <div id="recipeDetailModal" class="recipe-detail-modal">
            <div class="recipe-detail-content">
                <div class="recipe-detail-header">
                    <button class="btn-back" onclick="closeRecipeDetail()">← Retour</button>
                    <button class="btn-close-recipe-detail" onclick="closeRecipeDetail(); closeRecipes();">✕</button>
                </div>
                <div id="recipeDetailBody" class="recipe-detail-body">
                    <!-- Le détail de la recette sera ajouté ici -->
                </div>
            </div>
        </div>

        <div id="createRecipeModal" class="create-recipe-modal">
            <div class="create-recipe-content">
                <div class="create-recipe-header">
                    <h2 id="createRecipeTitle">➕ Créer une recette</h2>
                    <button class="btn-close-create-recipe" onclick="closeCreateRecipe()">✕</button>
                </div>
                
                <div class="create-recipe-body">
                    <div class="form-group">
                        <label>Nom de la recette *</label>
                        <input type="text" id="recipeNameInput" placeholder="Ex: Gratin dauphinois" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;">
                    </div>
                    
                    <div class="form-group">
                        <label>Icône (emoji)</label>
                        <div class="emoji-picker">
                            <button type="button" class="emoji-btn" onclick="selectEmoji('🍳')">🍳</button>
                            <button type="button" class="emoji-btn" onclick="selectEmoji('🥗')">🥗</button>
                            <button type="button" class="emoji-btn" onclick="selectEmoji('🍝')">🍝</button>
                            <button type="button" class="emoji-btn" onclick="selectEmoji('🥪')">🥪</button>
                            <button type="button" class="emoji-btn" onclick="selectEmoji('🥤')">🥤</button>
                            <button type="button" class="emoji-btn" onclick="selectEmoji('🍚')">🍚</button>
                            <button type="button" class="emoji-btn" onclick="selectEmoji('🍗')">🍗</button>
                            <button type="button" class="emoji-btn" onclick="selectEmoji('🍲')">🍲</button>
                            <button type="button" class="emoji-btn" onclick="selectEmoji('🥖')">🥖</button>
                            <button type="button" class="emoji-btn" onclick="selectEmoji('🥄')">🥄</button>
                            <button type="button" class="emoji-btn" onclick="selectEmoji('🍕')">🍕</button>
                            <button type="button" class="emoji-btn" onclick="selectEmoji('🍔')">🍔</button>
                            <button type="button" class="emoji-btn" onclick="selectEmoji('🌮')">🌮</button>
                            <button type="button" class="emoji-btn" onclick="selectEmoji('🍛')">🍛</button>
                            <button type="button" class="emoji-btn" onclick="selectEmoji('🍜')">🍜</button>
                            <button type="button" class="emoji-btn" onclick="selectEmoji('🥘')">🥘</button>
                        </div>
                        <input type="hidden" id="recipeIconInput" value="🍳">
                        <div id="selectedEmoji" style="font-size: 3em; text-align: center; margin: 10px 0;">🍳</div>
                    </div>
                    
                    <div class="form-group" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                        <div>
                            <label>Temps</label>
                            <input type="text" id="recipeTimeInput" placeholder="Ex: 30 min" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px;">
                        </div>
                        <div>
                            <label>Difficulté</label>
                            <select id="recipeDifficultyInput" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px;">
                                <option>Très facile</option>
                                <option>Facile</option>
                                <option>Moyen</option>
                                <option>Difficile</option>
                            </select>
                        </div>
                        <div>
                            <label>Portions</label>
                            <input type="number" id="recipeServingsInput" value="2" min="1" max="20" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px;">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Ingrédients *</label>
                        <div id="ingredientsList"></div>
                        <button type="button" class="btn" onclick="addIngredientField()" style="background: #3b82f6; margin-top: 10px;">➕ Ajouter un ingrédient</button>
                    </div>
                    
                    <div class="form-group">
                        <label>Étapes de préparation *</label>
                        <div id="stepsList"></div>
                        <button type="button" class="btn" onclick="addStepField()" style="background: #3b82f6; margin-top: 10px;">➕ Ajouter une étape</button>
                    </div>
                    
                    <div class="create-recipe-actions">
                        <button class="btn" onclick="saveRecipe()" style="background: #10b981;">✓ Enregistrer</button>
                        <button class="btn" onclick="closeCreateRecipe()" style="background: #6b7280;">✕ Annuler</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="shoppingListModal" class="shopping-list-modal">
            <div class="shopping-list-content">
                <div class="shopping-list-header">
                    <h2>🛒 Liste de courses</h2>
                    <button class="btn-close-shopping" onclick="closeShoppingList()">✕</button>
                </div>
                
                <div class="shopping-list-stats">
                    <div class="shopping-stat">
                        <span class="shopping-stat-number" id="shoppingCount">0</span>
                        <span class="shopping-stat-label">produits</span>
                    </div>
                </div>
                
                <div id="shoppingListItems" class="shopping-list-items">
                    <!-- Les produits seront ajoutés ici -->
                </div>
                
                <div class="shopping-list-actions">
                    <button class="btn" onclick="exportShoppingListText()" style="background: #10b981;">📋 Copier la liste</button>
                    <button class="btn" onclick="exportToReminders()" style="background: #ef4444;">📲 Rappels</button>
                    <button class="btn" onclick="printShoppingList()" style="background: #3b82f6;">🖨️ Imprimer</button>
                    <button class="btn" onclick="closeShoppingList()" style="background: #6b7280;">✕ Fermer</button>
                </div>
            </div>
        </div>
        
        

        <div id="scanner" class="scanner">
            <div class="scanner-instructions">
                📷 Centrez le code-barres
            </div>
            <div id="scanner-container"></div>
            <div class="scanner-overlay">
                <div class="scanner-line"></div>
            </div>
            <div class="scanner-controls">
                <button class="btn-close-scanner" id="btnCloseScanner">✕ Fermer</button>
                <button class="btn-manual-entry" id="btnManualFromScanner">✍️ Saisie manuelle</button>
            </div>
        </div>

        <div id="loading" class="loading">
            <div class="spinner">🔍</div>
            <h2>Recherche du produit...</h2>
            <p id="loadingBarcode"></p>
        </div>

        <div id="form" class="form"></div>

        <!-- Zone de debug visible (iOS) -->
        <div id="debugZone" style="background: #fee; border: 2px solid #f00; padding: 10px; margin: 10px 0; border-radius: 8px; display: none;">
            <div style="font-weight: bold; color: #f00; margin-bottom: 5px;">🐛 DEBUG iOS</div>
            <div id="debugLog" style="font-size: 12px; font-family: monospace; color: #333;"></div>
        </div>

        <div class="search-container">
            <div class="search-wrapper">
                <input type="search" id="searchInput" class="search-input" 
                       placeholder="🔍 Rechercher..." 
                       autocomplete="off" 
                       autocorrect="off" 
                       autocapitalize="off" 
                       spellcheck="false"
                       inputmode="search">
                <button id="searchButton" class="search-btn" onclick="doSearch()">GO</button>
                <button id="clearSearch" class="clear-search-btn" style="display: none;" onclick="clearSearchNow()">✕</button>
            </div>
            <div id="searchResults" class="search-results-info" style="display: none;"></div>
            <div id="searchHistory" class="search-history" style="display: none;"></div>
        </div>

        <div id="filters" class="filters">
            <button class="filter-btn active" data-f="all"><span class="btn-emoji">🔵</span> Tous</button>
            <button class="filter-btn" data-f="fresh"><span class="btn-emoji">✅</span> Frais</button>
            <button class="filter-btn" data-f="soon"><span class="btn-emoji">⚠️</span> Urgent</button>
            <button class="filter-btn" data-f="expired"><span class="btn-emoji">❌</span> Périmés</button>
            <button class="filter-btn" data-f="out_of_stock"><span class="btn-emoji">📦</span> Épuisés</button>
            <button class="filter-btn" data-f="to_renew"><span class="btn-emoji">📝</span> À renouveler</button>
        </div>

        <div id="filtersEmplacement" class="filters-emplacement">
            <button class="filter-empl-btn active" data-empl="all"><span class="btn-emoji">📍</span> Tous</button>
            <button class="filter-empl-btn" data-empl="frigo"><span class="btn-emoji">🧊</span> Frigo</button>
            <button class="filter-empl-btn" data-empl="congelateur"><span class="btn-emoji">❄️</span> Congélo</button>
            <button class="filter-empl-btn" data-empl="placard"><span class="btn-emoji">🚪</span> Placard</button>
            <button class="filter-empl-btn" data-empl="cave"><span class="btn-emoji">🍷</span> Cave</button>
            <button class="filter-empl-btn" data-empl="corbeille"><span class="btn-emoji">🧺</span> Corbeille</button>
        </div>

        <div id="items" class="items"></div>

        <div id="empty" class="empty">
            <div class="icon">🥗</div>
            <h2>Aucun produit</h2>
            <p>Scannez un code-barres ou ajoutez manuellement</p>
        </div>
    </div>

    <script>
        // === SYSTÈME DE TRADUCTION ===
        var translations = {
            fr: {
                app: {
                    title: "🧊 Frigo Manager",
                    subtitle: "Scanner de code-barres intelligent"
                },
                actions: {
                    scan: "📷 Scanner un code-barres",
                    manual: "✍️ Saisie manuelle",
                    shopping: "🛒 Liste de courses",
                    recipes: "👨‍🍳 Suggestions de recettes"
                },
                filters: {
                    all: "Tous",
                    expired: "Périmés",
                    soon: "Urgents",
                    fresh: "Frais",
                    out: "Épuisés",
                    renew: "À renouveler"
                },
                locations: {
                    all: "Tous",
                    frigo: "Frigo",
                    congelateur: "Congélateur",
                    placard: "Placard",
                    legumes: "Légumes",
                    cave: "Cave",
                    corbeille: "Corbeille",
                    autre: "Autre"
                },
                stats: {
                    products: "Produits",
                    urgent: "Urgents",
                    expired: "Périmés"
                },
                form: {
                    name: "Nom du produit",
                    barcode: "Code-barres",
                    quantity: "Quantité",
                    expiry: "Date de péremption",
                    category: "Catégorie",
                    location: "Emplacement",
                    toRenew: "À renouveler",
                    save: "Enregistrer",
                    cancel: "Annuler",
                    delete: "Supprimer"
                },
                categories: {
                    Fruits: "Fruits",
                    Légumes: "Légumes",
                    Viande: "Viande",
                    Poisson: "Poisson",
                    Produits_laitiers: "Produits laitiers",
                    Viennoiseries: "Viennoiseries",
                    Boissons: "Boissons",
                    Surgelés: "Surgelés",
                    Conserves: "Conserves",
                    Pâtes_riz: "Pâtes & riz",
                    Condiments: "Condiments",
                    Snacks: "Snacks",
                    Autre: "Autre"
                },
                shopping: {
                    title: "Liste de courses",
                    count: "produits à acheter",
                    empty: "Aucun produit à acheter !",
                    emptyDesc: "Votre frigo est bien approvisionné.",
                    exhausted: "Stock épuisé",
                    toRenew: "À renouveler",
                    export: "📋 Copier la liste",
                    print: "🖨️ Imprimer",
                    close: "✕ Fermer"
                },
                recipes: {
                    title: "Suggestions de recettes",
                    create: "➕ Créer une recette",
                    match: "Correspondance",
                    time: "Temps",
                    difficulty: "Difficulté",
                    servings: "portions",
                    ingredients: "Ingrédients",
                    steps: "Étapes de préparation",
                    available: "Disponible",
                    missing: "Manquant",
                    userRecipe: "Ma recette",
                    edit: "✏️ Modifier",
                    deleteBtn: "🗑️ Supprimer",
                    exportCSV: "📤 Exporter recettes CSV",
                    importCSV: "📥 Importer recettes CSV",
                    close: "✕ Fermer"
                },
                settings: {
                    title: "Paramètres",
                    backup: "Sauvegarde",
                    exportExcel: "📊 Exporter Excel",
                    importExcel: "📊 Importer Excel",
                    backupDesc: "Sauvegardez vos données ou transférez-les vers un autre appareil",
                    data: "Données",
                    deleteAll: "Supprimer toutes les données",
                    deleteWarning: "Attention : cette action est irréversible",
                    about: "À propos",
                    version: "Version 1.2",
                    developer: "Développé par :",
                    powered: "Réalisé à l'aide d'",
                    copyright: "Tous droits réservés",
                    close: "✕ Fermer"
                },
                messages: {
                    productAdded: "✅ Produit ajouté avec succès !",
                    productUpdated: "✅ Produit mis à jour !",
                    productDeleted: "✅ Produit supprimé",
                    deleteConfirm: "Êtes-vous sûr de vouloir supprimer ce produit ?",
                    deleteAllConfirm: "⚠️ ATTENTION\n\nÊtes-vous sûr de vouloir TOUT supprimer ?\n\nCette action est IRRÉVERSIBLE !",
                    allDeleted: "✅ Toutes les données ont été supprimées.",
                    noProducts: "Aucun produit",
                    addFirst: "Scannez un code-barres ou ajoutez manuellement",
                    listCopied: "✅ Liste copiée dans le presse-papier !\n\nVous pouvez la coller dans Notes, Messages, etc.",
                    noCamera: "Impossible d'accéder à la caméra",
                    productNotFound: "Produit non trouvé dans la base de données.\nVous pouvez l'ajouter manuellement.",
                    connectionError: "Erreur de connexion.\nVous pouvez ajouter le produit manuellement.",
                    enterName: "Veuillez entrer un nom de produit",
                    noProductToExport: "❌ Aucun produit à exporter",
                    exportExcelSuccess: "✅ Export Excel réussi !\n\n{count} produits exportés dans {filename}",
                    importExcelSuccess: "✅ Import Excel réussi !\n\n{count} produits importés.",
                    importExcelError: "❌ Erreur lors de l'import",
                    replaceConfirm: "⚠️ ATTENTION\n\nVous avez actuellement {current} produits.\nLe fichier contient {import} produits.\n\nVoulez-vous REMPLACER vos données actuelles ?\n\n(Cliquez \"Annuler\" pour ajouter les produits sans supprimer les actuels)",
                    invalidFile: "Format de fichier invalide",
                    noShoppingItems: "❌ Aucun produit dans la liste de courses",
                    recipesExported: "✅ Recettes exportées avec succès !\n\n{count} recettes sauvegardées en CSV.",
                    recipesImported: "✅ Import CSV réussi !\n\n{count} recettes importées.",
                    recipeCreated: "✅ Recette créée avec succès !",
                    recipeUpdated: "✅ Recette modifiée avec succès !",
                    recipeDeleted: "✅ Recette supprimée avec succès",
                    recipeDeleteConfirm: "Êtes-vous sûr de vouloir supprimer cette recette ?",
                    notificationsEnabled: "✅ Notifications activées ! Vous recevrez des alertes pour vos produits.",
                    notificationsBlocked: "❌ Notifications bloquées dans les paramètres du navigateur",
                    recipeNameRequired: "Veuillez entrer un nom pour la recette",
                    recipeTimeRequired: "Veuillez entrer le temps de préparation",
                    recipeIngredientsRequired: "Veuillez ajouter au moins un ingrédient",
                    recipeStepsRequired: "Veuillez ajouter au moins une étape",
                    noRecipesToExport: "❌ Aucune recette à exporter",
                    invalidCSV: "Le fichier CSV est vide",
                    noValidRecipes: "Aucune recette valide trouvée dans le fichier",
                    replaceRecipesConfirm: "⚠️ ATTENTION\n\nVous avez actuellement {current} recettes personnalisées.\nLe fichier CSV contient {import} recettes.\n\nVoulez-vous REMPLACER vos recettes actuelles ?\n\n(Cliquez \"Annuler\" pour ajouter les recettes sans supprimer les actuelles)"
                },
                alerts: {
                    title: "⚠️ ATTENTION : Action requise !",
                    viewProducts: "👉 Voir les produits",
                    outOfStock: "produit{s} ÉPUISÉ{S}",
                    toRenew: "à renouveler",
                    expired: "produit{s} périmé{s}",
                    expiresToday: "expire{nt} AUJOURD'HUI",
                    expiresTomorrow: "expire{nt} demain",
                    expiresInTwoDays: "dans 2 jours"
                },
                scanner: {
                    instructions: "📷 Centrez le code-barres",
                    close: "✕ Fermer",
                    manualEntry: "✍️ Saisie manuelle",
                    searching: "Recherche du produit..."
                },
                shoppingModal: {
                    title: "🛒 Liste de courses",
                    productsLabel: "produits",
                    copy: "📋 Copier la liste",
                    print: "🖨️ Imprimer",
                    close: "✕ Fermer"
                },
                recipesModal: {
                    title: "👨‍🍳 Suggestions de recettes",
                    subtitle: "Avec vos ingrédients disponibles",
                    create: "➕ Créer une recette",
                    back: "← Retour"
                }
            },
            en: {
                app: {
                    title: "🧊 Fridge Manager",
                    subtitle: "Smart barcode scanner"
                },
                actions: {
                    scan: "📷 Scan a barcode",
                    manual: "✍️ Manual entry",
                    shopping: "🛒 Shopping list",
                    recipes: "👨‍🍳 Recipe suggestions"
                },
                filters: {
                    all: "All",
                    expired: "Expired",
                    soon: "Urgent",
                    fresh: "Fresh",
                    out: "Out of stock",
                    renew: "To renew"
                },
                locations: {
                    all: "All",
                    frigo: "Fridge",
                    congelateur: "Freezer",
                    placard: "Cupboard",
                    legumes: "Vegetables",
                    cave: "Cellar",
                    corbeille: "Basket",
                    autre: "Other"
                },
                stats: {
                    products: "Products",
                    urgent: "Urgent",
                    expired: "Expired"
                },
                form: {
                    name: "Product name",
                    barcode: "Barcode",
                    quantity: "Quantity",
                    expiry: "Expiry date",
                    category: "Category",
                    location: "Location",
                    toRenew: "To renew",
                    save: "Save",
                    cancel: "Cancel",
                    delete: "Delete"
                },
                categories: {
                    Fruits: "Fruits",
                    Légumes: "Vegetables",
                    Viande: "Meat",
                    Poisson: "Fish",
                    Produits_laitiers: "Dairy products",
                    Viennoiseries: "Pastries",
                    Boissons: "Beverages",
                    Surgelés: "Frozen",
                    Conserves: "Canned goods",
                    Pâtes_riz: "Pasta & rice",
                    Condiments: "Condiments",
                    Snacks: "Snacks",
                    Autre: "Other"
                },
                shopping: {
                    title: "Shopping List",
                    count: "items to buy",
                    empty: "No items to buy!",
                    emptyDesc: "Your fridge is well stocked.",
                    exhausted: "Out of stock",
                    toRenew: "To renew",
                    export: "📋 Copy list",
                    print: "🖨️ Print",
                    close: "✕ Close"
                },
                recipes: {
                    title: "Recipe Suggestions",
                    create: "➕ Create a recipe",
                    match: "Match",
                    time: "Time",
                    difficulty: "Difficulty",
                    servings: "servings",
                    ingredients: "Ingredients",
                    steps: "Preparation steps",
                    available: "Available",
                    missing: "Missing",
                    userRecipe: "My recipe",
                    edit: "✏️ Edit",
                    deleteBtn: "🗑️ Delete",
                    exportCSV: "📤 Export recipes CSV",
                    importCSV: "📥 Import recipes CSV",
                    close: "✕ Close"
                },
                settings: {
                    title: "Settings",
                    backup: "Backup",
                    exportExcel: "📊 Export Excel",
                    importExcel: "📊 Import Excel",
                    backupDesc: "Back up your data or transfer it to another device",
                    data: "Data",
                    deleteAll: "Delete all data",
                    deleteWarning: "Warning: this action is irreversible",
                    about: "About",
                    version: "Version 1.2",
                    developer: "Developed by:",
                    powered: "Powered by",
                    copyright: "All rights reserved",
                    close: "✕ Close"
                },
                messages: {
                    productAdded: "✅ Product added successfully!",
                    productUpdated: "✅ Product updated!",
                    productDeleted: "✅ Product deleted",
                    deleteConfirm: "Are you sure you want to delete this product?",
                    deleteAllConfirm: "⚠️ WARNING\n\nAre you sure you want to delete EVERYTHING?\n\nThis action is IRREVERSIBLE!",
                    allDeleted: "✅ All data has been deleted.",
                    noProducts: "No products",
                    addFirst: "Scan a barcode or add manually",
                    listCopied: "✅ List copied to clipboard!\n\nYou can paste it in Notes, Messages, etc.",
                    noCamera: "Unable to access camera",
                    productNotFound: "Product not found in database.\nYou can add it manually.",
                    connectionError: "Connection error.\nYou can add the product manually.",
                    enterName: "Please enter a product name",
                    noProductToExport: "❌ No products to export",
                    exportExcelSuccess: "✅ Excel export successful!\n\n{count} products exported to {filename}",
                    importExcelSuccess: "✅ Excel import successful!\n\n{count} products imported.",
                    importExcelError: "❌ Import error",
                    replaceConfirm: "⚠️ WARNING\n\nYou currently have {current} products.\nThe file contains {import} products.\n\nDo you want to REPLACE your current data?\n\n(Click \"Cancel\" to add products without deleting current ones)",
                    invalidFile: "Invalid file format",
                    noShoppingItems: "❌ No items in shopping list",
                    recipesExported: "✅ Recipes exported successfully!\n\n{count} recipes saved to CSV.",
                    recipesImported: "✅ CSV import successful!\n\n{count} recipes imported.",
                    recipeCreated: "✅ Recipe created successfully!",
                    recipeUpdated: "✅ Recipe updated successfully!",
                    recipeDeleted: "✅ Recipe deleted successfully",
                    recipeDeleteConfirm: "Are you sure you want to delete this recipe?",
                    notificationsEnabled: "✅ Notifications enabled! You will receive alerts for your products.",
                    notificationsBlocked: "❌ Notifications blocked in browser settings",
                    recipeNameRequired: "Please enter a name for the recipe",
                    recipeTimeRequired: "Please enter preparation time",
                    recipeIngredientsRequired: "Please add at least one ingredient",
                    recipeStepsRequired: "Please add at least one step",
                    noRecipesToExport: "❌ No recipes to export",
                    invalidCSV: "The CSV file is empty",
                    noValidRecipes: "No valid recipes found in file",
                    replaceRecipesConfirm: "⚠️ WARNING\n\nYou currently have {current} custom recipes.\nThe CSV file contains {import} recipes.\n\nDo you want to REPLACE your current recipes?\n\n(Click \"Cancel\" to add recipes without deleting current ones)"
                },
                alerts: {
                    title: "⚠️ WARNING: Action required!",
                    viewProducts: "👉 View products",
                    outOfStock: "product{s} OUT OF STOCK",
                    toRenew: "to renew",
                    expired: "product{s} expired",
                    expiresToday: "expire{s} TODAY",
                    expiresTomorrow: "expire{s} tomorrow",
                    expiresInTwoDays: "in 2 days"
                },
                scanner: {
                    instructions: "📷 Center the barcode",
                    close: "✕ Close",
                    manualEntry: "✍️ Manual entry",
                    searching: "Searching for product..."
                },
                shoppingModal: {
                    title: "🛒 Shopping List",
                    productsLabel: "items",
                    copy: "📋 Copy list",
                    print: "🖨️ Print",
                    close: "✕ Close"
                },
                recipesModal: {
                    title: "👨‍🍳 Recipe Suggestions",
                    subtitle: "With your available ingredients",
                    create: "➕ Create a recipe",
                    back: "← Back"
                }
            }
        };
        
        var currentLang = localStorage.getItem('language') || 'fr';
        
        // === SYSTÈME DE VERSION ===
        var APP_VERSION = '2.1.9';
        var VERSION_DATE = '2026-02-26';
        var CHANGELOG = {
            '2.1.9': {
                date: '2026-02-26',
                changes: {
                    fr: [
                        '🐛 Correction du scroll bloqué sur simulateur iPhone',
                        '✅ html: height: 100% → min-height: 100% (permet débordement)',
                        '✅ body: overflow-y: auto ajouté explicitement',
                        '✅ body: position: relative pour contexte correct',
                        '✅ Conserve overflow-x: clip et -webkit-overflow-scrolling: touch'
                    ],
                    en: [
                        '🐛 Fixed blocked scroll on iPhone simulator',
                        '✅ html: height: 100% → min-height: 100% (allows overflow)',
                        '✅ body: overflow-y: auto explicitly added',
                        '✅ body: position: relative for correct context',
                        '✅ Keeps overflow-x: clip and -webkit-overflow-scrolling: touch'
                    ]
                }
            },
            '2.1.8': {
                date: '2026-02-26',
                changes: {
                    fr: [
                        '📱 Optimisation affichage grands iPhones (XS Max, 11 Pro Max, 12/13/14/15 Pro Max)',
                        '✨ Réduction espacements sur mobile : body 10px, stats 12px, actions 12px, boutons 15px',
                        '🎨 Interface plus compacte sur petits écrans (~120px économisés)',
                        '✅ Approche mobile-first avec restauration automatique sur desktop'
                    ],
                    en: [
                        '📱 Optimized display for large iPhones (XS Max, 11 Pro Max, 12/13/14/15 Pro Max)',
                        '✨ Reduced spacing on mobile: body 10px, stats 12px, actions 12px, buttons 15px',
                        '🎨 More compact interface on small screens (~120px saved)',
                        '✅ Mobile-first approach with automatic restoration on desktop'
                    ]
                }
            },
            '2.1.7': {
                date: '2026-02-25',
                changes: {
                    fr: [
                         '⚡ Saisie numérique dans les nouvelles recettes',
                         '⚡ Sauvegardes dans le dossier dans le dossier Frigo Manager'
                    ],
                    en: [
                         '⚡ Numeric entry in the new recipes',
                         '⚡ Backup in Frigo Manager folder'
                    ]
                }
            },
            '2.1.6': {
                date: '2026-02-13',
                changes: {
                    fr: [
                        '🐛 Correction erreur "can\'t find variable: notification" lors de l\'import Excel',
                        '✅ Vérification de la disponibilité de l\'API Notification avant utilisation',
                        '🔒 Protection contre les navigateurs ne supportant pas les notifications'
                    ],
                    en: [
                        '🐛 Fixed "can\'t find variable: notification" error during Excel import',
                        '✅ Check Notification API availability before use',
                        '🔒 Protection against browsers not supporting notifications'
                    ]
                }
            },
            '2.1.5': {
                date: '2026-02-13',
                changes: {
                    fr: [
                        '🐛 Correction du recalcul automatique de la date de péremption',
                        '✨ La date se recalcule maintenant quand vous changez la catégorie ou l\'emplacement',
                        '⚡ Fonctionne dans l\'ajout ET la modification de produits'
                    ],
                    en: [
                        '🐛 Fixed automatic expiry date recalculation',
                        '✨ Date now recalculates when you change category or location',
                        '⚡ Works in both add and edit modes'
                    ]
                }
            },
            '2.1.4': {
                date: '2026-02-13',
                changes: {
                    fr: [
                        '✨ Ajout de la table des durées de conservation dans les paramètres',
                        '📋 Visualisation complète des 54 combinaisons (9 catégories × 6 emplacements)',
                        '💡 Conseils et astuces de conservation'
                    ],
                    en: [
                        '✨ Added storage duration table in settings',
                        '📋 Complete view of 54 combinations (9 categories × 6 locations)',
                        '💡 Storage tips and tricks'
                    ]
                }
            },
            '2.1.3': {
                date: '2026-02-13',
                changes: {
                    fr: [
                        '🐛 Les produits à quantité 0 n\'apparaissent plus dans "Frais", "Urgent" et "Périmés"',
                        '✅ Les produits épuisés apparaissent uniquement dans le filtre "Épuisé"'
                    ],
                    en: [
                        '🐛 Items with quantity 0 no longer appear in "Fresh", "Urgent" and "Expired"',
                        '✅ Out of stock items only appear in "Out of stock" filter'
                    ]
                }
            },
            '2.1.2': {
                date: '2026-02-13',
                changes: {
                    fr: [
                        '🐛 Correction du bouton "Saisie manuelle"',
                        '🔧 Correction de l\'ordre des variables dans showForm()',
                        '✅ Sécurisation de l\'initialisation des boutons'
                    ],
                    en: [
                        '🐛 Fixed "Manual entry" button',
                        '🔧 Fixed variable order in showForm()',
                        '✅ Secured button initialization'
                    ]
                }
            },
            '2.1.1': {
                date: '2026-02-13',
                changes: {
                    fr: [
                        '🎨 Alignement des boutons langue/paramètres avec le sous-titre sur iPhone',
                        '📱 Amélioration de l\'ergonomie mobile'
                    ],
                    en: [
                        '🎨 Aligned language/settings buttons with subtitle on iPhone',
                        '📱 Improved mobile ergonomics'
                    ]
                }
            },
            '2.1.0': {
                date: '2026-02-13',
                changes: {
                    fr: [
                        '✨ Modification des recettes par défaut (crée une copie)',
                        '📊 Export Excel inclut maintenant les scores santé',
                        '🎨 Couleur du bouton "Tous" améliorée (rouge visible)',
                        '⏰ Calcul automatique des dates de péremption',
                        '🔄 Recalcul en temps réel des dates',
                        '📋 Table complète des durées de conservation'
                    ],
                    en: [
                        '✨ Edit default recipes (creates a copy)',
                        '📊 Excel export now includes health scores',
                        '🎨 Improved "All" button color (visible red)',
                        '⏰ Automatic expiration date calculation',
                        '🔄 Real-time date recalculation',
                        '📋 Complete storage duration table'
                    ]
                }
            },
            '2.0.0': {
                date: '2026-02-11',
                changes: {
                    fr: [
                        '🎯 Calcul intelligent des dates selon catégorie et emplacement',
                        '🏥 Sauvegarde des scores santé (Nutri-Score, NOVA, Eco-Score)',
                        '📱 Mode PWA amélioré',
                        '🌍 Support multilingue FR/EN'
                    ],
                    en: [
                        '🎯 Smart date calculation by category and location',
                        '🏥 Health scores saved (Nutri-Score, NOVA, Eco-Score)',
                        '📱 Improved PWA mode',
                        '🌍 Multilingual support FR/EN'
                    ]
                }
            }
        };
        
        function getVersionInfo() {
            return {
                version: APP_VERSION,
                date: VERSION_DATE,
                changelog: CHANGELOG[APP_VERSION].changes[currentLang]
            };
        }
        
        function t(key) {
            var keys = key.split('.');
            var value = translations[currentLang];
            for (var i = 0; i < keys.length; i++) {
                value = value[keys[i]];
                if (!value) return key;
            }
            return value;
        }
        
        function setLanguage(lang) {
            currentLang = lang;
            localStorage.setItem('language', lang);
            
            // Update flag and code
            document.getElementById('langFlag').textContent = lang === 'fr' ? '🇫🇷' : '🇬🇧';
            document.getElementById('langCode').textContent = lang.toUpperCase();
            
            // Update all translatable elements with data-i18n
            var elements = document.querySelectorAll('[data-i18n]');
            for (var i = 0; i < elements.length; i++) {
                var key = elements[i].getAttribute('data-i18n');
                var translation = t(key);
                // Keep emoji if present
                var emoji = elements[i].textContent.match(/[\u{1F300}-\u{1F9FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}]/u);
                if (emoji && !translation.includes(emoji[0])) {
                    elements[i].textContent = emoji[0] + ' ' + translation;
                } else {
                    elements[i].textContent = translation;
                }
            }
            
            // Update dynamic UI elements
            updateUILanguage();
            
            // Re-render everything
            if (typeof renderAll !== 'undefined') {
                renderAll();
            }
        }
        
        function updateUILanguage() {
            // Update search input placeholder
            var searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.placeholder = currentLang === 'fr' ? '🔍 Rechercher un produit...' : '🔍 Search for a product...';
            }
            
            // Update action buttons
            var btnScan = document.getElementById('btnScan');
            var btnManual = document.getElementById('btnManual');
            var btnShoppingList = document.getElementById('btnShoppingList');
            var btnRecipes = document.getElementById('btnRecipes');
            
            if (btnScan) btnScan.textContent = t('actions.scan');
            if (btnManual) btnManual.textContent = t('actions.manual');
            if (btnShoppingList) btnShoppingList.textContent = t('actions.shopping');
            if (btnRecipes) btnRecipes.textContent = t('actions.recipes');
            
            // Update stat labels
            var statLabels = document.querySelectorAll('.stat-card .label');
            if (statLabels.length >= 3) {
                statLabels[0].textContent = t('stats.products');
                statLabels[1].textContent = t('stats.urgent');
                statLabels[2].textContent = t('stats.expired');
            }
            
            // Update filter buttons (status)
            var filters = document.querySelectorAll('.filter-btn');
            var filterData = [
                {emoji: '🔵', key: 'all'},
                {emoji: '✅', key: 'fresh'},
                {emoji: '⚠️', key: 'soon'},
                {emoji: '❌', key: 'expired'},
                {emoji: '📦', key: 'out'},
                {emoji: '📝', key: 'renew'}
            ];
            for (var i = 0; i < filters.length && i < filterData.length; i++) {
                filters[i].innerHTML = '<span class="btn-emoji">' + filterData[i].emoji + '</span> ' + t('filters.' + filterData[i].key);
            }
            
            // Update location filters
            var locationFilters = document.querySelectorAll('.filter-empl-btn');
            var locationData = [
                {emoji: '📍', key: 'all'},
                {emoji: '🧊', key: 'frigo'},
                {emoji: '❄️', key: 'congelateur'},
                {emoji: '🚪', key: 'placard'},
                {emoji: '🍷', key: 'cave'},
                {emoji: '🧺', key: 'corbeille'}
            ];
            for (var i = 0; i < locationFilters.length && i < locationData.length; i++) {
                locationFilters[i].innerHTML = '<span class="btn-emoji">' + locationData[i].emoji + '</span> ' + t('locations.' + locationData[i].key);
            }
            
            // Update empty state
            var emptyTitle = document.querySelector('#empty h2');
            var emptyText = document.querySelector('#empty p');
            if (emptyTitle) emptyTitle.textContent = t('messages.noProducts');
            if (emptyText) emptyText.textContent = t('messages.addFirst');
            
            // Update notification prompt
            var notifTitle = document.querySelector('.notification-prompt-title');
            var notifText = document.querySelector('.notification-prompt-text');
            var notifBtn = document.getElementById('btnEnableNotifications');
            var notifCancel = document.getElementById('btnCancelNotifications');
            
            if (notifTitle) notifTitle.textContent = currentLang === 'fr' ? 'Activer les notifications' : 'Enable notifications';
            if (notifText) notifText.textContent = currentLang === 'fr' ? 'Recevez des alertes quand vos produits arrivent à expiration' : 'Get alerts when your products are about to expire';
            if (notifBtn) notifBtn.textContent = currentLang === 'fr' ? '✓ Activer' : '✓ Enable';
            if (notifCancel) notifCancel.textContent = currentLang === 'fr' ? 'Plus tard' : 'Later';
            
            // Update scanner modal
            var scannerInstructions = document.querySelector('.scanner-instructions');
            var btnCloseScanner = document.getElementById('btnCloseScanner');
            var btnManualFromScanner = document.getElementById('btnManualFromScanner');
            var loadingText = document.querySelector('#loading h2');
            
            if (scannerInstructions) scannerInstructions.textContent = t('scanner.instructions');
            if (btnCloseScanner) btnCloseScanner.textContent = t('scanner.close');
            if (btnManualFromScanner) btnManualFromScanner.textContent = t('scanner.manualEntry');
            if (loadingText) loadingText.textContent = t('scanner.searching');
            
            // Update shopping list modal
            var shoppingTitle = document.querySelector('#shoppingListModal h2');
            var shoppingLabel = document.querySelector('.shopping-stat-label');
            var btnCopyList = document.querySelector('.shopping-list-actions .btn[onclick="exportShoppingListText()"]');
            var btnPrintList = document.querySelector('.shopping-list-actions .btn[onclick="printShoppingList()"]');
            var btnCloseShoppingList = document.querySelector('.shopping-list-actions .btn[onclick="closeShoppingList()"]');
            
            if (shoppingTitle) shoppingTitle.textContent = t('shoppingModal.title');
            if (shoppingLabel) shoppingLabel.textContent = t('shoppingModal.productsLabel');
            if (btnCopyList) btnCopyList.textContent = t('shoppingModal.copy');
            if (btnPrintList) btnPrintList.textContent = t('shoppingModal.print');
            if (btnCloseShoppingList) btnCloseShoppingList.textContent = t('shoppingModal.close');
            
            // Update recipes modal
            var recipesTitle = document.querySelector('#recipesModal h2');
            var recipesSubtitle = document.querySelector('.recipes-stat-label');
            var btnCreateRecipe = document.querySelector('.recipes-stats .btn[onclick="openCreateRecipe()"]');
            var btnExportRecipes = document.querySelector('.recipes-actions .btn[onclick="exportRecipesCSV()"]');
            var btnImportRecipes = document.querySelectorAll('.recipes-actions .btn')[1];
            var btnCloseRecipes = document.querySelector('.recipes-actions .btn[onclick="closeRecipes()"]');
            var btnBackRecipe = document.querySelector('.btn-back');
            
            if (recipesTitle) recipesTitle.textContent = t('recipesModal.title');
            if (recipesSubtitle) recipesSubtitle.textContent = t('recipesModal.subtitle');
            if (btnCreateRecipe) btnCreateRecipe.textContent = t('recipesModal.create');
            if (btnExportRecipes) btnExportRecipes.textContent = t('recipes.exportCSV');
            if (btnImportRecipes) btnImportRecipes.textContent = t('recipes.importCSV');
            if (btnCloseRecipes) btnCloseRecipes.textContent = t('recipes.close');
            if (btnBackRecipe) btnBackRecipe.textContent = t('recipesModal.back');
            
            // Update create recipe modal
            var createRecipeLabels = document.querySelectorAll('#createRecipeModal label');
            if (createRecipeLabels.length >= 5) {
                createRecipeLabels[0].textContent = currentLang === 'fr' ? 'Nom de la recette *' : 'Recipe name *';
                createRecipeLabels[1].textContent = currentLang === 'fr' ? 'Icône (emoji)' : 'Icon (emoji)';
                createRecipeLabels[2].textContent = currentLang === 'fr' ? 'Temps' : 'Time';
                createRecipeLabels[3].textContent = currentLang === 'fr' ? 'Difficulté' : 'Difficulty';
                createRecipeLabels[4].textContent = currentLang === 'fr' ? 'Portions' : 'Servings';
                createRecipeLabels[5].textContent = currentLang === 'fr' ? 'Ingrédients *' : 'Ingredients *';
                createRecipeLabels[6].textContent = currentLang === 'fr' ? 'Étapes de préparation *' : 'Preparation steps *';
            }
            
            var recipeDifficultySelect = document.getElementById('recipeDifficultyInput');
            if (recipeDifficultySelect) {
                var difficulties = currentLang === 'fr' 
                    ? ['Très facile', 'Facile', 'Moyen', 'Difficile']
                    : ['Very easy', 'Easy', 'Medium', 'Hard'];
                var currentValue = recipeDifficultySelect.value;
                recipeDifficultySelect.innerHTML = difficulties.map(function(d) {
                    return '<option' + (d === currentValue ? ' selected' : '') + '>' + d + '</option>';
                }).join('');
            }
            
            var btnAddIngredient = document.querySelector('#createRecipeModal .btn[onclick="addIngredientField()"]');
            var btnAddStep = document.querySelector('#createRecipeModal .btn[onclick="addStepField()"]');
            var btnSaveRecipe = document.querySelector('.create-recipe-actions .btn[onclick="saveRecipe()"]');
            var btnCancelRecipe = document.querySelector('.create-recipe-actions .btn[onclick="closeCreateRecipe()"]');
            
            if (btnAddIngredient) btnAddIngredient.textContent = currentLang === 'fr' ? '➕ Ajouter un ingrédient' : '➕ Add ingredient';
            if (btnAddStep) btnAddStep.textContent = currentLang === 'fr' ? '➕ Ajouter une étape' : '➕ Add step';
            if (btnSaveRecipe) btnSaveRecipe.textContent = currentLang === 'fr' ? '✓ Enregistrer' : '✓ Save';
            if (btnCancelRecipe) btnCancelRecipe.textContent = currentLang === 'fr' ? '✕ Annuler' : '✕ Cancel';
            
            // Update recipe name placeholder
            var recipeNameInput = document.getElementById('recipeNameInput');
            if (recipeNameInput) recipeNameInput.placeholder = currentLang === 'fr' ? 'Ex: Gratin dauphinois' : 'E.g: Mac and cheese';
            
            var recipeTimeInput = document.getElementById('recipeTimeInput');
            if (recipeTimeInput) recipeTimeInput.placeholder = currentLang === 'fr' ? 'Ex: 30 min' : 'E.g: 30 min';
        }
        
        // Helper function for translated alerts
        function showAlert(message) {
            alert(message);
        }
        
        function showConfirm(message) {
            return confirm(message);
        }
        
        // Helper to replace placeholders in messages
        function tm(key, replacements) {
            var message = t(key);
            if (replacements) {
                for (var placeholder in replacements) {
                    message = message.replace('{' + placeholder + '}', replacements[placeholder]);
                }
            }
            return message;
        }
        
        function toggleLanguage() {
            setLanguage(currentLang === 'fr' ? 'en' : 'fr');
        }
        
        // === DONNÉES ===
        
        var items = [];
        var currentFilter = 'all';
        var currentEmplacement = 'all';
        var currentSearchTerm = '';
        var searchHistory = [];
        var maxSearchHistory = 5;
        var currentBarcode = null;
        var currentProductData = null;
        var lastScannedCode = null;
        var scanConfidenceCount = {};
        var scanningActive = false;

                // === DURÉES DE CONSERVATION (en jours) ===
        var dureeConservation = {
            'fruit': {
                'frigo': 7,
                'congelateur': 365,
                'placard': 3,
                'cave': 14,
                'corbeille': 5,
                'autre_emplacement': 5
            },
            'legume': {
                'frigo': 7,
                'congelateur': 365,
                'placard': 5,
                'cave': 30,
                'corbeille': 7,
                'autre_emplacement': 5
            },
            'viande': {
                'frigo': 3,
                'congelateur': 180,
                'placard': 1,
                'cave': 2,
                'corbeille': 2,
                'autre_emplacement': 2
            },
            'poisson': {
                'frigo': 2,
                'congelateur': 90,
                'placard': 1,
                'cave': 1,
                'corbeille': 1,
                'autre_emplacement': 1
            },
            'produit_laitier': {
                'frigo': 7,
                'congelateur': 90,
                'placard': 1,
                'cave': 3,
                'corbeille': 3,
                'autre_emplacement': 3
            },
            'viennoiseries': {
                'frigo': 5,
                'congelateur': 90,
                'placard': 3,
                'cave': 3,
                'corbeille': 3,
                'autre_emplacement': 3
            },
            'conserves': {
                'frigo': 180,
                'congelateur': 730,
                'placard': 730,
                'cave': 1095,
                'corbeille': 365,
                'autre_emplacement': 365
            },
            'boisson': {
                'frigo': 90,
                'congelateur': 180,
                'placard': 365,
                'cave': 730,
                'corbeille': 180,
                'autre_emplacement': 180
            },
            'autre': {
                'frigo': 14,
                'congelateur': 180,
                'placard': 90,
                'cave': 180,
                'corbeille': 30,
                'autre_emplacement': 30
            }
        };
        
        // Fonction pour calculer la nouvelle date selon emplacement + catégorie
        function calculerNouvelleDate(categorie, emplacement) {
            var duree = (dureeConservation[categorie] && dureeConservation[categorie][emplacement]) 
                       || dureeConservation['autre']['frigo']; // Valeur par défaut
            
            var nouvelleDate = new Date();
            nouvelleDate.setDate(nouvelleDate.getDate() + duree);
            return nouvelleDate.toISOString().split('T')[0];
        }
        
        // Fonction pour afficher les durées en texte lisible
        function afficherDuree(jours) {
            if (jours < 7) return jours + ' jour' + (jours > 1 ? 's' : '');
            if (jours < 30) return Math.round(jours / 7) + ' semaine' + (jours > 13 ? 's' : '');
            if (jours < 365) return Math.round(jours / 30) + ' mois';
            return Math.round(jours / 365) + ' an' + (jours > 730 ? 's' : '');
        }

        
        // FONCTIONS GLOBALES POUR ONCLICK HTML (iOS-friendly)
        var lastSearchTime = 0;
        
        function doSearch() {
            // Éviter les appels multiples rapides (debounce 300ms)
            var now = Date.now();
            if (now - lastSearchTime < 300) {
                return; // Ignorer si moins de 300ms depuis le dernier appel
            }
            lastSearchTime = now;
            
            var input = document.getElementById('searchInput');
            var clearBtn = document.getElementById('clearSearch');
            
            if (!input) return;
            
            var value = input.value.trim();
            currentSearchTerm = value;
            
            // Afficher le bouton clear
            if (clearBtn) {
                clearBtn.style.display = value ? 'flex' : 'none';
            }
            
            // Lancer la recherche
            renderItems();
            
            // Ajouter à l'historique
            if (value) {
                addToSearchHistory(value);
            }
            
            // Fermer le clavier
            input.blur();
        }
        
        // Afficher le bouton X pendant la saisie (compatible iOS)
        (function() {
            var searchInput = document.getElementById('searchInput');
            var clearBtn = document.getElementById('clearSearch');
            
            if (searchInput && clearBtn) {
                function updateClearButton() {
                    var value = searchInput.value.trim();
                    clearBtn.style.display = value ? 'flex' : 'none';
                }
                
                // Écouter tous les événements possibles pour iOS
                searchInput.addEventListener('input', updateClearButton);
                searchInput.addEventListener('keyup', updateClearButton);
                searchInput.addEventListener('change', updateClearButton);
                searchInput.addEventListener('paste', updateClearButton);
                searchInput.addEventListener('focus', updateClearButton);
            }
        })();

        function clearSearchNow() {
            var input = document.getElementById('searchInput');
            var clearBtn = document.getElementById('clearSearch');
            
            if (input) input.value = '';
            currentSearchTerm = '';
            if (clearBtn) clearBtn.style.display = 'none';
            
            renderItems();
            if (input) input.focus();
        }
        
        // Charger l'historique de recherche depuis localStorage
        try {
            var storedHistory = localStorage.getItem('search-history');
            if (storedHistory) searchHistory = JSON.parse(storedHistory);
        } catch(e) {}
        
        // Fonction pour mettre en surbrillance le texte recherché (ignore les accents)
        function highlightText(text, searchTerm) {
            if (!searchTerm || !text) return text;
            
            var searchLen = searchTerm.length;
            var searchNoAccent = removeAccents(searchTerm.toLowerCase());
            
            var result = '';
            var i = 0;
            
            while (i < text.length) {
                // Vérifier si on a une correspondance à cette position
                var substring = text.substr(i, searchLen);
                var substringNoAccent = removeAccents(substring.toLowerCase());
                
                if (substringNoAccent === searchNoAccent) {
                    // Correspondance trouvée - ajouter avec surbrillance
                    result += '<span class="search-highlight">' + substring + '</span>';
                    i += searchLen;
                } else {
                    // Pas de correspondance - ajouter le caractère normalement
                    result += text.charAt(i);
                    i++;
                }
            }
            
            return result;
        }
        
        // Fonction pour enlever les accents
        function removeAccents(str) {
            if (!str) return '';
            return str.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
        }

        // Charger les données
        try {
            var stored = localStorage.getItem('frigo-items');
            if (stored) items = JSON.parse(stored);
        } catch (e) {}

        function saveItems() {
            try {
                localStorage.setItem('frigo-items', JSON.stringify(items));
            } catch (e) {}
        }

        function getDays(date) {
            if (!date) return null;
            var today = new Date();
            today.setHours(0, 0, 0, 0);
            var exp = new Date(date);
            exp.setHours(0, 0, 0, 0);
            return Math.ceil((exp - today) / (1000 * 60 * 60 * 24));
        }

        function getStatus(days) {
            if (days === null) return { cls: '', text: '⚠️ Date inconnue' };
            if (days < 0) return { cls: 'expired', text: '❌ Périmé depuis ' + Math.abs(days) + 'j' };
            if (days === 0) return { cls: 'soon', text: '⚠️ Expire aujourd\'hui' };
            if (days === 1) return { cls: 'soon', text: '⚠️ Expire demain' };
            if (days <= 3) return { cls: 'soon', text: '⚠️ ' + days + ' jours restants' };
            return { cls: 'fresh', text: '✓ ' + days + ' jours restants' };
        }

        function getEmplacementInfo(emplacement) {
            var emplacements = {
                'frigo': { emoji: '🧊', text: 'Frigo' },
                'congelateur': { emoji: '❄️', text: 'Congélateur' },
                'placard': { emoji: '🚪', text: 'Placard' },
                'cave': { emoji: '🍷', text: 'Cave' },
                'corbeille': { emoji: '🧺', text: 'Corbeille' },
                'autre_emplacement': { emoji: '📍', text: 'Autre' }
            };
            return emplacements[emplacement] || emplacements['frigo'];
        }
        
        // Helper pour gérer les quantités (0 est valide, undefined/null devient 1)
        function getQuantity(qty) {
            return (qty !== undefined && qty !== null) ? qty : 1;
        }

        // === SYSTÈME DE NOTIFICATIONS ===
        
        function requestNotificationPermission() {
            if (!("Notification" in window)) {
                console.log("Ce navigateur ne supporte pas les notifications");
                return Promise.resolve("denied");
            }
            
            if (Notification.permission === "granted") {
                return Promise.resolve("granted");
            }
            
            if (Notification.permission !== "denied") {
                return Notification.requestPermission();
            }
            
            return Promise.resolve(Notification.permission);
        }
        
        function sendNotification(title, body, urgentCount) {
            // Vérifier si l'API Notification est supportée
            if (typeof Notification === 'undefined') {
                return;
            }
            
            if (Notification.permission === "granted") {
                var notification = new Notification(title, {
                    body: body,
                    icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="75" font-size="75">🧊</text></svg>',
                    badge: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="75" font-size="75">⚠️</text></svg>',
                    tag: 'frigo-alert',
                    requireInteraction: false,
                    vibrate: [200, 100, 200]
                });
                
                notification.onclick = function() {
                    window.focus();
                    // Activer le filtre "Urgent"
                    currentFilter = 'soon';
                    var filterBtns = document.querySelectorAll('.filter-btn');
                    for (var i = 0; i < filterBtns.length; i++) {
                        filterBtns[i].classList.remove('active');
                        if (filterBtns[i].getAttribute('data-f') === 'soon') {
                            filterBtns[i].classList.add('active');
                        }
                    }
                    renderItems();
                    notification.close();
                };
            }
        }
        
        function updateBadge(count) {
            if ('setAppBadge' in navigator) {
                if (count > 0) {
                    navigator.setAppBadge(count).catch(function(err) {
                        console.log('Erreur badge:', err);
                    });
                } else {
                    navigator.clearAppBadge().catch(function(err) {
                        console.log('Erreur badge:', err);
                    });
                }
            }
        }
        
        function checkUrgentProducts() {
            var today = 0;
            var tomorrow = 0;
            var twoDays = 0;
            var expired = 0;
            var outOfStock = 0;
            var toRenew = 0;
            
            // Filtrer par emplacement actuel
            var filteredByLocation = items.filter(function(item) {
                return currentEmplacement === 'all' || (item.emplacement || 'frigo') === currentEmplacement;
            });
            
            for (var i = 0; i < filteredByLocation.length; i++) {
                var days = getDays(filteredByLocation[i].datePeremption);
                var qty = getQuantity(filteredByLocation[i].quantite);
                
                // Vérifier le stock
                if (qty === 0) {
                    outOfStock++;
                }
                
                // Vérifier "à renouveler"
                if (filteredByLocation[i].aRenouveler) {
                    toRenew++;
                }
                
                // Vérifier les dates (exclure les produits avec quantité = 0)
                if (days !== null && qty > 0) {
                    if (days < 0) expired++;
                    else if (days === 0) today++;
                    else if (days === 1) tomorrow++;
                    else if (days === 2) twoDays++;
                }
            }
            
            var total = today + tomorrow + twoDays;
            
            // Mettre à jour le badge (inclure les ruptures de stock ET à renouveler)
            updateBadge(total + expired + outOfStock + toRenew);
            
            // Afficher la bannière si des produits urgents OU en rupture de stock OU à renouveler
            if (total > 0 || expired > 0 || outOfStock > 0 || toRenew > 0) {
                showAlertBanner(today, tomorrow, twoDays, expired, outOfStock, toRenew);
                
                // Afficher le prompt de notification si pas encore répondu
                var notificationAsked = localStorage.getItem('notification-asked');
                if (!notificationAsked && typeof Notification !== 'undefined' && Notification.permission === 'default') {
                    setTimeout(function() {
                        document.getElementById('notificationPrompt').classList.add('show');
                    }, 1000);
                }
                
                // Envoyer une notification si déjà autorisé
                if (typeof Notification !== 'undefined' && Notification.permission === 'granted') {
                    var notifTitle = currentLang === 'fr' ? '⚠️ Frigo Manager' : '⚠️ Fridge Manager';
                    var notifBody = '';
                    
                    if (outOfStock > 0) {
                        if (currentLang === 'fr') {
                            notifBody += '📦 ' + outOfStock + ' produit' + (outOfStock > 1 ? 's' : '') + ' épuisé' + (outOfStock > 1 ? 's' : '');
                        } else {
                            notifBody += '📦 ' + outOfStock + ' product' + (outOfStock > 1 ? 's' : '') + ' out of stock';
                        }
                    }
                    if (toRenew > 0) {
                        if (notifBody) notifBody += ' · ';
                        notifBody += '📝 ' + toRenew + ' ' + t('alerts.toRenew');
                    }
                    if (expired > 0) {
                        if (notifBody) notifBody += ' · ';
                        if (currentLang === 'fr') {
                            notifBody += expired + ' périmé' + (expired > 1 ? 's' : '');
                        } else {
                            notifBody += expired + ' expired';
                        }
                    }
                    if (today > 0) {
                        if (notifBody) notifBody += ' · ';
                        if (currentLang === 'fr') {
                            notifBody += today + ' expire' + (today > 1 ? 'nt' : '') + ' aujourd\'hui';
                        } else {
                            notifBody += today + ' expire' + (today > 1 ? 's' : '') + ' today';
                        }
                    }
                    if (tomorrow > 0) {
                        if (notifBody) notifBody += ' · ';
                        if (currentLang === 'fr') {
                            notifBody += tomorrow + ' expire' + (tomorrow > 1 ? 'nt' : '') + ' demain';
                        } else {
                            notifBody += tomorrow + ' expire' + (tomorrow > 1 ? 's' : '') + ' tomorrow';
                        }
                    }
                    
                    if (notifBody) {
                        sendNotification(notifTitle, notifBody, total);
                    }
                }
            } else {
                // Cacher la bannière s'il n'y a rien d'urgent
                document.getElementById('alertBanner').classList.remove('show');
            }
        }
        
        function showAlertBanner(today, tomorrow, twoDays, expired, outOfStock, toRenew) {
            var banner = document.getElementById('alertBanner');
            var messages = [];
            
            // Helper pour gérer le pluriel
            function plural(count, singular, plural) {
                return count > 1 ? plural : singular;
            }
            
            // Alertes de stock en premier (le plus important)
            if (outOfStock > 0) {
                if (currentLang === 'fr') {
                    messages.push('📦 ' + outOfStock + ' produit' + (outOfStock > 1 ? 's' : '') + ' ÉPUISÉ' + (outOfStock > 1 ? 'S' : ''));
                } else {
                    messages.push('📦 ' + outOfStock + ' product' + (outOfStock > 1 ? 's' : '') + ' OUT OF STOCK');
                }
            }
            if (toRenew > 0) {
                messages.push('📝 ' + toRenew + ' ' + t('alerts.toRenew'));
            }
            
            // Alertes de date
            if (expired > 0) {
                if (currentLang === 'fr') {
                    messages.push('❌ ' + expired + ' produit' + (expired > 1 ? 's périmés' : ' périmé'));
                } else {
                    messages.push('❌ ' + expired + ' product' + (expired > 1 ? 's' : '') + ' expired');
                }
            }
            if (today > 0) {
                if (currentLang === 'fr') {
                    messages.push('🔴 ' + today + ' expire' + (today > 1 ? 'nt' : '') + ' AUJOURD\'HUI');
                } else {
                    messages.push('🔴 ' + today + ' expire' + (today > 1 ? 's' : '') + ' TODAY');
                }
            }
            if (tomorrow > 0) {
                if (currentLang === 'fr') {
                    messages.push('🟠 ' + tomorrow + ' expire' + (tomorrow > 1 ? 'nt' : '') + ' demain');
                } else {
                    messages.push('🟠 ' + tomorrow + ' expire' + (tomorrow > 1 ? 's' : '') + ' tomorrow');
                }
            }
            if (twoDays > 0) {
                if (currentLang === 'fr') {
                    messages.push('🟡 ' + twoDays + ' dans 2 jours');
                } else {
                    messages.push('🟡 ' + twoDays + ' in 2 days');
                }
            }
            
            // Séparer les messages en 2 colonnes
            var stockMessages = [];
            var dateMessages = [];

            if (outOfStock > 0) stockMessages.push('📦 ' + outOfStock + ' épuisé' + (outOfStock > 1 ? 's' : ''));
            if (toRenew > 0) stockMessages.push('📝 ' + toRenew + ' ' + t('alerts.toRenew'));
            if (expired > 0) dateMessages.push('❌ ' + expired + (currentLang === 'fr' ? ' périmé' : ' expired') + (expired > 1 ? 's' : ''));
            if (today > 0) dateMessages.push('🔴 ' + today + (currentLang === 'fr' ? ' aujourd\'hui' : ' today'));
            if (tomorrow > 0) dateMessages.push('🟠 ' + tomorrow + (currentLang === 'fr' ? ' demain' : ' tomorrow'));
            if (twoDays > 0) dateMessages.push('🟡 ' + twoDays + (currentLang === 'fr' ? ' dans 2 jours' : ' in 2 days'));

            var allMessages = stockMessages.concat(dateMessages);

            var html = '<div class="alert-banner-title">' + t('alerts.title') + '</div>' +
                       '<div class="alert-banner-grid">' +
                       allMessages.map(function(m) {
                           return '<div class="alert-banner-item">' + m + '</div>';
                       }).join('') +
                       '</div>';
            
            banner.innerHTML = html;
            banner.classList.add('show');
        }
        
        function viewUrgentProducts() {
            // Compter les différents types d'alertes
            var outOfStock = 0;
            var toRenew = 0;
            var expiredOrSoon = 0;
            
            for (var i = 0; i < items.length; i++) {
                var qty = getQuantity(items[i].quantite);
                var days = getDays(items[i].datePeremption);
                
                if (qty === 0) outOfStock++;
                if (items[i].aRenouveler) toRenew++;
                if (days !== null && (days < 0 || (days >= 0 && days <= 3))) expiredOrSoon++;
            }
            
            // Choisir le filtre le plus pertinent
            if (outOfStock > 0) {
                // Priorité aux produits épuisés
                currentFilter = 'out_of_stock';
            } else if (toRenew > 0) {
                // Ensuite, les produits à renouveler
                currentFilter = 'to_renew';
            } else if (expiredOrSoon > 0) {
                // Sinon, montrer les produits qui expirent bientôt ou périmés
                currentFilter = 'soon';
            } else {
                // Par défaut, tout montrer
                currentFilter = 'all';
            }
            
            // Mettre à jour l'UI des boutons
            var filterBtns = document.querySelectorAll('.filter-btn');
            for (var i = 0; i < filterBtns.length; i++) {
                filterBtns[i].classList.remove('active');
                if (filterBtns[i].getAttribute('data-f') === currentFilter) {
                    filterBtns[i].classList.add('active');
                }
            }
            
            renderItems();
            
            // Scroller vers les produits
            document.getElementById('items').scrollIntoView({ behavior: 'smooth' });
        }
        
        // Rendre la fonction globale pour l'onclick
        window.viewUrgentProducts = viewUrgentProducts;

        function renderStats() {
            // Filtrer les items par emplacement actuel
            var filteredByLocation = items.filter(function(item) {
                return currentEmplacement === 'all' || (item.emplacement || 'frigo') === currentEmplacement;
            });
            
            var total = filteredByLocation.length;
            var exp = 0, soon = 0, outOfStock = 0;
            
            for (var i = 0; i < filteredByLocation.length; i++) {
                var d = getDays(filteredByLocation[i].datePeremption);
                var qty = getQuantity(filteredByLocation[i].quantite);
                
                if (qty === 0) outOfStock++;
                //if (d !== null && d < 0) exp++;
                //if (d !== null && d >= 0 && d <= 3) soon++;
                if (d !== null && d < 0 && qty > 0) exp++;
                if (d !== null && d >= 0 && d <= 3 && qty > 0) soon++;
            }
            
            var nums = document.querySelectorAll('.stat-card .number');
            nums[0].textContent = total;
            nums[1].textContent = soon;
            nums[2].textContent = exp;
        }

        function renderItems() {
            var filtered = items.filter(function(item) {
                var d = getDays(item.datePeremption);
                var qty = getQuantity(item.quantite);
                
                var statusMatch = false;
                if (currentFilter === 'all') statusMatch = true;
                if (currentFilter === 'expired') statusMatch = d !== null && d < 0 && qty > 0; // Exclure quantité 0
                if (currentFilter === 'soon') statusMatch = d !== null && d >= 0 && d <= 3 && qty > 0; // Exclure quantité 0
                if (currentFilter === 'fresh') statusMatch = (d === null || d > 3) && qty > 0; // Exclure quantité 0
                if (currentFilter === 'out_of_stock') statusMatch = qty === 0;
                if (currentFilter === 'to_renew') statusMatch = item.aRenouveler === true;
                
                var emplacementMatch = currentEmplacement === 'all' || (item.emplacement || 'frigo') === currentEmplacement;
                
                // Filtre de recherche
                var searchMatch = true;
                if (currentSearchTerm) {
                    var searchLower = removeAccents(currentSearchTerm.toLowerCase());
                    var nomLower = removeAccents((item.nom || '').toLowerCase());
                    var barcodeLower = (String(item.barcode || '')).toLowerCase();
                    searchMatch = nomLower.includes(searchLower) || barcodeLower.includes(searchLower);
                }
                
                return statusMatch && emplacementMatch && searchMatch;
            });
            
            var itemsEl = document.getElementById('items');
            var emptyEl = document.getElementById('empty');
            
            if (filtered.length === 0) {
                itemsEl.classList.remove('active');
                emptyEl.style.display = 'block';
            } else {
                itemsEl.classList.add('active');
                emptyEl.style.display = 'none';
                
                var html = '';
                for (var i = 0; i < filtered.length; i++) {
                    var item = filtered[i];
                    var d = getDays(item.datePeremption);
                    var s = getStatus(d);
                    
                    html += '<div class="item-card ' + s.cls + '">';
                    if (item.image) {
                        html += '<img src="' + item.image + '" class="item-image">';
                    }
                    html += '<div class="item-content">' +
                            '<div class="item-name">' + highlightText(item.nom, currentSearchTerm) + '</div>';
                    if (item.barcode) {
                        html += '<div class="barcode-badge">📊 ' + highlightText(item.barcode, currentSearchTerm) + '</div>';
                    } else {
                        html += '<div class="barcode-badge">📊 ' + highlightText("0000000000000", currentSearchTerm) + '</div>';
                    }
                    
                    if (item.emplacement) {
                        var empl = getEmplacementInfo(item.emplacement);
                        html += '<div class="emplacement-badge">' + empl.emoji + ' ' + empl.text + '</div>';
                    }
                    
                    // Afficher les badges de santé (toujours afficher les 4, même si données manquantes)
                    if (item.barcode) {
                        html += '<div class="health-badges">';
                        
                        // Nutri-Score
                        if (item.nutriScore) {
                            html += '<div class="health-badge nutri-' + item.nutriScore.toLowerCase() + '">Nutri ' + item.nutriScore + '</div>';
                        } else {
                            html += '<div class="health-badge health-badge-unknown">Nutri ?</div>';
                        }
                        
                        // NOVA Group
                        if (item.novaGroup) {
                            html += '<div class="health-badge nova-' + item.novaGroup + '">NOVA ' + item.novaGroup + '</div>';
                        } else {
                            html += '<div class="health-badge health-badge-unknown">NOVA ?</div>';
                        }
                        
                        // Additifs
                        if (item.additives !== undefined && item.additives !== null) {
                            var additivesClass = item.additives > 5 ? 'additives-high' : 'additives-badge';
                            var additivesText = item.additives === 0 ? '0 additif' : item.additives + ' additif' + (item.additives > 1 ? 's' : '');
                            html += '<div class="health-badge ' + additivesClass + '">' + additivesText + '</div>';
                        } else {
                            html += '<div class="health-badge health-badge-unknown">? additif</div>';
                        }
                        
                        // Eco-Score
                        if (item.ecoScore) {
                            html += '<div class="health-badge eco-' + item.ecoScore.toLowerCase() + '">Eco ' + item.ecoScore + '</div>';
                        } else {
                            html += '<div class="health-badge health-badge-unknown">Eco ?</div>';
                        }
                        
                        html += '</div>';
                    } else {
                        html += '<div class="health-badges">';
                        html += '<div class="barcode-badge" style="display:none;">📊 --------</div>';
                        html += '<div class="health-badge health-badge-unknown">Nutri ?</div>';
                        html += '<div class="health-badge health-badge-unknown">NOVA ?</div>';
                        html += '<div class="health-badge health-badge-unknown">? additif</div>';
                        html += '<div class="health-badge health-badge-unknown">Eco ?</div>';
                        html += '</div>';
                    }
                    
                    // Afficher la quantité
                    var qty = getQuantity(item.quantite);
                    if (qty === 0) {
                        html += '<div class="stock-alert">⚠️ ' + (currentLang === 'fr' ? 'Stock épuisé' : 'Out of stock') + '</div>';
                    }

                    // Ligne avec contrôles quantité + badge "À renouveler"
                    html += '<div style="display:flex;justify-content:space-between;align-items:center;gap:10px;margin:10px 0;">' +
                            '<div class="quantity-controls">' +
                            '<button class="btn-qty-minus" data-id="' + item.id + '">−</button>' +
                            '<span class="quantity-value">' + qty + '</span>' +
                            '<button class="btn-qty-plus" data-id="' + item.id + '">+</button>' +
                            '</div>' +
                            '<div class="renouveler-badge ' + (item.aRenouveler ? 'active' : '') + '" data-id="' + item.id + '" style="margin:0;">' +
                            (item.aRenouveler ? '📝 À renouveler' : '☐ À renouveler') +
                            '</div>' +
                            '</div>';

                    html += '<div class="item-info">📅 Ajouté: ' + new Date(item.dateAjout).toLocaleDateString('fr-FR') + '</div>' +
                            '<div class="item-info">⏰ Expire: ' + (item.datePeremption ? new Date(item.datePeremption).toLocaleDateString('fr-FR') : 'Non indiqué') + '</div>' +
                            '<div class="item-info" style="font-weight:bold;margin-top:10px;font-size:1.1em">' + s.text + '</div>' +
                            '<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px;">' +
                            '<button class="btn btn-edit" data-id="' + item.id + '" style="background:#f59e0b;padding:12px">✏️ Modifier</button>' +
                            '<button class="btn btn-delete" data-id="' + item.id + '" style="background:#ef4444;padding:12px">🗑️ Supprimer</button>' +
                            '</div>' +
                            '</div></div>';
                }
                itemsEl.innerHTML = html;
                
                // Boutons de suppression
                var deleteBtns = itemsEl.querySelectorAll('.btn-delete');
                for (var i = 0; i < deleteBtns.length; i++) {
                    deleteBtns[i].onclick = function() {
                        var id = parseFloat(this.getAttribute('data-id'));
                        if (confirm('Supprimer ce produit ?')) {
                            items = items.filter(function(it) { return it.id !== id; });
                            saveItems();
                            renderAll();
                        }
                    };
                }
                
                // Boutons de modification
                var editBtns = itemsEl.querySelectorAll('.btn-edit');
                for (var i = 0; i < editBtns.length; i++) {
                    editBtns[i].onclick = function() {
                        var id = parseFloat(this.getAttribute('data-id'));
                        editItem(id);
                    };
                }
                
                // Boutons de quantité (-)
                var minusBtns = itemsEl.querySelectorAll('.btn-qty-minus');
                for (var i = 0; i < minusBtns.length; i++) {
                    minusBtns[i].onclick = function() {
                        var id = parseFloat(this.getAttribute('data-id'));
                        changeQuantity(id, -1);
                    };
                }
                
                // Boutons de quantité (+)
                var plusBtns = itemsEl.querySelectorAll('.btn-qty-plus');
                for (var i = 0; i < plusBtns.length; i++) {
                    plusBtns[i].onclick = function() {
                        var id = parseFloat(this.getAttribute('data-id'));
                        changeQuantity(id, 1);
                    };
                }
                
                // Badges "À renouveler" cliquables
                var renouvelerBadges = itemsEl.querySelectorAll('.renouveler-badge');
                for (var i = 0; i < renouvelerBadges.length; i++) {
                    renouvelerBadges[i].onclick = function() {
                        var id = parseFloat(this.getAttribute('data-id'));
                        toggleRenouveler(id);
                    };
                }
            }
            
            // Afficher le compteur de résultats si recherche active
            var resultsInfo = document.getElementById('searchResults');
            if (currentSearchTerm && filtered.length > 0) {
                var count = filtered.length;
                var text = currentLang === 'fr' 
                    ? '✓ ' + count + ' produit' + (count > 1 ? 's' : '') + ' trouvé' + (count > 1 ? 's' : '')
                    : '✓ ' + count + ' product' + (count > 1 ? 's' : '') + ' found';
                resultsInfo.textContent = text;
                resultsInfo.style.display = 'block';
            } else {
                resultsInfo.style.display = 'none';
            }
        }

        function renderAll() {
            renderStats();
            renderItems();
            checkUrgentProducts();
        }
        
        function changeQuantity(itemId, delta) {
            var item = items.find(function(it) { return it.id === itemId; });
            if (!item) return;
            
            // Important : utiliser !== undefined au lieu de || pour gérer le cas où quantite = 0
            var currentQty = (item.quantite !== undefined && item.quantite !== null) ? item.quantite : 1;
            var newQty = currentQty + delta;
            
            // Empêcher de descendre en dessous de 0
            if (newQty < 0) {
                newQty = 0;
            }
            
            // Limiter à 99 maximum
            if (newQty > 99) {
                newQty = 99;
            }
            
            // Mettre à jour la quantité
            item.quantite = newQty;
            saveItems();
            renderAll();
        }
        
        function toggleRenouveler(itemId) {
            var item = items.find(function(it) { return it.id === itemId; });
            if (!item) return;
            
            // Basculer l'état "À renouveler"
            item.aRenouveler = !item.aRenouveler;
            
            saveItems();
            renderAll();
        }

        function startScanner() {
            var scannerEl = document.getElementById('scanner');
            scannerEl.classList.add('active');
            document.getElementById('actions').style.display = 'none';
            
            // Réinitialiser les variables de scan
            lastScannedCode = null;
            scanConfidenceCount = {};
            scanningActive = true;
            
            Quagga.init({
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: document.querySelector('#scanner-container'),
                    constraints: {
                        facingMode: "environment",
                        width: { min: 640, ideal: 1280, max: 1920 },
                        height: { min: 480, ideal: 720, max: 1080 }
                    }
                },
                locator: {
                    patchSize: "medium",
                    halfSample: true
                },
                numOfWorkers: 2,
                frequency: 10,
                decoder: {
                    readers: ["ean_reader", "ean_8_reader", "upc_reader", "upc_e_reader"]
                },
                locate: true
            }, function(err) {
                if (err) {
                    console.error(err);
                    
                    // Afficher un message d'erreur plus clair avec le bouton saisie manuelle
                    var scannerInstructions = document.querySelector('.scanner-instructions');
                    if (scannerInstructions) {
                        scannerInstructions.innerHTML = 
                            '<div style="color: #ef4444; font-size: 1.2em; padding: 20px;">' +
                            '⚠️ Caméra non accessible<br>' +
                            '<span style="font-size: 0.9em;">Utilisez la saisie manuelle ci-dessous</span>' +
                            '</div>';
                    }
                    
                    // Rendre le bouton saisie manuelle encore plus visible
                    var btnManual = document.getElementById('btnManualFromScanner');
                    if (btnManual) {
                        btnManual.style.background = '#10b981';
                        btnManual.style.fontSize = '1.3em';
                        btnManual.style.animation = 'pulse 1.5s infinite';
                    }
                    
                    return;
                }
                Quagga.start();
            });

            Quagga.onDetected(function(result) {
                if (!scanningActive) return;
                
                var code = result.codeResult.code;
                
                // Valider le format du code-barres
                if (!code || code.length < 8 || code.length > 13) return;
                if (!/^\d+$/.test(code)) return; // Seulement des chiffres
                
                // Système de confiance : détecter 2 fois le même code
                if (!scanConfidenceCount[code]) {
                    scanConfidenceCount[code] = 0;
                }
                scanConfidenceCount[code]++;
                
                console.log("Code détecté:", code, "Confiance:", scanConfidenceCount[code]);
                
                // Si détecté 2 fois (réduit de 3 à 2)
                if (scanConfidenceCount[code] >= 2) {
                    scanningActive = false;
                    
                    // Feedback visuel
                    var overlay = document.querySelector('.scanner-overlay');
                    overlay.style.borderColor = '#38ef7d';
                    overlay.style.boxShadow = '0 0 0 9999px rgba(0,0,0,0.8), 0 0 30px #38ef7d';
                    
                    // Vibration si disponible
                    if (navigator.vibrate) {
                        navigator.vibrate(200);
                    }
                    
                    setTimeout(function() {
                        stopScanner();
                        confirmBarcode(code);
                    }, 500);
                }
            });
        }
        
        function confirmBarcode(code) {
            var message = "Code-barres détecté :\n\n" + code + "\n\nRechercher ce produit ?";
            if (confirm(message)) {
                searchProduct(code);
            } else {
                // Rescanner
                document.getElementById('actions').style.display = 'grid';
            }
        }

        function stopScanner() {
            try {
                Quagga.stop();
            } catch (e) {
                console.log("Quagga déjà arrêté");
            }
            document.getElementById('scanner').classList.remove('active');
            document.getElementById('actions').style.display = 'grid';
            
            // Réinitialiser le style de l'overlay
            var overlay = document.querySelector('.scanner-overlay');
            if (overlay) {
                overlay.style.borderColor = '#38ef7d';
                overlay.style.boxShadow = '0 0 0 9999px rgba(0,0,0,0.5)';
            }
            
            scanningActive = false;
            lastScannedCode = null;
            scanConfidenceCount = {};
        }

        function searchProduct(barcode) {
            currentBarcode = barcode;
            document.getElementById('loading').classList.add('active');
            document.getElementById('loadingBarcode').textContent = 'Code: ' + barcode;
            
            fetch('https://world.openfoodfacts.org/api/v2/product/' + barcode + '.json')
                .then(function(response) { return response.json(); })
                .then(function(data) {
                    document.getElementById('loading').classList.remove('active');
                    
                    if (data.status === 1 && data.product) {
                        var product = data.product;
                        
                        // Eco-Score : essayer plusieurs champs possibles
                        var ecoScore = null;
                        if (product.ecoscore_grade) {
                            var ecoValue = product.ecoscore_grade.toUpperCase();
                            // Nettoyer les valeurs bizarres comme "A-PLUS" → "A"
                            ecoValue = ecoValue.replace('-PLUS', '').replace('-MINUS', '').trim();
                            // Vérifier que c'est une lettre A-F valide
                            if (ecoValue.match(/^[A-F]$/) && ecoValue !== 'NOT-APPLICABLE' && ecoValue !== 'UNKNOWN') {
                                ecoScore = ecoValue;
                            }
                        } else if (product.ecoscoreGrade) {
                            var ecoValue2 = product.ecoscoreGrade.toUpperCase();
                            ecoValue2 = ecoValue2.replace('-PLUS', '').replace('-MINUS', '').trim();
                            if (ecoValue2.match(/^[A-F]$/) && ecoValue2 !== 'NOT-APPLICABLE' && ecoValue2 !== 'UNKNOWN') {
                                ecoScore = ecoValue2;
                            }
                        } else if (product.ecoscore_score !== undefined && product.ecoscore_score !== null) {
                            // Convertir le score numérique en lettre
                            if (product.ecoscore_score >= 80) {
                                ecoScore = 'A';
                            } else if (product.ecoscore_score >= 60) {
                                ecoScore = 'B';
                            } else if (product.ecoscore_score >= 40) {
                                ecoScore = 'C';
                            } else if (product.ecoscore_score >= 20) {
                                ecoScore = 'D';
                            } else if (product.ecoscore_score >= 0) {
                                ecoScore = 'E';
                            }
                        }
                        
                        // Nettoyer Nutri-Score
                        var nutriValue = null;
                        if (product.nutriscore_grade) {
                            var nutriTemp = product.nutriscore_grade.toUpperCase();
                            // Ignorer les valeurs non valides
                            if (nutriTemp !== 'NOT-APPLICABLE' && nutriTemp !== 'UNKNOWN' && nutriTemp !== 'NOT-KNOWN' && nutriTemp.match(/^[A-E]$/)) {
                                nutriValue = nutriTemp;
                            }
                        }
                        
                        currentProductData = {
                            nom: product.product_name || product.generic_name || 'Produit inconnu',
                            image: product.image_url || product.image_front_url || null,
                            categorie: detectCategory(product),
                            barcode: barcode,
                            nutriScore: nutriValue,
                            novaGroup: product.nova_group || null,
                            additives: product.additives_n || 0,
                            ecoScore: ecoScore
                        };
                        
                        showForm(currentProductData);
                    } else {
                        alert(t('messages.productNotFound'));
                        showForm({ barcode: barcode });
                    }
                })
                .catch(function(error) {
                    console.error('Erreur:', error);
                    document.getElementById('loading').classList.remove('active');
                    alert(t('messages.connectionError'));
                    showForm({ barcode: barcode });
                });
        }

        function detectCategory(product) {
            var categories = product.categories || '';
            categories = categories.toLowerCase();
            
            if (categories.indexOf('fruit') !== -1) return 'fruit';
            if (categories.indexOf('vegetable') !== -1 || categories.indexOf('légume') !== -1) return 'legume';
            if (categories.indexOf('meat') !== -1 || categories.indexOf('viande') !== -1) return 'viande';
            if (categories.indexOf('fish') !== -1 || categories.indexOf('poisson') !== -1) return 'poisson';
            if (categories.indexOf('dairy') !== -1 || categories.indexOf('lait') !== -1 || categories.indexOf('fromage') !== -1) return 'produit_laitier';
            if (categories.indexOf('beverage') !== -1 || categories.indexOf('boisson') !== -1 || categories.indexOf('drink') !== -1) return 'boisson';
            
            return 'autre';
        }

        // Fonctions pour toggle le checkbox personnalisé "À renouveler"
        function toggleRenouvelerAdd() {
            var checkbox = document.getElementById('formRenouveler');
            var box = document.getElementById('checkboxBoxAdd');
            if (checkbox && box) {
                checkbox.checked = !checkbox.checked;
                box.textContent = checkbox.checked ? '☑️' : '☐';
                box.style.color = checkbox.checked ? '#667eea' : '#999';
            }
        }
        
        function toggleRenouvelerEdit() {
            var checkbox = document.getElementById('formRenouveler');
            var box = document.getElementById('checkboxBoxEdit');
            if (checkbox && box) {
                checkbox.checked = !checkbox.checked;
                box.textContent = checkbox.checked ? '☑️' : '☐';
                box.style.color = checkbox.checked ? '#667eea' : '#999';
            }
        }

        function showForm(productData) {
            productData = productData || {};
            var form = document.getElementById('form');
            
            // Emplacement par défaut : utiliser le filtre actuel si sélectionné
            var defaultEmplacement = productData.emplacement;
            if (!defaultEmplacement) {
                // Si un filtre d'emplacement spécifique est actif, l'utiliser
                defaultEmplacement = (currentEmplacement !== 'all') ? currentEmplacement : 'frigo';
            }
            
           // Date suggérée : calcul automatique selon catégorie + emplacement
            var categorie = productData.categorie || 'autre';
            var emplacement = defaultEmplacement;
            var suggestedDate = calculerNouvelleDate(categorie, emplacement);
            var suggestedDateStr = suggestedDate || (productData.datePeremption || '');
            
            var html = '<h3>➕ ' + (currentLang === 'fr' ? 'Ajouter un produit' : 'Add product') + '</h3>';
            
            if (productData.barcode) {
                html += '<div class="barcode-badge clickable" id="barcodeBadgeAdd" style="display: inline-block;">📊 ' + (currentLang === 'fr' ? 'Code-barres: ' : 'Barcode: ') + productData.barcode + '</div>';
                if (!productData.image) {
                    html += '<div class="date-suggestion" style="margin-top: 5px;">💡 ' + (currentLang === 'fr' ? 'Cliquez sur le code-barres pour récupérer photo + scores santé' : 'Click barcode to retrieve photo + health scores') + '</div>';
                }
            }
            
            html += '<div class="form-group">';
            if (productData.image) {
                html += '<img src="' + productData.image + '" class="preview-img" id="previewImage">';
                html += '<button type="button" class="btn" id="btnRemovePhoto" style="background:#ef4444;padding:10px;font-size:14px;margin:5px 0;">✕ ' + (currentLang === 'fr' ? 'Supprimer la photo' : 'Remove photo') + '</button>';
            } else {
                html += '<div id="previewImage" class="preview-placeholder">📷 ' + (currentLang === 'fr' ? 'Aucune photo' : 'No photo') + '</div>';
            }
            html += '<input type="file" id="customPhoto" accept="image/*" capture="environment" style="display: none;">';
            html += '<label for="customPhoto" class="btn" style="background:#f59e0b;padding:12px;font-size:16px;margin:10px 0;">📸 ' + (productData.image ? (currentLang === 'fr' ? 'Changer' : 'Change') : (currentLang === 'fr' ? 'Prendre' : 'Take')) + ' ' + (currentLang === 'fr' ? 'la photo' : 'photo') + '</label>';
            html += '<div class="date-suggestion" style="margin-top: 5px;">💡 ' + (currentLang === 'fr' ? 'La photo augmente la taille de stockage' : 'Photo increases storage size') + '</div>';
            html += '</div>';
            
            html += '<div class="form-group">' +
                    '<label for="formNom">' + t('form.name') + ' *</label>' +
                    '<input type="text" id="formNom" placeholder="' + (currentLang === 'fr' ? 'Ex: Lait, Yaourt, Pommes...' : 'E.g: Milk, Yogurt, Apples...') + '" value="' + (productData.nom || '') + '">' +
                    '</div>' +
                    '<div class="form-group">' +
                    '<label for="formDate">' + t('form.expiry') + '</label>' +
                    '<input type="date" id="formDate" value="' + suggestedDateStr + '">' +
                    '<div class="date-suggestion">💡 ' + (currentLang === 'fr' ? 'Date suggérée : +7 jours (modifiable)' : 'Suggested date: +7 days (editable)') + '</div>' +
                    '</div>' +
                    '<div class="form-group">' +
                    '<label for="formCategorie">' + t('form.category') + '</label>' +
                    '<select id="formCategorie">' +
                    '<option value="fruit"' + (productData.categorie === 'fruit' ? ' selected' : '') + '>🍎 ' + t('categories.Fruits') + '</option>' +
                    '<option value="legume"' + (productData.categorie === 'legume' ? ' selected' : '') + '>🥕 ' + t('categories.Légumes') + '</option>' +
                    '<option value="viande"' + (productData.categorie === 'viande' ? ' selected' : '') + '>🥩 ' + t('categories.Viande') + '</option>' +
                    '<option value="poisson"' + (productData.categorie === 'poisson' ? ' selected' : '') + '>🐟 ' + t('categories.Poisson') + '</option>' +
                    '<option value="produit_laitier"' + (productData.categorie === 'produit_laitier' ? ' selected' : '') + '>🥛 ' + t('categories.Produits_laitiers') + '</option>' +
                    '<option value="viennoiseries"' + (productData.categorie === 'viennoiseries' ? ' selected' : '') + '>🥐 ' + t('categories.Viennoiseries') + '</option>' +
                    '<option value="conserves"' + (productData.categorie === 'conserves' ? ' selected' : '') + '>🥫 ' + t('categories.Conserves') + '</option>' +
                    '<option value="boisson"' + (productData.categorie === 'boisson' ? ' selected' : '') + '>🥤 ' + t('categories.Boissons') + '</option>' +
                    '<option value="autre"' + (productData.categorie === 'autre' || !productData.categorie ? ' selected' : '') + '>📦 ' + t('categories.Autre') + '</option>' +
                    '</select>' +
                    '</div>' +
                    '<div class="form-group">' +
                    '<label for="formEmplacement">' + t('form.location') + '</label>' +
                    '<select id="formEmplacement">' +
                    '<option value="frigo"' + (defaultEmplacement === 'frigo' ? ' selected' : '') + '>🧊 ' + t('locations.frigo') + '</option>' +
                    '<option value="congelateur"' + (defaultEmplacement === 'congelateur' ? ' selected' : '') + '>❄️ ' + t('locations.congelateur') + '</option>' +
                    '<option value="placard"' + (defaultEmplacement === 'placard' ? ' selected' : '') + '>🚪 ' + t('locations.placard') + '</option>' +
                    '<option value="cave"' + (defaultEmplacement === 'cave' ? ' selected' : '') + '>🍷 ' + (currentLang === 'fr' ? 'Cave' : 'Cellar') + '</option>' +
                    '<option value="corbeille"' + (defaultEmplacement === 'corbeille' ? ' selected' : '') + '>🧺 ' + (currentLang === 'fr' ? 'Corbeille' : 'Basket') + '</option>' +
                    '<option value="autre_emplacement"' + (defaultEmplacement === 'autre_emplacement' ? ' selected' : '') + '>📍 ' + t('locations.autre') + '</option>' +
                    '</select>' +
                    '</div>' +
                    '<div class="form-group">' +
                    '<label for="formQuantite">' + t('form.quantity') + '</label>' +
                    '<div style="display: flex; align-items: center; gap: 10px;">' +
                    '<button type="button" class="btn-quantity" id="btnMinus">−</button>' +
                    '<input type="number" id="formQuantite" value="' + getQuantity(productData.quantite) + '" min="0" max="99" style="width: 80px; text-align: center; font-size: 18px; font-weight: bold;">' +
                    '<button type="button" class="btn-quantity" id="btnPlus">+</button>' +
                    '</div>' +
                    '<div class="date-suggestion">💡 ' + (currentLang === 'fr' ? 'Nombre d\'unités' : 'Number of units') + '</div>' +
                    '</div>' +
                    '<div class="form-group" style="margin-top: 15px;">' +
                    '<label id="labelRenouvelerAdd" style="cursor: pointer; margin: 0; font-weight: 600; display: flex; align-items: center; gap: 15px; padding: 15px; background: #f5f5f5; border-radius: 10px; user-select: none; -webkit-tap-highlight-color: transparent;">' +
                    '<input type="checkbox" id="formRenouveler" ' + (productData.aRenouveler ? 'checked' : '') + ' style="display: none;">' +
                    '<span id="checkboxBoxAdd" style="font-size: 32px; line-height: 1; color: ' + (productData.aRenouveler ? '#667eea' : '#999') + ';">' + (productData.aRenouveler ? '☑️' : '☐') + '</span>' +
                    '<span style="flex: 1;">📝 ' + (currentLang === 'fr' ? 'À renouveler (ajouter à la liste de courses)' : 'To renew (add to shopping list)') + '</span>' +
                    '</label>' +
                    '</div>' +
                    '<button class="btn" id="btnAdd" style="background:#667eea;font-size:18px;padding:15px;margin-top:10px">✓ ' + (currentLang === 'fr' ? 'Ajouter' : 'Add') + '</button>' +
                    '<button class="btn" id="btnCancel" style="background:#ccc;color:#333;font-size:18px;padding:15px">✕ ' + t('form.cancel') + '</button>';
            
            form.innerHTML = html;
            form.classList.add('active');
            document.getElementById('actions').style.display = 'none';
            document.getElementById('stats').style.display = 'none';
            
            // Gestion de la photo personnalisée
            var customImageData = productData.image || null;
            var savedBarcode = productData.barcode || null; // Sauvegarder le barcode dans la portée
            var savedNutriScore = productData.nutriScore || null;
            var savedNovaGroup = productData.novaGroup || null;
            var savedAdditives = productData.additives !== undefined ? productData.additives : null;
            var savedEcoScore = productData.ecoScore || null;
            
            // Bouton pour supprimer la photo (si elle existe)
            var btnRemovePhoto = document.getElementById('btnRemovePhoto');
            if (btnRemovePhoto) {
                btnRemovePhoto.onclick = function() {
                    if (confirm(currentLang === 'fr' ? 'Supprimer la photo ?\nCela économisera de l\'espace de stockage.' : 'Remove photo?\nThis will save storage space.')) {
                        customImageData = null;
                        var preview = document.getElementById('previewImage');
                        preview.outerHTML = '<div id="previewImage" class="preview-placeholder">📷 ' + (currentLang === 'fr' ? 'Aucune photo' : 'No photo') + '</div>';
                        document.querySelector('label[for="customPhoto"]').innerHTML = '📸 ' + (currentLang === 'fr' ? 'Prendre la photo' : 'Take photo');
                        btnRemovePhoto.style.display = 'none';
                    }
                };
            }
            
            // Gestion de la quantité avec boutons +/-
            var quantityInput = document.getElementById('formQuantite');
            document.getElementById('btnPlus').onclick = function() {
                var val = parseInt(quantityInput.value);
                if (isNaN(val)) val = 0;
                if (val < 99) quantityInput.value = val + 1;
            };
            document.getElementById('btnMinus').onclick = function() {
                var val = parseInt(quantityInput.value);
                if (isNaN(val)) val = 1;
                if (val > 0) quantityInput.value = val - 1;
            };
            
            // Event listener pour iOS - Checkbox "À renouveler"
            var labelRenouveler = document.getElementById('labelRenouvelerAdd');
            if (labelRenouveler) {
                labelRenouveler.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    toggleRenouvelerAdd();
                });
                labelRenouveler.addEventListener('touchend', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    toggleRenouvelerAdd();
                });
            }
            
            // Event listener pour cliquer sur le code-barres et récupérer la photo
            var barcodeBadgeAdd = document.getElementById('barcodeBadgeAdd');
            if (barcodeBadgeAdd && productData.barcode) {
                barcodeBadgeAdd.onclick = function() {
                    var msg = currentLang === 'fr' ? 
                        'Récupérer les données depuis la base de données ?\n\n• Photo du produit\n• Scores de santé (Nutri-Score, NOVA, Additifs, Eco-Score)\n\n⏳ Patientez pendant le chargement...' :
                        'Retrieve data from database?\n\n• Product photo\n• Health scores (Nutri-Score, NOVA, Additives, Eco-Score)\n\n⏳ Please wait during loading...';
                    
                    if (confirm(msg)) {
                        // Afficher un loader visible
                        var badge = document.getElementById('barcodeBadgeAdd');
                        var originalText = badge.innerHTML;
                        var originalBg = badge.style.background;
                        badge.innerHTML = '⏳ ' + (currentLang === 'fr' ? 'Chargement en cours...' : 'Loading...');
                        badge.style.background = '#fbbf24';
                        badge.style.animation = 'pulse 1.5s infinite';
                        
                        // Afficher l'écran de loading
                        document.getElementById('loading').classList.add('active');
                        document.getElementById('loadingBarcode').textContent = (currentLang === 'fr' ? 'Récupération des données...' : 'Retrieving data...');
                        
                        // Appeler l'API Open Food Facts
                        fetch('https://world.openfoodfacts.org/api/v2/product/' + productData.barcode + '.json')
                            .then(function(response) { return response.json(); })
                            .then(function(data) {
                                document.getElementById('loading').classList.remove('active');
                                
                                if (data.status === 1 && data.product) {
                                    var product = data.product;
                                    var updates = [];
                                    
                                    // Récupérer la photo
                                    if (product.image_url) {
                                        customImageData = product.image_url;
                                        
                                        // Mettre à jour l'aperçu
                                        var preview = document.getElementById('previewImage');
                                        preview.outerHTML = '<img src="' + customImageData + '" class="preview-img" id="previewImage">' +
                                            '<button type="button" class="btn" id="btnRemovePhoto" style="background:#ef4444;padding:10px;font-size:14px;margin:5px 0;">✕ ' + (currentLang === 'fr' ? 'Supprimer la photo' : 'Remove photo') + '</button>';
                                        
                                        // Réattacher l'event listener au nouveau bouton
                                        var newBtnRemove = document.getElementById('btnRemovePhoto');
                                        if (newBtnRemove) {
                                            newBtnRemove.onclick = function() {
                                                if (confirm(currentLang === 'fr' ? 'Supprimer la photo ?\nCela économisera de l\'espace de stockage.' : 'Remove photo?\nThis will save storage space.')) {
                                                    customImageData = null;
                                                    var preview = document.getElementById('previewImage');
                                                    preview.outerHTML = '<div id="previewImage" class="preview-placeholder">📷 ' + (currentLang === 'fr' ? 'Aucune photo' : 'No photo') + '</div>';
                                                    document.querySelector('label[for="customPhoto"]').innerHTML = '📸 ' + (currentLang === 'fr' ? 'Prendre la photo' : 'Take photo');
                                                    newBtnRemove.style.display = 'none';
                                                }
                                            };
                                        }
                                        
                                        // Changer le texte du bouton photo
                                        document.querySelector('label[for="customPhoto"]').innerHTML = '📸 ' + (currentLang === 'fr' ? 'Changer la photo' : 'Change photo');
                                        
                                        updates.push(currentLang === 'fr' ? 'Photo' : 'Photo');
                                    }
                                    
                                    // Récupérer Nutri-Score
                                    if (product.nutriscore_grade) {
                                        var nutriTemp = product.nutriscore_grade.toUpperCase();
                                        // Ignorer les valeurs non valides
                                        if (nutriTemp !== 'NOT-APPLICABLE' && nutriTemp !== 'UNKNOWN' && nutriTemp !== 'NOT-KNOWN' && nutriTemp.match(/^[A-E]$/)) {
                                            savedNutriScore = nutriTemp;
                                            updates.push('Nutri-Score ' + savedNutriScore);
                                        }
                                    }
                                    
                                    // Récupérer NOVA
                                    if (product.nova_group) {
                                        savedNovaGroup = product.nova_group;
                                        updates.push('NOVA ' + savedNovaGroup);
                                    }
                                    
                                    // Récupérer Additifs
                                    if (product.additives_n !== undefined) {
                                        savedAdditives = product.additives_n;
                                        updates.push((savedAdditives === 0 ? (currentLang === 'fr' ? 'Sans additif' : 'No additives') : savedAdditives + ' ' + (currentLang === 'fr' ? 'additifs' : 'additives')));
                                    }
                                    
                                    // Récupérer Eco-Score
                                    var ecoScore = null;
                                    if (product.ecoscore_grade) {
                                        var ecoValue = product.ecoscore_grade.toUpperCase();
                                        // Nettoyer les valeurs bizarres comme "A-PLUS" → "A"
                                        ecoValue = ecoValue.replace('-PLUS', '').replace('-MINUS', '').trim();
                                        // Vérifier que c'est une lettre A-F valide
                                        if (ecoValue.match(/^[A-F]$/) && ecoValue !== 'NOT-APPLICABLE' && ecoValue !== 'UNKNOWN') {
                                            ecoScore = ecoValue;
                                        }
                                    } else if (product.ecoscore_score !== undefined && product.ecoscore_score !== null) {
                                        if (product.ecoscore_score >= 80) ecoScore = 'A';
                                        else if (product.ecoscore_score >= 60) ecoScore = 'B';
                                        else if (product.ecoscore_score >= 40) ecoScore = 'C';
                                        else if (product.ecoscore_score >= 20) ecoScore = 'D';
                                        else if (product.ecoscore_score >= 0) ecoScore = 'E';
                                    }
                                    if (ecoScore) {
                                        savedEcoScore = ecoScore;
                                        updates.push('Eco-Score ' + ecoScore);
                                    }
                                    
                                    // Restaurer le badge
                                    badge.innerHTML = originalText;
                                    badge.style.background = originalBg;
                                    badge.style.animation = '';
                                    
                                    if (updates.length > 0) {
                                        var successMsg = currentLang === 'fr' ? 
                                            '✅ Données récupérées !\n\n' + updates.join('\n') + '\n\n💾 Cliquez sur "Ajouter" pour sauvegarder le produit.' :
                                            '✅ Data retrieved!\n\n' + updates.join('\n') + '\n\n💾 Click "Add" to save the product.';
                                        alert(successMsg);
                                    } else {
                                        var noDataMsg = currentLang === 'fr' ?
                                            '⚠️ Aucune donnée supplémentaire disponible.' :
                                            '⚠️ No additional data available.';
                                        alert(noDataMsg);
                                    }
                                } else {
                                    badge.innerHTML = originalText;
                                    badge.style.background = originalBg;
                                    badge.style.animation = '';
                                    var noDataMsg = currentLang === 'fr' ?
                                        '❌ Produit non trouvé dans la base de données.' :
                                        '❌ Product not found in database.';
                                    alert(noDataMsg);
                                }
                            })
                            .catch(function(error) {
                                document.getElementById('loading').classList.remove('active');
                                badge.innerHTML = originalText;
                                badge.style.background = originalBg;
                                badge.style.animation = '';
                                var errorMsg = currentLang === 'fr' ?
                                    '❌ Erreur lors de la récupération des données.\n\nVérifiez votre connexion Internet.' :
                                    '❌ Error retrieving data.\n\nCheck your Internet connection.';
                                alert(errorMsg);
                                console.error(error);
                            });
                    }
                };
            }
            
            document.getElementById('customPhoto').addEventListener('change', function(e) {
                var file = e.target.files[0];
                if (!file) return;
                
                var reader = new FileReader();
                reader.onload = function(event) {
                    customImageData = event.target.result;
                    var preview = document.getElementById('previewImage');
                    if (preview.tagName === 'IMG') {
                        preview.src = customImageData;
                    } else {
                        var photoLabel = document.querySelector('label[for="customPhoto"]');
                        preview.outerHTML = '<img src="' + customImageData + '" class="preview-img" id="previewImage">' +
                            '<button type="button" class="btn" id="btnRemovePhoto" style="background:#ef4444;padding:10px;font-size:14px;margin:5px 0;">✕ ' + (currentLang === 'fr' ? 'Supprimer la photo' : 'Remove photo') + '</button>';
                        
                        // Ajouter l'event listener au nouveau bouton
                        var newBtnRemove = document.getElementById('btnRemovePhoto');
                        if (newBtnRemove) {
                            newBtnRemove.onclick = function() {
                                if (confirm(currentLang === 'fr' ? 'Supprimer la photo ?\nCela économisera de l\'espace de stockage.' : 'Remove photo?\nThis will save storage space.')) {
                                    customImageData = null;
                                    var preview = document.getElementById('previewImage');
                                    preview.outerHTML = '<div id="previewImage" class="preview-placeholder">📷 ' + (currentLang === 'fr' ? 'Aucune photo' : 'No photo') + '</div>';
                                    document.querySelector('label[for="customPhoto"]').innerHTML = '📸 ' + (currentLang === 'fr' ? 'Prendre la photo' : 'Take photo');
                                    newBtnRemove.style.display = 'none';
                                }
                            };
                        }
                    }
                    // Changer le texte du bouton
                    document.querySelector('label[for="customPhoto"]').innerHTML = '📸 ' + (currentLang === 'fr' ? 'Changer la photo' : 'Change photo');
                };
                reader.readAsDataURL(file);
            });
            
            // Event listeners pour recalculer automatiquement la date lors du changement de catégorie ou d'emplacement
            var formCategorie = document.getElementById('formCategorie');
            var formEmplacement = document.getElementById('formEmplacement');
            var formDate = document.getElementById('formDate');
            
            function recalculerDate() {
                var categorie = formCategorie.value;
                var emplacement = formEmplacement.value;
                var nouvelleDate = calculerNouvelleDate(categorie, emplacement);
                if (nouvelleDate) {
                    formDate.value = nouvelleDate;
                }
            }
            
            if (formCategorie) {
                formCategorie.addEventListener('change', recalculerDate);
            }
            if (formEmplacement) {
                formEmplacement.addEventListener('change', recalculerDate);
            }
            
            document.getElementById('btnAdd').onclick = function() {
                var nom = document.getElementById('formNom').value.trim();
                if (!nom) {
                    alert('Veuillez entrer un nom de produit');
                    return;
                }
                
                var dateValue = document.getElementById('formDate').value;
                
                var newItem = {
                    id: Date.now() + Math.random(),
                    nom: nom,
                    datePeremption: dateValue || null,
                    categorie: document.getElementById('formCategorie').value,
                    emplacement: document.getElementById('formEmplacement').value,
                    quantite: parseInt(document.getElementById('formQuantite').value) || 1,
                    aRenouveler: document.getElementById('formRenouveler').checked,
                    dateAjout: new Date().toISOString().split('T')[0],
                    image: customImageData,
                    barcode: savedBarcode,
                    nutriScore: savedNutriScore,
                    novaGroup: savedNovaGroup,
                    additives: savedAdditives,
                    ecoScore: savedEcoScore
                };
                
                items.unshift(newItem);
                saveItems();
                closeForm();
                renderAll();
            };
            
            document.getElementById('btnCancel').onclick = closeForm;
            
            setTimeout(function() {
                document.getElementById('formNom').focus();
            }, 100);
        }

        // === FONCTIONS IMPORT/EXPORT ===
        
        function toggleSettings() {
            var menu = document.getElementById('settingsMenu');
            menu.classList.toggle('active');
        }
        
        function showHealthGuide() {
            // Fermer le menu des paramètres
            document.getElementById('settingsMenu').classList.remove('active');
            // Ouvrir le guide
            document.getElementById('healthGuide').classList.add('active');
        }
        
        function closeHealthGuide() {
            document.getElementById('healthGuide').classList.remove('active');
        }
        
        function showDurationTable() {
            // Fermer le menu des paramètres
            document.getElementById('settingsMenu').classList.remove('active');
            // Ouvrir la table
            document.getElementById('durationTableModal').classList.add('active');
        }
        
        function closeDurationTable() {
            document.getElementById('durationTableModal').classList.remove('active');
        }
        
        function showChangelog() {
            // Fermer le menu des paramètres
            document.getElementById('settingsMenu').classList.remove('active');
            
            // Générer le contenu du changelog
            var html = '<h3 style="margin-top: 0; color: #667eea;">🎉 Quoi de neuf ?</h3>';
            
            // Parcourir toutes les versions du changelog
            for (var version in CHANGELOG) {
                var versionData = CHANGELOG[version];
                var changes = versionData.changes[currentLang];
                var isLatest = version === APP_VERSION;
                
                html += '<div class="settings-section" style="' + (isLatest ? 'background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); border: 2px solid #3b82f6;' : '') + '">';
                html += '<h4 style="color: ' + (isLatest ? '#1e40af' : '#667eea') + ';">';
                if (isLatest) html += '✨ ';
                html += 'Version ' + version;
                if (isLatest) html += ' (Actuelle)';
                html += '</h4>';
                html += '<p style="font-size: 0.85em; color: #64748b; margin-bottom: 10px;">📅 ' + versionData.date + '</p>';
                html += '<ul style="margin: 10px 0; padding-left: 20px; font-size: 0.9em;">';
                
                changes.forEach(function(change) {
                    html += '<li style="margin: 8px 0; color: #334155;">' + change + '</li>';
                });
                
                html += '</ul></div>';
            }
            
            html += '<button class="btn" onclick="closeChangelog()" style="background: #667eea; color: white; margin-top: 20px;">✕ Fermer</button>';
            
            // Afficher dans une modal
            document.getElementById('changelogContent').innerHTML = html;
            document.getElementById('changelogModal').classList.add('active');
        }
        
        function closeChangelog() {
            document.getElementById('changelogModal').classList.remove('active');
        }
        
        function cleanRecipes() {
            var userRecipes = JSON.parse(localStorage.getItem('userRecipes') || '[]');
            var predefinedCount = userRecipes.filter(r => r.id < 1000).length;
            
            if (predefinedCount === 0) {
                alert('ℹ️ Aucune recette prédéfinie à supprimer.');
                return;
            }
            
            if (!confirm('⚠️ Supprimer ' + predefinedCount + ' recette(s) prédéfinie(s) ?\n\nCette action est irréversible.')) {
                return;
            }
            
            var cleaned = userRecipes.filter(recipe => recipe.id >= 1000);
            localStorage.setItem('userRecipes', JSON.stringify(cleaned));
            
            alert('✅ ' + predefinedCount + ' recette(s) prédéfinie(s) supprimée(s) !\n' +
                  'Recettes personnalisées conservées : ' + cleaned.length);
            
            openRecipes();
        }
        
        // === FONCTIONS EXPORT/IMPORT RECETTES CSV ===
        
        function exportRecipesCSV() {
            try {
                var userRecipes = JSON.parse(localStorage.getItem('userRecipes') || '[]');
                var allRecipes = userRecipes;
                        
                if (allRecipes.length === 0) {
                    alert('❌ Aucune recette à exporter');
                    return;
                }
                
                var csv = 'Nom,Icône,Temps,Difficulté,Portions,Ingrédients,Étapes\n';
                
                allRecipes.forEach(function(recipe) {
                    var name = '"' + recipe.name.replace(/"/g, '""') + '"';
                    var icon = '"' + recipe.icon + '"';
                    var time = '"' + recipe.time + '"';
                    var difficulty = '"' + recipe.difficulty + '"';
                    var servings = recipe.servings;
                    var ingredients = '"' + recipe.ingredients.join(';').replace(/"/g, '""') + '"';
                    var steps = '"' + recipe.steps.join(';').replace(/"/g, '""') + '"';
                    csv += name + ',' + icon + ',' + time + ',' + difficulty + ',' + servings + ',' + ingredients + ',' + steps + '\n';
                });
                
                var blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
                var filename = 'recettes-frigo-manager-' + new Date().toISOString().split('T')[0] + '.csv';

                if (Filesystem) {
                    var reader = new FileReader();
                    reader.onloadend = async function() {
                        try {
                            var base64Data = reader.result.split(',')[1];
                            
                            await Filesystem.writeFile({
                                path: filename,
                                data: base64Data,
                                directory: 'DOCUMENTS'
                            });

                            // Toast de confirmation
                            var toast = document.createElement('div');
                            toast.textContent = '✅ ' + allRecipes.length + ' recettes exportées : ' + filename;
                            toast.style.cssText = 'position:fixed;bottom:40px;left:50%;transform:translateX(-50%);background:#4CAF50;color:white;padding:14px 22px;border-radius:12px;z-index:9999;font-size:14px;text-align:center;box-shadow:0 4px 12px rgba(0,0,0,0.3);';
                            document.body.appendChild(toast);
                            setTimeout(() => toast.remove(), 3000);

                        } catch (err) {
                            console.error('Erreur export:', err);
                            alert('❌ Erreur : ' + err.message);
                        }
                    };
                    reader.readAsDataURL(blob);
                } else {
                    // Fallback navigateur
                    var url = URL.createObjectURL(blob);
                    var link = document.createElement('a');
                    link.href = url;
                    link.download = filename;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                    alert(tm('messages.recipesExported', {count: allRecipes.length}));
                }
            } catch (err) {
                alert('❌ Erreur lors de l\'export : ' + err.message);
                console.error(err);
            }
        }
        
        function importRecipesCSV(event) {
            var file = event.target.files[0];
            if (!file) return;
            
            var reader = new FileReader();
            reader.onload = function(e) {
                try {
                    var csv = e.target.result;
                    var lines = csv.split('\n');
                    
                    if (lines.length < 2) {
                        throw new Error('Le fichier CSV est vide');
                    }
                    
                    // Ignorer la première ligne (header)
                    var importedRecipes = [];
                    
                    for (var i = 1; i < lines.length; i++) {
                        var line = lines[i].trim();
                        if (!line) continue;
                        
                        // Parser le CSV en respectant les guillemets
                        var columns = parseCSVLine(line);
                        
                        if (columns.length < 7) continue;
                        
                        var recipe = {
                            id: 1000 + userRecipes.length + importedRecipes.length + Math.floor(Math.random() * 1000),
                            name: columns[0],
                            icon: columns[1] || '🍳',
                            time: columns[2],
                            difficulty: columns[3],
                            servings: parseInt(columns[4]) || 2,
                            ingredients: columns[5].split(';').map(function(s) { return s.trim(); }).filter(Boolean),
                            steps: columns[6].split(';').map(function(s) { return s.trim(); }).filter(Boolean)
                        };
                        
                        if (recipe.name && recipe.ingredients.length > 0 && recipe.steps.length > 0) {
                            importedRecipes.push(recipe);
                        }
                    }
                    
                    if (importedRecipes.length === 0) {
                        throw new Error('Aucune recette valide trouvée dans le fichier');
                    }
                    
                    // Demander d'abord si l'utilisateur veut vraiment importer
                    if (userRecipes.length > 0) {
                        var doImport = window.confirm(
                            '📥 Import CSV\n\n' +
                            'Le fichier contient ' + importedRecipes.length + ' recettes.\n' +
                            'Vous avez actuellement ' + userRecipes.length + ' recettes personnalisées.\n\n' +
                            'Voulez-vous continuer l\'import ?\n\n' +
                            '(Cliquez "Annuler" pour ne rien importer)'
                        );
                        
                        if (!doImport) {
                            alert('❌ Import annulé');
                            return; // STOP ici, ne rien faire
                        }
                        
                        // Si oui, demander comment importer
                        var replace = window.confirm(
                            '⚠️ Comment importer ?\n\n' +
                            'OK = REMPLACER vos ' + userRecipes.length + ' recettes actuelles\n' +
                            'Annuler = AJOUTER aux recettes existantes (sans doublons)'
                        );
                        
                        if (replace) {
                            // Remplacer
                            userRecipes = importedRecipes;
                        } else {
                            // Ajouter sans doublons
                            importedRecipes.forEach(function(newRecipe) {
                                var exists = userRecipes.some(function(existing) {
                                    return existing.name.toLowerCase() === newRecipe.name.toLowerCase();
                                });
                                if (!exists) {
                                    userRecipes.push(newRecipe);
                                }
                            });
                        }
                    } else {
                        // Pas de recettes actuelles, importer directement
                        userRecipes = importedRecipes;
                    }
                    
                    // Sauvegarder
                    saveUserRecipes();
                    openRecipes(); // Rafraîchir la liste
                    
                    alert(tm('messages.recipesImported', {count: importedRecipes.length}));
                } catch (err) {
                    alert('❌ Erreur lors de l\'import : ' + err.message);
                    console.error(err);
                }
            };
            reader.readAsText(file, 'UTF-8');
            
            // Reset l'input
            event.target.value = '';
        }
        
        function parseCSVLine(line) {
            var result = [];
            var current = '';
            var inQuotes = false;
            
            for (var i = 0; i < line.length; i++) {
                var char = line[i];
                var nextChar = line[i + 1];
                
                if (char === '"') {
                    if (inQuotes && nextChar === '"') {
                        // Double quote escaped
                        current += '"';
                        i++;
                    } else {
                        // Toggle quote mode
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    // Column separator
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            
            // Add last column
            result.push(current.trim());
            
            return result;
        }
        
        // === FONCTIONS EXCEL ===
        
        function exportExcel() {
            try {
                if (items.length === 0) {
                    alert(t('messages.noProductToExport'));
                    return;
                }
                
                var excelData = items.map(function(item) {
                    return {
                        'Nom': item.nom || '',
                        'Code-barres': item.barcode || '',
                        'Date d\'ajout': item.dateAjout ? new Date(item.dateAjout).toLocaleDateString('fr-FR') : '',
                        'Date d\'expiration': item.datePeremption ? new Date(item.datePeremption).toLocaleDateString('fr-FR') : '',
                        'Catégorie': item.categorie || '',
                        'Emplacement': item.emplacement || '',
                        'Quantité': item.quantite || 0,
                        'À renouveler': item.aRenouveler ? 'Oui' : 'Non',
                        'Nutri-Score': item.nutriScore || '',
                        'NOVA': item.novaGroup || '',
                        'Additifs': item.additives !== undefined && item.additives !== null ? item.additives : '',
                        'Eco-Score': item.ecoScore || ''
                    };
                });
                
                var wb = XLSX.utils.book_new();
                var ws = XLSX.utils.json_to_sheet(excelData);
                var wscols = [
                    {wch: 25}, {wch: 15}, {wch: 12}, {wch: 15},
                    {wch: 15}, {wch: 15}, {wch: 10}, {wch: 12},
                    {wch: 12}, {wch: 8},  {wch: 10}, {wch: 12}
                ];
                ws['!cols'] = wscols;
                XLSX.utils.book_append_sheet(wb, ws, 'Produits');
                
                var filename = 'frigo-manager-' + new Date().toISOString().split('T')[0] + '.xlsx';
                var wbout = XLSX.write(wb, {bookType:'xlsx', type:'array'});
                var blob = new Blob([wbout], {type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});

                if (Filesystem) {
                    var reader = new FileReader();
                    reader.onloadend = async function() {
                        try {
                            var base64Data = reader.result.split(',')[1];
                            
                            await Filesystem.writeFile({
                                path: filename,
                                data: base64Data,
                                directory: 'DOCUMENTS'
                            });

                            // Toast de confirmation
                            var toast = document.createElement('div');
                            toast.textContent = '✅ ' + items.length + ' produits exportés : ' + filename;
                            toast.style.cssText = 'position:fixed;bottom:40px;left:50%;transform:translateX(-50%);background:#4CAF50;color:white;padding:14px 22px;border-radius:12px;z-index:9999;font-size:14px;text-align:center;box-shadow:0 4px 12px rgba(0,0,0,0.3);';
                            document.body.appendChild(toast);
                            setTimeout(() => toast.remove(), 3000);

                            toggleSettings();

                        } catch (error) {
                            console.error('Erreur export:', error);
                            alert('❌ Erreur lors de l\'export : ' + error.message);
                        }
                    };
                    reader.readAsDataURL(blob);
                } else {
                    // Fallback navigateur
                    XLSX.writeFile(wb, filename);
                    alert(tm('messages.exportExcelSuccess', {count: items.length, filename: filename}));
                    toggleSettings();
                }

            } catch (err) {
                alert(currentLang === 'fr' ? '❌ Erreur lors de l\'export Excel : ' + err.message : '❌ Excel export error: ' + err.message);
                console.error(err);
            }
        }
        
        function importExcel(event) {
            var file = event.target.files[0];
            if (!file) return;
            
            var reader = new FileReader();
            reader.onload = function(e) {
                try {
                    // Lire le fichier Excel
                    var data = new Uint8Array(e.target.result);
                    var workbook = XLSX.read(data, {type: 'array'});
                    
                    // Prendre la première feuille
                    var firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    
                    // Convertir en JSON
                    var excelData = XLSX.utils.sheet_to_json(firstSheet);
                    
                    if (excelData.length === 0) {
                        throw new Error('Le fichier Excel est vide');
                    }
                    
                    // Convertir les données Excel en format interne
                    var importedItems = excelData.map(function(row) {
                        // Parser les dates
                        var dateAjout = null;
                        if (row['Date d\'ajout']) {
                            var parts = row['Date d\'ajout'].split('/');
                            if (parts.length === 3) {
                                dateAjout = parts[2] + '-' + parts[1].padStart(2, '0') + '-' + parts[0].padStart(2, '0');
                            }
                        }
                        
                        var datePeremption = null;
                        if (row['Date d\'expiration']) {
                            var parts2 = row['Date d\'expiration'].split('/');
                            if (parts2.length === 3) {
                                datePeremption = parts2[2] + '-' + parts2[1].padStart(2, '0') + '-' + parts2[0].padStart(2, '0');
                            }
                        }
                        
                        return {
                            id: Date.now() + Math.random(),
                            nom: row['Nom'] || 'Produit',
                            barcode: row['Code-barres'] || null,
                            dateAjout: dateAjout || new Date().toISOString().split('T')[0],
                            datePeremption: datePeremption,
                            categorie: row['Catégorie'] || 'autre',
                            emplacement: row['Emplacement'] || 'frigo',
                            quantite: parseInt(row['Quantité']) || 1,
                            aRenouveler: row['À renouveler'] === 'Oui',
                            nutriScore: row['Nutri-Score'] || null,
                            novaGroup: row['NOVA'] ? parseInt(row['NOVA']) : null,
                            additives: row['Additifs'] !== undefined && row['Additifs'] !== '' ? parseInt(row['Additifs']) : null,
                            ecoScore: row['Eco-Score'] || null,
                            image: null
                        };
                    });
                    
                    // Demander d'abord si l'utilisateur veut vraiment importer
                    if (items.length > 0) {
                        var doImport = window.confirm(
                            '📥 Import Excel\n\n' +
                            'Le fichier contient ' + importedItems.length + ' produits.\n' +
                            'Vous avez actuellement ' + items.length + ' produits.\n\n' +
                            'Voulez-vous continuer l\'import ?\n\n' +
                            '(Cliquez "Annuler" pour ne rien importer)'
                        );
                        
                        if (!doImport) {
                            alert('❌ Import annulé');
                            return; // STOP ici, ne rien faire
                        }
                        
                        // Si oui, demander comment importer
                        var replace = window.confirm(
                            '⚠️ Comment importer ?\n\n' +
                            'OK = REMPLACER vos ' + items.length + ' produits actuels\n' +
                            'Annuler = AJOUTER aux produits existants'
                        );
                        
                        if (replace) {
                            // Remplacer
                            items = importedItems;
                        } else {
                            // Ajouter
                            items = items.concat(importedItems);
                        }
                    } else {
                        // Pas de données actuelles, importer directement
                        items = importedItems;
                    }

                    // Sauvegarder
                    saveItems();
                    renderAll();
                    toggleSettings();

                    var message = tm('messages.importExcelSuccess', {count: importedItems.length});
                    alert(message);
                } catch (err) {
                    alert(currentLang === 'fr' ? '❌ Erreur lors de l\'import Excel : ' + err.message : '❌ Excel import error: ' + err.message);
                    console.error(err);
                }
            };
            reader.readAsArrayBuffer(file);
            
            // Reset l'input
            event.target.value = '';
        }
        
        // === LISTE DE COURSES ===
        
        var shoppingListState = {}; // Pour mémoriser les items cochés
        
        function openShoppingList() {
            // Filtrer les produits à acheter
            var toShop = items.filter(function(item) {
                var qty = getQuantity(item.quantite);
                //return qty === 0 || item.aRenouveler; mig
                return item.aRenouveler;
            });
            
            // Afficher le modal
            document.getElementById('shoppingListModal').classList.add('active');
            
            // Mettre à jour le compteur
            document.getElementById('shoppingCount').textContent = toShop.length;
            
            // Générer la liste
            var html = '';
            if (toShop.length === 0) {
                html = '<div style="text-align: center; padding: 40px; color: #666;">' +
                       '<div style="font-size: 3em; margin-bottom: 20px;">✅</div>' +
                       //'<h3>' + t('shopping.empty') + '</h3>' + mig
                       '<p>' + t('shopping.emptyDesc') + '</p>' +
                       '</div>';
            } else {
                toShop.forEach(function(item) {
                    var qty = getQuantity(item.quantite);
                    var reason = '';
                    
                    //if (qty === 0) {
                    //    reason = '📦 ' + t('shopping.exhausted');
                    //} else if (item.aRenouveler) {
                    //    reason = '📝 ' + t('shopping.toRenew');
                    //}
                    
                    if (item.aRenouveler) {
                        reason = '📝 ' + t('shopping.toRenew');
                    }
                    
                    var isChecked = shoppingListState[item.id] || false;
                    var checkedClass = isChecked ? ' checked' : '';
                    var checkIcon = isChecked ? '☑️' : '☐';
                    
                    html += '<div class="shopping-item' + checkedClass + '" onclick="toggleShoppingItem(' + item.id + ')">' +
                            '<span class="shopping-checkbox">' + checkIcon + '</span>' +
                            '<div class="shopping-item-content">' +
                            '<div class="shopping-item-name">' + item.nom + '</div>' +
                            '<div class="shopping-item-reason">' + reason + '</div>' +
                            '</div>' +
                            '</div>';
                });
            }
            
            document.getElementById('shoppingListItems').innerHTML = html;
        }
        
        function closeShoppingList() {
            document.getElementById('shoppingListModal').classList.remove('active');
        }
        
        function toggleShoppingItem(itemId) {
            var item = items.find(function(i) { return i.id === itemId; });
            
            if (item) {
                // Décocher "À renouveler"
                item.aRenouveler = false;
                
                // Sauvegarder dans localStorage
                localStorage.setItem('items', JSON.stringify(items));
                
                // Retirer du cache rappels ← AJOUT
                var dejaExportes = JSON.parse(localStorage.getItem('rappels_exportes') || '[]');
                var miseAJour = dejaExportes.filter(function(id) { return id !== itemId; });
                localStorage.setItem('rappels_exportes', JSON.stringify(miseAJour));
                
                // Supprimer de l'état de la shopping list
                delete shoppingListState[itemId];
                
                // Re-render la liste
                openShoppingList();
                
                renderItems(); // ← AJOUT : met à jour les fiches produits

            }
        }
        
        function exportShoppingListText() {
            var toShop = items.filter(function(item) {
                var qty = getQuantity(item.quantite);
                return qty === 0 || item.aRenouveler;
            });
            
            if (toShop.length === 0) {
                alert(t('messages.noShoppingItems'));
                return;
            }
            
            var text = currentLang === 'fr' ? '🛒 LISTE DE COURSES\n' : '🛒 SHOPPING LIST\n';
            text += '═══════════════════\n\n';
            
            toShop.forEach(function(item) {
                var qty = getQuantity(item.quantite);
                var reason = '';
                if (qty === 0) {
                    reason = currentLang === 'fr' ? ' (épuisé)' : ' (out of stock)';
                } else if (item.aRenouveler) {
                    reason = currentLang === 'fr' ? ' (à renouveler)' : ' (to renew)';
                }
                
                var checked = shoppingListState[item.id] ? '✓' : '☐';
                text += checked + ' ' + item.nom + reason + '\n';
            });
            
            text += '\n═══════════════════\n';
            text += 'Total: ' + toShop.length + ' ' + (currentLang === 'fr' ? 'produits' : 'products') + '\n';
            text += (currentLang === 'fr' ? 'Généré le ' : 'Generated on ') + new Date().toLocaleString(currentLang === 'fr' ? 'fr-FR' : 'en-US');
            
            // Copier dans le presse-papier
            if (navigator.clipboard) {
                navigator.clipboard.writeText(text).then(function() {
                    alert(t('messages.listCopied'));
                }).catch(function() {
                    // Fallback
                    showTextModal(text);
                });
            } else {
                showTextModal(text);
            }
        }
        
        async function exportToReminders() {
            const toRenewItems = items.filter(item => item.aRenouveler === true);
            
            if (toRenewItems.length === 0) {
                alert(currentLang === 'fr' ? '❌ Aucun produit à renouveler' : '❌ No products to renew');
                return;
            }

            // Récupérer les produits déjà exportés
            const dejaExportes = JSON.parse(localStorage.getItem('rappels_exportes') || '[]');

            // Filtrer uniquement les nouveaux
            const nouveaux = toRenewItems.filter(item => !dejaExportes.includes(item.id));

            if (nouveaux.length === 0) {
                alert(currentLang === 'fr'
                    ? '✅ Tous les produits sont déjà dans Rappels'
                    : '✅ All products already in Reminders');
                return;
            }

            const CalPlugin = window.Capacitor?.Plugins?.CapacitorCalendar;
            if (!CalPlugin) return;

            try {
                const permission = await CalPlugin.requestPermission({ scope: 'writeReminders' });
                if (permission.result !== 'granted') return;

                const { result: defaultList } = await CalPlugin.getDefaultRemindersList();

                for (const item of nouveaux) {
                    await CalPlugin.createReminder({
                        title: item.nom,
                        listId: defaultList?.id,
                        priority: 5,
                        isCompleted: false
                    });
                    // Marquer comme exporté
                    dejaExportes.push(item.id);
                }

                // Sauvegarder la liste mise à jour
                localStorage.setItem('rappels_exportes', JSON.stringify(dejaExportes));

                alert(currentLang === 'fr'
                    ? `✅ ${nouveaux.length} nouveau(x) produit(s) ajouté(s) dans Rappels !`
                    : `✅ ${nouveaux.length} new product(s) added to Reminders!`);

            } catch (err) {
                console.error('Erreur Rappels:', err);
                alert('❌ Erreur : ' + err.message);
            }
        }
        
        function retirerDeRenouveler(itemId) {
            // ... ta logique existante pour décocher aRenouveler ...

            // Retirer aussi du cache rappels
            const dejaExportes = JSON.parse(localStorage.getItem('rappels_exportes') || '[]');
            const mise_a_jour = dejaExportes.filter(id => id !== itemId);
            localStorage.setItem('rappels_exportes', JSON.stringify(mise_a_jour));
        }
        
        function printShoppingList() {
            var toShop = items.filter(function(item) {
                var qty = getQuantity(item.quantite);
                return qty === 0 || item.aRenouveler;
            });
            
            if (toShop.length === 0) {
                alert(t('messages.noShoppingItems'));
                return;
            }
            
            var printWindow = window.open('', '', 'width=800,height=600');
            var title = currentLang === 'fr' ? 'Liste de courses - Frigo Manager' : 'Shopping List - Fridge Manager';
            var heading = currentLang === 'fr' ? '🛒 LISTE DE COURSES' : '🛒 SHOPPING LIST';
            
            var html = '<!DOCTYPE html><html><head><meta charset="UTF-8">' +
                      '<title>' + title + '</title>' +
                      '<style>' +
                      'body { font-family: Arial, sans-serif; padding: 40px; max-width: 800px; margin: 0 auto; }' +
                      'h1 { color: #f97316; text-align: center; margin-bottom: 30px; }' +
                      '.item { padding: 15px; margin: 10px 0; border: 2px solid #ddd; border-radius: 8px; display: flex; align-items: center; }' +
                      '.checkbox { width: 30px; height: 30px; border: 2px solid #333; border-radius: 4px; margin-right: 15px; }' +
                      '.name { font-size: 1.2em; font-weight: bold; }' +
                      '.reason { color: #666; font-size: 0.9em; margin-left: 10px; }' +
                      '.footer { text-align: center; margin-top: 40px; color: #666; font-size: 0.9em; }' +
                      '@media print { body { padding: 20px; } }' +
                      '</style></head><body>' +
                      '<h1>' + heading + '</h1>';
            
            toShop.forEach(function(item) {
                var qty = getQuantity(item.quantite);
                var reason = '';
                if (qty === 0) {
                    reason = '<span class="reason">(' + (currentLang === 'fr' ? 'épuisé' : 'out of stock') + ')</span>';
                } else if (item.aRenouveler) {
                    reason = '<span class="reason">(' + (currentLang === 'fr' ? 'à renouveler' : 'to renew') + ')</span>';
                }
                
                html += '<div class="item">' +
                       '<div class="checkbox"></div>' +
                       '<div><span class="name">' + item.nom + '</span> ' + reason + '</div>' +
                       '</div>';
            });
            
            html += '<div class="footer">' +
                   'Total: ' + toShop.length + ' ' + (currentLang === 'fr' ? 'produits' : 'products') + '<br>' +
                   (currentLang === 'fr' ? 'Généré le ' : 'Generated on ') + new Date().toLocaleString(currentLang === 'fr' ? 'fr-FR' : 'en-US') + '<br>' +
                   (currentLang === 'fr' ? 'Frigo Manager' : 'Fridge Manager') +
                   '</div>' +
                   '</body></html>';
            
            printWindow.document.write(html);
            printWindow.document.close();
            
            // Attendre que le contenu soit chargé puis lancer l'impression
            setTimeout(function() {
                printWindow.print();
            }, 250);
        }
        
        // === SUGGESTIONS DE RECETTES ===
        
        var userRecipes = JSON.parse(localStorage.getItem('userRecipes') || '[]');
        var currentEditingRecipeId = null;
        
        function saveUserRecipes() {
            localStorage.setItem('userRecipes', JSON.stringify(userRecipes));
        }
        
        var recipesDatabase = [
            {
                id: 1,
                name: "Omelette nature",
                icon: "🍳",
                time: "10 min",
                difficulty: "Facile",
                servings: 2,
                ingredients: ["œufs", "oeufs", "beurre", "sel", "poivre"],
                steps: [
                    "Cassez 4 œufs dans un bol et battez-les avec une fourchette",
                    "Ajoutez une pincée de sel et de poivre",
                    "Faites chauffer une poêle avec une noix de beurre",
                    "Versez les œufs et laissez cuire 3-4 minutes",
                    "Pliez l'omelette en deux et servez chaud"
                ]
            },
            {
                id: 2,
                name: "Salade de tomates",
                icon: "🥗",
                time: "5 min",
                difficulty: "Très facile",
                servings: 2,
                ingredients: ["tomates", "tomate", "oignon", "huile d'olive", "huile", "vinaigre", "basilic"],
                steps: [
                    "Lavez et coupez les tomates en rondelles",
                    "Émincez finement l'oignon",
                    "Disposez les tomates dans un plat",
                    "Ajoutez l'oignon émincé",
                    "Assaisonnez avec huile d'olive, vinaigre, sel et poivre",
                    "Décorez avec du basilic frais"
                ]
            },
            {
                id: 3,
                name: "Pâtes au beurre",
                icon: "🍝",
                time: "15 min",
                difficulty: "Très facile",
                servings: 2,
                ingredients: ["pâtes", "pates", "spaghetti", "beurre", "parmesan", "fromage"],
                steps: [
                    "Faites cuire les pâtes dans une grande casserole d'eau salée",
                    "Égouttez les pâtes en gardant un peu d'eau de cuisson",
                    "Ajoutez une grosse noix de beurre",
                    "Mélangez bien pour faire fondre le beurre",
                    "Ajoutez le parmesan râpé",
                    "Servez immédiatement"
                ]
            },
            {
                id: 4,
                name: "Croque-monsieur",
                icon: "🥪",
                time: "10 min",
                difficulty: "Facile",
                servings: 2,
                ingredients: ["pain de mie", "pain", "jambon", "fromage", "gruyère", "beurre"],
                steps: [
                    "Beurrez les tranches de pain de mie",
                    "Disposez une tranche de jambon sur une tranche de pain",
                    "Ajoutez le fromage râpé",
                    "Recouvrez avec une autre tranche de pain",
                    "Faites griller au four ou à la poêle jusqu'à ce que le fromage soit fondu"
                ]
            },
            {
                id: 5,
                name: "Smoothie aux fruits",
                icon: "🥤",
                time: "5 min",
                difficulty: "Très facile",
                servings: 2,
                ingredients: ["banane", "fraises", "fraise", "lait", "yaourt", "miel"],
                steps: [
                    "Épluchez la banane et coupez-la en morceaux",
                    "Lavez les fraises",
                    "Mettez tous les fruits dans un blender",
                    "Ajoutez le lait et le yaourt",
                    "Ajoutez une cuillère de miel",
                    "Mixez jusqu'à obtenir une texture lisse",
                    "Servez frais"
                ]
            },
            {
                id: 6,
                name: "Riz sauté aux légumes",
                icon: "🍚",
                time: "20 min",
                difficulty: "Facile",
                servings: 3,
                ingredients: ["riz", "carotte", "carottes", "poivron", "oignon", "œufs", "oeufs", "sauce soja"],
                steps: [
                    "Faites cuire le riz et laissez-le refroidir",
                    "Coupez les légumes en petits dés",
                    "Faites sauter les légumes dans un wok avec de l'huile",
                    "Ajoutez le riz froid et mélangez",
                    "Faites un trou au centre et ajoutez les œufs battus",
                    "Mélangez le tout et ajoutez la sauce soja",
                    "Servez chaud"
                ]
            },
            {
                id: 7,
                name: "Poulet rôti aux herbes",
                icon: "🍗",
                time: "60 min",
                difficulty: "Moyen",
                servings: 4,
                ingredients: ["poulet", "thym", "romarin", "ail", "citron", "huile d'olive", "huile"],
                steps: [
                    "Préchauffez le four à 200°C",
                    "Rincez et séchez le poulet",
                    "Frottez-le avec de l'huile d'olive, du sel et du poivre",
                    "Ajoutez le thym, le romarin et l'ail émincé",
                    "Mettez des tranches de citron à l'intérieur",
                    "Enfournez pour 1 heure en arrosant régulièrement",
                    "Laissez reposer 10 minutes avant de découper"
                ]
            },
            {
                id: 8,
                name: "Soupe de légumes",
                icon: "🍲",
                time: "30 min",
                difficulty: "Facile",
                servings: 4,
                ingredients: ["carotte", "carottes", "pomme de terre", "pommes de terre", "poireau", "poireaux", "oignon", "bouillon"],
                steps: [
                    "Épluchez et coupez tous les légumes en morceaux",
                    "Faites revenir l'oignon dans une casserole",
                    "Ajoutez les autres légumes et mélangez",
                    "Couvrez d'eau ou de bouillon",
                    "Laissez mijoter 25 minutes",
                    "Mixez si vous souhaitez une soupe lisse",
                    "Ajustez l'assaisonnement et servez chaud"
                ]
            },
            {
                id: 9,
                name: "Sandwich jambon fromage",
                icon: "🥖",
                time: "5 min",
                difficulty: "Très facile",
                servings: 1,
                ingredients: ["pain", "baguette", "jambon", "fromage", "beurre", "salade"],
                steps: [
                    "Coupez le pain en deux dans la longueur",
                    "Beurrez légèrement les deux faces",
                    "Ajoutez des feuilles de salade",
                    "Disposez les tranches de jambon",
                    "Ajoutez le fromage",
                    "Refermez et dégustez"
                ]
            },
            {
                id: 10,
                name: "Yaourt aux fruits",
                icon: "🥄",
                time: "2 min",
                difficulty: "Très facile",
                servings: 1,
                ingredients: ["yaourt", "fraises", "fraise", "banane", "miel", "céréales", "muesli"],
                steps: [
                    "Versez le yaourt dans un bol",
                    "Coupez les fruits en morceaux",
                    "Ajoutez les fruits sur le yaourt",
                    "Versez un filet de miel",
                    "Ajoutez des céréales ou du muesli",
                    "Dégustez immédiatement"
                ]
            }
        ];
        
        function getAllRecipes() {
            var userRecipes = JSON.parse(localStorage.getItem('userRecipes') || '[]');  // ✅ Chargé depuis localStorage
            return recipesDatabase.concat(userRecipes);
        }
        
        function openRecipes() {
            var availableProducts = items.filter(function(item) {
                var qty = getQuantity(item.quantite);
                if (qty === 0) return false;
                if (item.datePeremption) {
                    var daysLeft = Math.ceil((new Date(item.datePeremption) - new Date()) / (1000 * 60 * 60 * 24));
                    if (daysLeft < 0) return false;
                }
                return true;
            });
            
            var availableIngredients = availableProducts.map(function(p) {
                return p.nom.toLowerCase();
            });
            
            var allRecipes = getAllRecipes();
            
            var recipesWithMatch = allRecipes.map(function(recipe) {
                var matchCount = 0;
                var totalIngredients = recipe.ingredients.length;
                
                recipe.ingredients.forEach(function(ingredient) {
                    var found = availableIngredients.some(function(available) {
                        return available.includes(ingredient) || ingredient.includes(available);
                    });
                    if (found) matchCount++;
                });
                
                var matchPercent = Math.round((matchCount / totalIngredients) * 100);
                
                return {
                    recipe: recipe,
                    matchCount: matchCount,
                    matchPercent: matchPercent,
                    totalIngredients: totalIngredients
                };
            });
            
            recipesWithMatch.sort(function(a, b) {
                var aIsUser = a.recipe.id >= 1000 ? 1 : 0;
                var bIsUser = b.recipe.id >= 1000 ? 1 : 0;
                if (bIsUser !== aIsUser) return bIsUser - aIsUser;
                return b.matchPercent - a.matchPercent;
            });
            
            document.getElementById('recipesModal').classList.add('active');
            
            var html = '';

            recipesWithMatch.forEach(function(item) {
                var isUserRecipe = item.recipe.id >= 1000;
                
                if (item.matchPercent > 0 || isUserRecipe) {
                    var matchColor = item.matchPercent >= 80 ? '#10b981' :
                                    item.matchPercent >= 50 ? '#f59e0b' : '#6b7280';
                    
                    var userBadge = isUserRecipe ? '<span class="user-recipe-badge">' + t('recipes.userRecipe') + '</span>' : '';
                    
                    html += '<div class="recipe-card" onclick="showRecipeDetail(' + item.recipe.id + ')">' +
                           '<div class="recipe-card-header">' +
                           '<div class="recipe-icon">' + item.recipe.icon + '</div>' +
                           '<div class="recipe-card-title">' +
                           '<div class="recipe-name">' + item.recipe.name + userBadge + '</div>' +
                           '<div class="recipe-time">⏱️ ' + item.recipe.time + ' • ' + item.recipe.difficulty + '</div>' +
                           '</div>' +
                           '</div>' +
                           '<div class="recipe-ingredients-preview">' +
                           (currentLang === 'fr' ? 'Pour ' : 'For ') + item.recipe.servings + ' ' + (currentLang === 'fr' ? 'personne' + (item.recipe.servings > 1 ? 's' : '') : item.recipe.servings > 1 ? 'servings' : 'serving') +
                           '</div>' +
                           '<span class="recipe-match" style="background: ' + matchColor + ';">' +
                           '✓ ' + item.matchCount + '/' + item.totalIngredients + ' ' + (currentLang === 'fr' ? 'ingrédients disponibles' : 'ingredients available') + ' (' + item.matchPercent + '%)' +
                           '</span>' +
                           '</div>';
                }
            });

            if (html === '') {
                html = '<div style="text-align: center; padding: 40px; color: #666;">' +
                       '<div style="font-size: 3em; margin-bottom: 20px;">🍳</div>' +
                       '<h3>' + (currentLang === 'fr' ? 'Aucune recette disponible' : 'No recipes available') + '</h3>' +
                       '<p>' + (currentLang === 'fr' ? 'Ajoutez des produits pour voir des suggestions de recettes !' : 'Add products to see recipe suggestions!') + '</p>' +
                       '</div>';
            }
            
            document.getElementById('recipesListItems').innerHTML = html;
        }
        
        function closeRecipes() {
            document.getElementById('recipesModal').classList.remove('active');
        }
        
        function showRecipeDetail(recipeId) {
            var allRecipes = getAllRecipes();
            var recipe = allRecipes.find(function(r) { return r.id === recipeId; });
            if (!recipe) return;
            
            var isUserRecipe = recipeId >= 1000;
            
            // Récupérer les produits disponibles
            var availableProducts = items.filter(function(item) {
                var qty = getQuantity(item.quantite);
                if (qty === 0) return false;
                if (item.datePeremption) {
                    var daysLeft = Math.ceil((new Date(item.datePeremption) - new Date()) / (1000 * 60 * 60 * 24));
                    if (daysLeft < 0) return false;
                }
                return true;
            });
            
            var availableIngredients = availableProducts.map(function(p) {
                return p.nom.toLowerCase();
            });
            
            var html = '<div class="recipe-detail-icon">' + recipe.icon + '</div>' +
                      '<h1 class="recipe-detail-title">' + recipe.name + '</h1>' +
                      '<div class="recipe-detail-meta">' +
                      '<div class="recipe-meta-item">' +
                      '<div class="recipe-meta-label">' + t('recipes.time') + '</div>' +
                      '<div class="recipe-meta-value">' + recipe.time + '</div>' +
                      '</div>' +
                      '<div class="recipe-meta-item">' +
                      '<div class="recipe-meta-label">' + t('recipes.difficulty') + '</div>' +
                      '<div class="recipe-meta-value">' + recipe.difficulty + '</div>' +
                      '</div>' +
                      '<div class="recipe-meta-item">' +
                      '<div class="recipe-meta-label">' + (currentLang === 'fr' ? 'Portions' : 'Servings') + '</div>' +
                      '<div class="recipe-meta-value">' + recipe.servings + '</div>' +
                      '</div>' +
                      '</div>' +
                      '<div class="recipe-section">' +
                      '<h3 class="recipe-section-title">🛒 ' + t('recipes.ingredients') + '</h3>' +
                      '<ul class="recipe-ingredients-list">';
            
            recipe.ingredients.forEach(function(ingredient) {
                var available = availableIngredients.some(function(avail) {
                    return avail.includes(ingredient) || ingredient.includes(avail);
                });
                var className = available ? 'recipe-ingredient-available' : '';
                var icon = available ? '✓ ' : '○ ';
                html += '<li class="recipe-ingredient-item ' + className + '">' + icon + ingredient.charAt(0).toUpperCase() + ingredient.slice(1) + '</li>';
            });
            
            html += '</ul></div>' +
                   '<div class="recipe-section">' +
                   '<h3 class="recipe-section-title">👨‍🍳 ' + (currentLang === 'fr' ? 'Préparation' : 'Preparation') + '</h3>' +
                   '<ol class="recipe-steps-list">';
            
            recipe.steps.forEach(function(step) {
                html += '<li class="recipe-step-item">' + step + '</li>';
            });
            
            html += '</ol></div>';
            
            // Afficher les boutons pour TOUTES les recettes
            // Les recettes par défaut seront copiées en recettes utilisateur lors de la modification
            html += '<div class="recipe-actions-bar">' +
                   '<button class="btn" onclick="editRecipe(' + recipeId + ')" style="background: #f59e0b; flex: 1;">' + t('recipes.edit') + '</button>';
            
            // Bouton supprimer seulement pour les recettes utilisateur (pas les recettes par défaut)
            if (isUserRecipe) {
                html += '<button class="btn" onclick="deleteRecipe(' + recipeId + ')" style="background: #ef4444; flex: 1;">' + t('recipes.deleteBtn') + '</button>';
            }
            
            html += '</div>';
            
            document.getElementById('recipeDetailBody').innerHTML = html;
            document.getElementById('recipeDetailModal').classList.add('active');
        }
        
        function closeRecipeDetail() {
            document.getElementById('recipeDetailModal').classList.remove('active');
        }
        
        // === CRÉATION/MODIFICATION DE RECETTES ===
        
        function openCreateRecipe() {
            currentEditingRecipeId = null;
            document.getElementById('createRecipeTitle').textContent = currentLang === 'fr' ? '➕ Créer une recette' : '➕ Create a recipe';
            document.getElementById('recipeNameInput').value = '';
            document.getElementById('recipeIconInput').value = '🍳';
            document.getElementById('selectedEmoji').textContent = '🍳';
            document.getElementById('recipeTimeInput').value = '';
            document.getElementById('recipeDifficultyInput').value = currentLang === 'fr' ? 'Facile' : 'Easy';
            document.getElementById('recipeServingsInput').value = '2';
            document.getElementById('ingredientsList').innerHTML = '';
            document.getElementById('stepsList').innerHTML = '';

            // Clavier numérique pour temps et portions
            document.getElementById('recipeTimeInput').inputMode = 'numeric';
            document.getElementById('recipeTimeInput').type = 'number';
            document.getElementById('recipeTimeInput').min = '1';
            document.getElementById('recipeServingsInput').inputMode = 'numeric';
            document.getElementById('recipeServingsInput').type = 'number';
            document.getElementById('recipeServingsInput').min = '1';

            addIngredientField();
            addIngredientField();
            addIngredientField();
            addStepField();
            addStepField();
            addStepField();
            
            var emojiButtons = document.querySelectorAll('.emoji-btn');
            emojiButtons.forEach(function(btn) {
                btn.classList.remove('selected');
            });
            emojiButtons[0].classList.add('selected');
            
            document.getElementById('createRecipeModal').classList.add('active');
        }
        
        function closeCreateRecipe() {
            document.getElementById('createRecipeModal').classList.remove('active');
        }
        
        function selectEmoji(emoji) {
            document.getElementById('recipeIconInput').value = emoji;
            document.getElementById('selectedEmoji').textContent = emoji;
            
            // Mettre à jour la sélection visuelle
            var emojiButtons = document.querySelectorAll('.emoji-btn');
            emojiButtons.forEach(function(btn) {
                if (btn.textContent === emoji) {
                    btn.classList.add('selected');
                } else {
                    btn.classList.remove('selected');
                }
            });
        }
        
        function addIngredientField(value) {
            var ingredientsList = document.getElementById('ingredientsList');
            var fieldId = 'ingredient_' + Date.now();
            
            var html = '<div class="ingredient-field" id="' + fieldId + '">' +
                      '<input type="text" placeholder="Ex: tomates" value="' + (value || '') + '">' +
                      '<button type="button" class="btn-remove-field" onclick="removeField(\'' + fieldId + '\')">✕</button>' +
                      '</div>';
            
            ingredientsList.insertAdjacentHTML('beforeend', html);
        }
        
        function addStepField(value) {
            var stepsList = document.getElementById('stepsList');
            var fieldId = 'step_' + Date.now();
            
            var html = '<div class="step-field" id="' + fieldId + '">' +
                      '<textarea placeholder="Décrivez l\'étape...">' + (value || '') + '</textarea>' +
                      '<button type="button" class="btn-remove-field" onclick="removeField(\'' + fieldId + '\')">✕</button>' +
                      '</div>';
            
            stepsList.insertAdjacentHTML('beforeend', html);
        }
        
        function removeField(fieldId) {
            var field = document.getElementById(fieldId);
            if (field) field.remove();
        }
        
        function saveRecipe() {
            var name = document.getElementById('recipeNameInput').value.trim();
            var icon = document.getElementById('recipeIconInput').value;
            var time = document.getElementById('recipeTimeInput').value.trim();
            time = time ? time + ' min' : '';
            var difficulty = document.getElementById('recipeDifficultyInput').value;
            var servings = parseInt(document.getElementById('recipeServingsInput').value);
            
            if (!name) {
                alert(currentLang === 'fr' ? '❌ Veuillez entrer un nom de recette' : '❌ Please enter a recipe name');
                return;
            }
            
            if (!time) {
                alert(currentLang === 'fr' ? '❌ Veuillez entrer un temps de préparation' : '❌ Please enter preparation time');
                return;
            }
            
            var ingredientInputs = document.querySelectorAll('#ingredientsList input');
            var ingredients = [];
            ingredientInputs.forEach(function(input) {
                var value = input.value.trim().toLowerCase();
                if (value) ingredients.push(value);
            });
            
            if (ingredients.length === 0) {
                alert(currentLang === 'fr' ? '❌ Veuillez ajouter au moins un ingrédient' : '❌ Please add at least one ingredient');
                return;
            }
            
            var stepTextareas = document.querySelectorAll('#stepsList textarea');
            var steps = [];
            stepTextareas.forEach(function(textarea) {
                var value = textarea.value.trim();
                if (value) steps.push(value);
            });
            
            if (steps.length === 0) {
                alert(currentLang === 'fr' ? '❌ Veuillez ajouter au moins une étape' : '❌ Please add at least one step');
                return;
            }
            
            if (currentEditingRecipeId) {
                var index = userRecipes.findIndex(function(r) { return r.id === currentEditingRecipeId; });
                if (index !== -1) {
                    userRecipes[index] = {
                        id: currentEditingRecipeId,
                        name: name,
                        icon: icon,
                        time: time,
                        difficulty: difficulty,
                        servings: servings,
                        ingredients: ingredients,
                        steps: steps
                    };
                }
            } else {
                var newRecipe = {
                    id: 1000 + userRecipes.length + Math.floor(Math.random() * 1000),
                    name: name,
                    icon: icon,
                    time: time,
                    difficulty: difficulty,
                    servings: servings,
                    ingredients: ingredients,
                    steps: steps
                };
                userRecipes.push(newRecipe);
            }
            
            // Sauvegarder
            saveUserRecipes();

            var wasEditing = currentEditingRecipeId !== null;
            currentEditingRecipeId = null;

            closeCreateRecipe();

            setTimeout(function() {
                openRecipes();
                var action = wasEditing ? (currentLang === 'fr' ? 'modifiée' : 'updated') : (currentLang === 'fr' ? 'créée' : 'created');
                var message = currentLang === 'fr' ? '✅ Recette ' + action + ' avec succès !' : '✅ Recipe ' + action + ' successfully!';
                alert(message);
            }, 200);
        }
        
        function editRecipe(recipeId) {
            var allRecipes = getAllRecipes();
            var recipe = allRecipes.find(function(r) { return r.id === recipeId; });
            if (!recipe) return;
            
            var isUserRecipe = recipeId >= 1000;
            
            // Si c'est une recette par défaut, on va la dupliquer en recette utilisateur
            if (!isUserRecipe) {
                // Informer l'utilisateur
                var message = currentLang === 'fr' 
                    ? '💡 Cette recette par défaut sera copiée.\n\nVos modifications créeront une nouvelle recette personnalisée.\n\nContinuer ?' 
                    : '💡 This default recipe will be copied.\n\nYour changes will create a new custom recipe.\n\nContinue?';
                
                if (!confirm(message)) {
                    return;
                }
                
                // Créer un nouvel ID pour la copie
                currentEditingRecipeId = null; // Cela créera une nouvelle recette
            } else {
                currentEditingRecipeId = recipeId;
            }
            
            // Fermer le détail
            closeRecipeDetail();
            
            // Remplir le formulaire
            var title = currentLang === 'fr' ? '✏️ Modifier la recette' : '✏️ Edit recipe';
            if (!isUserRecipe) {
                title = currentLang === 'fr' ? '📋 Copie de la recette' : '📋 Copy recipe';
            }
            document.getElementById('createRecipeTitle').textContent = title;
            
            document.getElementById('recipeNameInput').value = recipe.name;
            document.getElementById('recipeIconInput').value = recipe.icon;
            document.getElementById('selectedEmoji').textContent = recipe.icon;
            document.getElementById('recipeTimeInput').value = recipe.time;
            document.getElementById('recipeDifficultyInput').value = recipe.difficulty;
            document.getElementById('recipeServingsInput').value = recipe.servings;
            
            // Remplir les ingrédients
            document.getElementById('ingredientsList').innerHTML = '';
            recipe.ingredients.forEach(function(ing) {
                addIngredientField(ing);
            });
            
            // Remplir les étapes
            document.getElementById('stepsList').innerHTML = '';
            recipe.steps.forEach(function(step) {
                addStepField(step);
            });
            
            // Sélectionner l'emoji
            var emojiButtons = document.querySelectorAll('.emoji-btn');
            emojiButtons.forEach(function(btn) {
                if (btn.textContent === recipe.icon) {
                    btn.classList.add('selected');
                } else {
                    btn.classList.remove('selected');
                }
            });
            
            document.getElementById('createRecipeModal').classList.add('active');
        }
        
        function deleteRecipe(recipeId) {
            var recipe = userRecipes.find(function(r) { return r.id === recipeId; });
            if (!recipe) return;
            
            var message = currentLang === 'fr' 
                ? '⚠️ Supprimer la recette "' + recipe.name + '" ?\n\nCette action est irréversible.'
                : '⚠️ Delete recipe "' + recipe.name + '"?\n\nThis action is irreversible.';
            
            var confirm = window.confirm(message);
            
            if (confirm) {
                userRecipes = userRecipes.filter(function(r) { return r.id !== recipeId; });
                saveUserRecipes();
                closeRecipeDetail();
                openRecipes(); // Rafraîchir la liste
                alert(currentLang === 'fr' ? '✅ Recette supprimée avec succès' : '✅ Recipe deleted successfully');
            }
        }
        
        function confirmDeleteAll() {
            var message1 = currentLang === 'fr' 
                ? '⚠️ SUPPRIMER TOUTES LES DONNÉES ?\n\n' +
                  'Cette action supprimera définitivement tous vos ' + items.length + ' produits.\n\n' +
                  'Cette action est IRRÉVERSIBLE.\n\n' +
                  'Êtes-vous sûr ?'
                : '⚠️ DELETE ALL DATA?\n\n' +
                  'This will permanently delete all your ' + items.length + ' products.\n\n' +
                  'This action is IRREVERSIBLE.\n\n' +
                  'Are you sure?';
            
            var confirm1 = window.confirm(message1);
            
            if (!confirm1) return;
            
            var message2 = currentLang === 'fr'
                ? '⚠️ DERNIÈRE CONFIRMATION\n\n' +
                  'Voulez-vous vraiment supprimer TOUTES les données ?\n\n' +
                  'Pensez à exporter vos données avant si vous voulez les sauvegarder.'
                : '⚠️ FINAL CONFIRMATION\n\n' +
                  'Do you really want to delete ALL data?\n\n' +
                  'Consider exporting your data first if you want to save them.';
            
            var confirm2 = window.confirm(message2);
            
            if (confirm2) {
                items = [];
                saveItems();
                renderAll();
                toggleSettings();
                alert(t('messages.allDeleted'));
            }
        }

        function closeForm() {
            document.getElementById('form').classList.remove('active');
            document.getElementById('form').innerHTML = '';
            document.getElementById('actions').style.display = 'grid';
            document.getElementById('stats').style.display = 'grid';
            currentBarcode = null;
            currentProductData = null;
            
            // Rafraîchir l'affichage pour montrer les changements (photo, scores, etc.)
            renderAll();
        }
        
        function editItem(itemId) {
            var item = items.find(function(it) { return it.id === itemId; });
            if (!item) return;
            
            var form = document.getElementById('form');
            
            var html = '<h3>✏️ Modifier le produit</h3>';
            
            if (item.barcode) {
                html += '<div class="barcode-badge clickable" id="barcodeBadge" style="display: inline-block;">📊 ' + item.barcode + '</div>';
                // Toujours afficher le message pour indiquer que le code-barres est cliquable
                html += '<div class="date-suggestion" style="margin-top: 5px;">💡 Cliquez sur le code-barres pour récupérer photo + scores santé</div>';
            }
            
            html += '<div class="form-group">';
            if (item.image) {
                html += '<img src="' + item.image + '" class="preview-img" id="previewImage">';
                html += '<button type="button" class="btn" id="btnRemovePhoto" style="background:#ef4444;padding:10px;font-size:14px;margin:5px 0;">✕ Supprimer la photo</button>';
            } else {
                html += '<div id="previewImage" class="preview-placeholder">📷 Aucune photo</div>';
            }
            html += '<input type="file" id="customPhoto" accept="image/*" capture="environment" style="display: none;">';
            html += '<label for="customPhoto" class="btn" style="background:#f59e0b;padding:12px;font-size:16px;margin:10px 0;">📸 ' + (item.image ? 'Changer' : 'Prendre') + ' la photo</label>';
            html += '<div class="date-suggestion" style="margin-top: 5px;">💡 La photo augmente la taille de stockage</div>';
            html += '</div>';
            
            html += '<div class="form-group">' +
                    '<label for="formNom">Nom du produit *</label>' +
                    '<input type="text" id="formNom" placeholder="Ex: Lait, Yaourt, Pommes..." value="' + (item.nom || '') + '">' +
                    '</div>' +
                    '<div class="form-group">' +
                    '<label for="formDate">Date de péremption</label>' +
                    '<input type="date" id="formDate" value="' + (item.datePeremption || '') + '">' +
                    '<div class="date-suggestion">💡 Modifiable</div>' +
                    '</div>' +
                    '<div class="form-group">' +
                    '<label for="formCategorie">Catégorie</label>' +
                    '<select id="formCategorie">' +
                    '<option value="fruit"' + (item.categorie === 'fruit' ? ' selected' : '') + '>🍎 Fruit</option>' +
                    '<option value="legume"' + (item.categorie === 'legume' ? ' selected' : '') + '>🥕 Légume</option>' +
                    '<option value="viande"' + (item.categorie === 'viande' ? ' selected' : '') + '>🥩 Viande</option>' +
                    '<option value="poisson"' + (item.categorie === 'poisson' ? ' selected' : '') + '>🐟 Poisson</option>' +
                    '<option value="produit_laitier"' + (item.categorie === 'produit_laitier' ? ' selected' : '') + '>🥛 Produit laitier</option>' +
                    '<option value="viennoiseries"' + (item.categorie === 'viennoiseries' ? ' selected' : '') + '>🥐 Viennoiseries</option>' +
                    '<option value="conserves"' + (item.categorie === 'conserves' ? ' selected' : '') + '>🥫 Conserves</option>' +
                    '<option value="boisson"' + (item.categorie === 'boisson' ? ' selected' : '') + '>🥤 Boisson</option>' +
                    '<option value="autre"' + (item.categorie === 'autre' || !item.categorie ? ' selected' : '') + '>📦 Autre</option>' +
                    '</select>' +
                    '</div>' +
                    '<div class="form-group">' +
                    '<label for="formEmplacement">Emplacement</label>' +
                    '<select id="formEmplacement">' +
                    '<option value="frigo"' + (item.emplacement === 'frigo' || !item.emplacement ? ' selected' : '') + '>🧊 Frigo</option>' +
                    '<option value="congelateur"' + (item.emplacement === 'congelateur' ? ' selected' : '') + '>❄️ Congélateur</option>' +
                    '<option value="placard"' + (item.emplacement === 'placard' ? ' selected' : '') + '>🚪 Placard</option>' +
                    '<option value="cave"' + (item.emplacement === 'cave' ? ' selected' : '') + '>🍷 Cave</option>' +
                    '<option value="corbeille"' + (item.emplacement === 'corbeille' ? ' selected' : '') + '>🧺 Corbeille</option>' +
                    '<option value="autre_emplacement"' + (item.emplacement === 'autre_emplacement' ? ' selected' : '') + '>📍 Autre</option>' +
                    '</select>' +
                    '</div>' +
                    '<div class="form-group">' +
                    '<label for="formQuantite">Quantité</label>' +
                    '<div style="display: flex; align-items: center; gap: 10px;">' +
                    '<button type="button" class="btn-quantity" id="btnMinus">−</button>' +
                    '<input type="number" id="formQuantite" value="' + getQuantity(item.quantite) + '" min="0" max="99" style="width: 80px; text-align: center; font-size: 18px; font-weight: bold;">' +
                    '<button type="button" class="btn-quantity" id="btnPlus">+</button>' +
                    '</div>' +
                    '<div class="date-suggestion">💡 Nombre d\'unités</div>' +
                    '</div>' +
                    '<div class="form-group" style="margin-top: 15px;">' +
                    '<label id="labelRenouvelerEdit" style="cursor: pointer; margin: 0; font-weight: 600; display: flex; align-items: center; gap: 15px; padding: 15px; background: #f5f5f5; border-radius: 10px; user-select: none; -webkit-tap-highlight-color: transparent;">' +
                    '<input type="checkbox" id="formRenouveler" ' + (item.aRenouveler ? 'checked' : '') + ' style="display: none;">' +
                    '<span id="checkboxBoxEdit" style="font-size: 32px; line-height: 1; color: ' + (item.aRenouveler ? '#667eea' : '#999') + ';">' + (item.aRenouveler ? '☑️' : '☐') + '</span>' +
                    '<span style="flex: 1;">📝 À renouveler (ajouter à la liste de courses)</span>' +
                    '</label>' +
                    '</div>' +
                    '<button class="btn" id="btnUpdate" style="background:#667eea;font-size:18px;padding:15px;margin-top:10px">✓ Enregistrer</button>' +
                    '<button class="btn" id="btnCancel" style="background:#ccc;color:#333;font-size:18px;padding:15px">✕ Annuler</button>';
            
            form.innerHTML = html;
            form.classList.add('active');
            document.getElementById('actions').style.display = 'none';
            document.getElementById('stats').style.display = 'none';
            
            // Gestion de la photo personnalisée
            var customImageData = item.image || null;
            
            // Bouton pour supprimer la photo (si elle existe)
            var btnRemovePhoto = document.getElementById('btnRemovePhoto');
            if (btnRemovePhoto) {
                btnRemovePhoto.onclick = function() {
                    if (confirm('Supprimer la photo ?\nCela économisera de l\'espace de stockage.')) {
                        customImageData = null;
                        var preview = document.getElementById('previewImage');
                        preview.outerHTML = '<div id="previewImage" class="preview-placeholder">📷 Aucune photo</div>';
                        document.querySelector('label[for="customPhoto"]').innerHTML = '📸 Prendre la photo';
                        btnRemovePhoto.style.display = 'none';
                    }
                };
            }
            
            // Gestion de la quantité avec boutons +/-
            var quantityInput = document.getElementById('formQuantite');
            document.getElementById('btnPlus').onclick = function() {
                var val = parseInt(quantityInput.value);
                if (isNaN(val)) val = 0;
                if (val < 99) quantityInput.value = val + 1;
            };
            document.getElementById('btnMinus').onclick = function() {
                var val = parseInt(quantityInput.value);
                if (isNaN(val)) val = 1;
                if (val > 0) quantityInput.value = val - 1;
            };
            
            // Event listener pour iOS - Checkbox "À renouveler"
            var labelRenouveler = document.getElementById('labelRenouvelerEdit');
            if (labelRenouveler) {
                labelRenouveler.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    toggleRenouvelerEdit();
                });
                labelRenouveler.addEventListener('touchend', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    toggleRenouvelerEdit();
                });
            }
            
            // Event listener pour cliquer sur le code-barres et récupérer la photo + scores
            var barcodeBadge = document.getElementById('barcodeBadge');
            if (barcodeBadge && item.barcode) {
                var fetchInProgress = false; // Empêcher les clics multiples
                
                barcodeBadge.onclick = function() {
                    // Empêcher les clics multiples
                    if (fetchInProgress) {
                        alert('⏳ Récupération en cours...\n\nVeuillez patienter.');
                        return;
                    }
                    
                    if (confirm('Récupérer les données depuis la base de données ?\n\n• Photo du produit\n• Scores de santé (Nutri-Score, NOVA, Additifs, Eco-Score)\n\n⏳ Patientez pendant le chargement...')) {
                        fetchInProgress = true; // Bloquer les autres clics
                        
                        // Afficher un loader visible
                        var badge = document.getElementById('barcodeBadge');
                        var originalText = badge.innerHTML;
                        var originalBg = badge.style.background;
                        badge.innerHTML = '⏳ Chargement en cours...';
                        badge.style.background = '#fbbf24';
                        badge.style.animation = 'pulse 1.5s infinite';
                        
                        // Afficher l'écran de loading
                        document.getElementById('loading').classList.add('active');
                        document.getElementById('loadingBarcode').textContent = 'Récupération des données...';
                        
                        // Appeler l'API Open Food Facts
                        fetch('https://world.openfoodfacts.org/api/v2/product/' + item.barcode + '.json')
                            .then(function(response) { return response.json(); })
                            .then(function(data) {
                                document.getElementById('loading').classList.remove('active');
                                
                                if (data.status === 1 && data.product) {
                                    var product = data.product;
                                    var updates = [];
                                    
                                    // Récupérer la photo
                                    if (product.image_url) {
                                        customImageData = product.image_url;
                                        
                                        // Mettre à jour l'aperçu
                                        var preview = document.getElementById('previewImage');
                                        var existingBtn = document.getElementById('btnRemovePhoto');
                                        
                                        // Si preview est une image, juste changer le src
                                        if (preview.tagName === 'IMG') {
                                            preview.src = customImageData;
                                        } else {
                                            // Sinon (c'était un placeholder), remplacer par une image
                                            preview.outerHTML = '<img src="' + customImageData + '" class="preview-img" id="previewImage">';
                                        }
                                        
                                        // Créer ou afficher le bouton supprimer
                                        if (!existingBtn) {
                                            // Créer le bouton s'il n'existe pas
                                            var btn = document.createElement('button');
                                            btn.type = 'button';
                                            btn.className = 'btn';
                                            btn.id = 'btnRemovePhoto';
                                            btn.style.cssText = 'background:#ef4444;padding:10px;font-size:14px;margin:5px 0;';
                                            btn.textContent = '✕ Supprimer la photo';
                                            document.getElementById('previewImage').parentNode.insertBefore(btn, document.getElementById('customPhoto'));
                                            existingBtn = btn;
                                        } else {
                                            existingBtn.style.display = 'block';
                                        }
                                        
                                        // Attacher l'event listener
                                        existingBtn.onclick = function() {
                                            if (confirm('Supprimer la photo ?\nCela économisera de l\'espace de stockage.')) {
                                                customImageData = null;
                                                var preview = document.getElementById('previewImage');
                                                preview.outerHTML = '<div id="previewImage" class="preview-placeholder">📷 Aucune photo</div>';
                                                document.querySelector('label[for="customPhoto"]').innerHTML = '📸 Prendre la photo';
                                                this.style.display = 'none';
                                            }
                                        };
                                        
                                        // Changer le texte du bouton photo
                                        document.querySelector('label[for="customPhoto"]').innerHTML = '📸 Changer la photo';
                                        
                                        updates.push('Photo');
                                    }
                                    
                                    // Récupérer Nutri-Score
                                    if (product.nutriscore_grade) {
                                        var nutriValue = product.nutriscore_grade.toUpperCase();
                                        // Ignorer les valeurs non valides
                                        if (nutriValue !== 'NOT-APPLICABLE' && nutriValue !== 'UNKNOWN' && nutriValue !== 'NOT-KNOWN') {
                                            item.nutriScore = nutriValue;
                                            updates.push('Nutri-Score ' + item.nutriScore);
                                        }
                                    }
                                    
                                    // Récupérer NOVA
                                    if (product.nova_group) {
                                        item.novaGroup = product.nova_group;
                                        updates.push('NOVA ' + item.novaGroup);
                                    }
                                    
                                    // Récupérer Additifs
                                    if (product.additives_n !== undefined) {
                                        item.additives = product.additives_n;
                                        updates.push((item.additives === 0 ? 'Sans additif' : item.additives + ' additifs'));
                                    }
                                    
                                    // Récupérer Eco-Score
                                    var ecoScore = null;
                                    if (product.ecoscore_grade) {
                                        var ecoValue = product.ecoscore_grade.toUpperCase();
                                        // Nettoyer les valeurs bizarres comme "A-PLUS" → "A"
                                        ecoValue = ecoValue.replace('-PLUS', '').replace('-MINUS', '').trim();
                                        // Ignorer les valeurs non valides
                                        if (ecoValue !== 'NOT-APPLICABLE' && ecoValue !== 'UNKNOWN' && ecoValue !== 'NOT-KNOWN' && ecoValue.match(/^[A-F]$/)) {
                                            ecoScore = ecoValue;
                                        }
                                    } else if (product.ecoscore_score !== undefined && product.ecoscore_score !== null) {
                                        if (product.ecoscore_score >= 80) ecoScore = 'A';
                                        else if (product.ecoscore_score >= 60) ecoScore = 'B';
                                        else if (product.ecoscore_score >= 40) ecoScore = 'C';
                                        else if (product.ecoscore_score >= 20) ecoScore = 'D';
                                        else if (product.ecoscore_score >= 0) ecoScore = 'E';
                                    }
                                    if (ecoScore) {
                                        item.ecoScore = ecoScore;
                                        updates.push('Eco-Score ' + ecoScore);
                                    }
                                    
                                    // Restaurer le badge
                                    badge.innerHTML = originalText;
                                    badge.style.background = originalBg;
                                    badge.style.animation = '';
                                    
                                    if (updates.length > 0) {
                                        // IMPORTANT : Sauvegarder automatiquement les modifications
                                        saveItems();
                                        alert('✅ Données récupérées et sauvegardées !\n\n' + updates.join('\n'));
                                        // NE PAS rafraîchir ici - attendre que l'utilisateur ferme le formulaire
                                        // renderAll(); ← SUPPRIMÉ pour éviter les conflits
                                    } else {
                                        alert('⚠️ Aucune donnée supplémentaire disponible.');
                                    }
                                    fetchInProgress = false; // Débloquer
                                } else {
                                    badge.innerHTML = originalText;
                                    badge.style.background = originalBg;
                                    badge.style.animation = '';
                                    alert('❌ Produit non trouvé dans la base de données.');
                                    fetchInProgress = false; // Débloquer
                                }
                            })
                            .catch(function(error) {
                                document.getElementById('loading').classList.remove('active');
                                badge.innerHTML = originalText;
                                badge.style.background = originalBg;
                                badge.style.animation = '';
                                fetchInProgress = false; // Débloquer
                                alert('❌ Erreur lors de la récupération des données.\n\nVérifiez votre connexion Internet.');
                                console.error(error);
                            });
                    }
                };
            }
            
            document.getElementById('customPhoto').addEventListener('change', function(e) {
                var file = e.target.files[0];
                if (!file) return;
                
                var reader = new FileReader();
                reader.onload = function(event) {
                    customImageData = event.target.result;
                    var preview = document.getElementById('previewImage');
                    if (preview.tagName === 'IMG') {
                        preview.src = customImageData;
                    } else {
                        preview.outerHTML = '<img src="' + customImageData + '" class="preview-img" id="previewImage">' +
                            '<button type="button" class="btn" id="btnRemovePhoto" style="background:#ef4444;padding:10px;font-size:14px;margin:5px 0;">✕ Supprimer la photo</button>';
                        
                        // Ajouter l'event listener au nouveau bouton
                        var newBtnRemove = document.getElementById('btnRemovePhoto');
                        if (newBtnRemove) {
                            newBtnRemove.onclick = function() {
                                if (confirm('Supprimer la photo ?\nCela économisera de l\'espace de stockage.')) {
                                    customImageData = null;
                                    var preview = document.getElementById('previewImage');
                                    preview.outerHTML = '<div id="previewImage" class="preview-placeholder">📷 Aucune photo</div>';
                                    document.querySelector('label[for="customPhoto"]').innerHTML = '📸 Prendre la photo';
                                    newBtnRemove.style.display = 'none';
                                }
                            };
                        }
                    }
                    document.querySelector('label[for="customPhoto"]').innerHTML = '📸 Changer la photo';
                };
                reader.readAsDataURL(file);
            });
            
            // Event listeners pour recalculer automatiquement la date lors du changement de catégorie ou d'emplacement
            var formCategorie = document.getElementById('formCategorie');
            var formEmplacement = document.getElementById('formEmplacement');
            var formDate = document.getElementById('formDate');
            
            function recalculerDate() {
                var categorie = formCategorie.value;
                var emplacement = formEmplacement.value;
                var nouvelleDate = calculerNouvelleDate(categorie, emplacement);
                if (nouvelleDate) {
                    formDate.value = nouvelleDate;
                }
            }
            
            if (formCategorie) {
                formCategorie.addEventListener('change', recalculerDate);
            }
            if (formEmplacement) {
                formEmplacement.addEventListener('change', recalculerDate);
            }
            
            document.getElementById('btnUpdate').onclick = function() {
                var nom = document.getElementById('formNom').value.trim();
                if (!nom) {
                    alert('Veuillez entrer un nom de produit');
                    return;
                }
                
                // Mettre à jour l'item existant
                var index = items.findIndex(function(it) { return it.id === itemId; });
                if (index !== -1) {
                    items[index].nom = nom;
                    items[index].datePeremption = document.getElementById('formDate').value || null;
                    items[index].categorie = document.getElementById('formCategorie').value;
                    items[index].emplacement = document.getElementById('formEmplacement').value;
                    items[index].quantite = parseInt(document.getElementById('formQuantite').value) || 0;
                    items[index].aRenouveler = document.getElementById('formRenouveler').checked;
                    items[index].image = customImageData;
                    // Préserver les données de santé (ne pas les écraser)
                    // items[index].nutriScore, novaGroup, additives, ecoScore, barcode restent inchangés
                }
                
                saveItems();
                closeForm();
                renderAll();
            };
            
            document.getElementById('btnCancel').onclick = closeForm;
            
            setTimeout(function() {
                document.getElementById('formNom').focus();
            }, 100);
        }

        // Filtres
        var filterBtns = document.querySelectorAll('.filter-btn');
        for (var i = 0; i < filterBtns.length; i++) {
            filterBtns[i].onclick = function() {
                currentFilter = this.getAttribute('data-f');
                for (var j = 0; j < filterBtns.length; j++) {
                    filterBtns[j].classList.remove('active');
                }
                this.classList.add('active');
                renderItems();
            };
        }
        
        // Filtres d'emplacement
        var filterEmplBtns = document.querySelectorAll('.filter-empl-btn');
        for (var i = 0; i < filterEmplBtns.length; i++) {
            filterEmplBtns[i].onclick = function() {
                currentEmplacement = this.getAttribute('data-empl');
                for (var j = 0; j < filterEmplBtns.length; j++) {
                    filterEmplBtns[j].classList.remove('active');
                }
                this.classList.add('active');
                renderStats();  // Mettre à jour les compteurs
                checkUrgentProducts();  // Mettre à jour la bannière d'alerte
                renderItems();
            };
        }

        // === FONCTIONS DE RECHERCHE ===
        
        function saveSearchHistory() {
            try {
                localStorage.setItem('search-history', JSON.stringify(searchHistory));
            } catch(e) {}
        }
        
        function addToSearchHistory(term) {
            if (!term || term.length < 2) return;
            
            // Supprimer si existe déjà
            searchHistory = searchHistory.filter(function(h) { return h !== term; });
            
            // Ajouter au début
            searchHistory.unshift(term);
            
            // Limiter à maxSearchHistory
            if (searchHistory.length > maxSearchHistory) {
                searchHistory = searchHistory.slice(0, maxSearchHistory);
            }
            
            saveSearchHistory();
        }
        
        function renderSearchHistory() {
            var historyEl = document.getElementById('searchHistory');
            
            if (searchHistory.length === 0) {
                historyEl.style.display = 'none';
                return;
            }
            
            var title = currentLang === 'fr' ? '🕒 Recherches récentes' : '🕒 Recent searches';
            
            var html = '<div class="search-history-title">' + title + '</div>' +
                      '<div class="search-history-items">';
            
            searchHistory.forEach(function(term) {
                html += '<div class="search-history-item" onclick="selectSearchHistory(\'' + term.replace(/'/g, "\\'") + '\')">' +
                       '<span class="search-history-item-text">' + term + '</span>' +
                       '<span class="search-history-item-remove" onclick="event.stopPropagation(); removeFromHistory(\'' + term.replace(/'/g, "\\'") + '\')">✕</span>' +
                       '</div>';
            });
            
            html += '</div>';
            historyEl.innerHTML = html;
            historyEl.style.display = 'block';
        }
        
        function selectSearchHistory(term) {
            document.getElementById('searchInput').value = term;
            currentSearchTerm = term;
            renderItems();
            document.getElementById('searchHistory').style.display = 'none';
            document.getElementById('clearSearch').style.display = 'block';
        }
        
        function removeFromHistory(term) {
            searchHistory = searchHistory.filter(function(h) { return h !== term; });
            saveSearchHistory();
            renderSearchHistory();
        }
        
        
        
        // Rendre les fonctions globales
        window.selectSearchHistory = selectSearchHistory;
        window.removeFromHistory = removeFromHistory;
        
        // Champ de recherche
        var searchInput = document.getElementById('searchInput');
        var searchBtn = document.getElementById('searchButton');
        var clearBtn = document.getElementById('clearSearch');
        var historyEl = document.getElementById('searchHistory');
        
        /* 
        DÉSACTIVÉ - On utilise onclick HTML à la place
        
        // Test que les éléments existent
        if (!searchInput) alert('❌ searchInput introuvable');
        if (!searchBtn) alert('❌ searchBtn introuvable');
        if (!clearBtn) alert('❌ clearBtn introuvable');
        
        // Fonction de recherche réutilisable
        function handleSearch() {
            alert('✅ handleSearch() appelée !');
            
            var value = searchInput.value.trim();
            currentSearchTerm = value;
            
            alert('🔍 Valeur recherchée: "' + value + '"');
            
            // Afficher/cacher le bouton clear
            clearBtn.style.display = value ? 'flex' : 'none';
            
            alert('📋 Appel de renderItems()...');
            renderItems();
            alert('✅ renderItems() terminé !');
            
            // Ajouter à l'historique si recherche non vide
            if (value) {
                addToSearchHistory(value);
            }
        }
        
        // BOUTON GO - Recherche manuelle (parfait pour iOS)
        searchBtn.onclick = function() {
            alert('🎯 Bouton GO cliqué !');
            handleSearch();
            searchInput.blur(); // Fermer le clavier sur mobile
        };
        */
        
        // AUCUN event listener - Seulement onclick HTML
        // (Recherche déclenchée UNIQUEMENT par le bouton GO)
        
        // Raccourci clavier Ctrl+F / Cmd+F pour focus
        document.addEventListener('keydown', function(e) {
            if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
                e.preventDefault();
                searchInput.focus();
                searchInput.select();
            }
        });

        // Boutons
        var btnScan = document.getElementById('btnScan');
        var btnManual = document.getElementById('btnManual');
        var btnCloseScanner = document.getElementById('btnCloseScanner');
        var btnManualFromScanner = document.getElementById('btnManualFromScanner');
        
        if (btnScan) btnScan.onclick = startScanner;
        if (btnManual) btnManual.onclick = function() { showForm(); };
        if (btnCloseScanner) btnCloseScanner.onclick = stopScanner;
        if (btnManualFromScanner) btnManualFromScanner.onclick = function() {
            stopScanner();
            showForm();
        };
        
        // Boutons de notification
        document.getElementById('btnEnableNotifications').onclick = function() {
            requestNotificationPermission().then(function(permission) {
                localStorage.setItem('notification-asked', 'true');
                document.getElementById('notificationPrompt').classList.remove('show');
                if (permission === 'granted') {
                    alert('✅ Notifications activées ! Vous recevrez des alertes pour vos produits.');
                    // Vérifier immédiatement et notifier
                    checkUrgentProducts();
                } else if (permission === 'denied') {
                    alert('ℹ️ Pour activer les notifications plus tard :\n\n1. Ouvrez Réglages iPhone\n2. Safari → Notifications\n3. Autorisez pour ce site');
                }
            });
        };
        
        document.getElementById('btnCancelNotifications').onclick = function() {
            localStorage.setItem('notification-asked', 'true');
            document.getElementById('notificationPrompt').classList.remove('show');
        };

        // Initialisation
        renderAll();
        setLanguage(currentLang); // Initialize language
        
        // Afficher la version
        document.getElementById('versionDisplay').textContent = 'Version ' + APP_VERSION;
    </script>
</body>
</html>
